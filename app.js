var hJ=Object.create;var{getPrototypeOf:EJ,defineProperty:dW,getOwnPropertyNames:bJ}=Object;var kJ=Object.prototype.hasOwnProperty;var uJ=(Z,U,z)=>{z=Z!=null?hJ(EJ(Z)):{};let V=U||!Z||!Z.__esModule?dW(z,"default",{value:Z,enumerable:!0}):z;for(let D of bJ(Z))if(!kJ.call(V,D))dW(V,D,{get:()=>Z[D],enumerable:!0});return V};var yJ=(Z,U)=>()=>(U||Z((U={exports:{}}).exports,U),U.exports);var CZ=yJ((Zq,p$)=>{(function(Z,U){if(typeof Zq=="object"&&typeof p$=="object")p$.exports=U();else if(typeof define=="function"&&define.amd)define([],U);else if(typeof Zq=="object")Zq.Ably=U();else Z.Ably=U()})(Zq,()=>{var Z={},U={exports:Z},z=Object.defineProperty,V=Object.defineProperties,D=Object.getOwnPropertyDescriptor,w=Object.getOwnPropertyDescriptors,L=Object.getOwnPropertyNames,A=Object.getOwnPropertySymbols,k=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,h=(q,$,W)=>($ in q)?z(q,$,{enumerable:!0,configurable:!0,writable:!0,value:W}):q[$]=W,P=(q,$)=>{for(var W in $||($={}))if(k.call($,W))h(q,W,$[W]);if(A){for(var W of A($))if(u.call($,W))h(q,W,$[W])}return q},E=(q,$)=>V(q,w($)),m=(q,$)=>{var W={};for(var X in q)if(k.call(q,X)&&$.indexOf(X)<0)W[X]=q[X];if(q!=null&&A){for(var X of A(q))if($.indexOf(X)<0&&u.call(q,X))W[X]=q[X]}return W},i=(q,$)=>{for(var W in $)z(q,W,{get:$[W],enumerable:!0})},f=(q,$,W,X)=>{if($&&typeof $==="object"||typeof $==="function"){for(let G of L($))if(!k.call(q,G)&&G!==W)z(q,G,{get:()=>$[G],enumerable:!(X=D($,G))||X.enumerable})}return q},T=(q)=>f(z({},"__esModule",{value:!0}),q),y={};i(y,{ErrorInfo:()=>K,Realtime:()=>K$,Rest:()=>N$,default:()=>TJ,makeProtocolMessageFromDeserialized:()=>wW,msgpack:()=>R$}),U.exports=T(y);var j=class{},r=typeof global<"u"?global:typeof window<"u"?window:self;function _(q,$){return`${q}`.padStart($?3:2,"0")}function q0(q){return j.Config.logTimestamps?function($){let W=new Date;q(_(W.getHours())+":"+_(W.getMinutes())+":"+_(W.getSeconds())+"."+_(W.getMilliseconds(),1)+" "+$)}:function($){q($)}}var X0=()=>{var q;let $,W;if(typeof((q=r==null?void 0:r.console)==null?void 0:q.log)==="function")$=function(...X){console.log.apply(console,X)},W=console.warn?function(...X){console.warn.apply(console,X)}:$;else $=W=function(){};return[$,W].map(q0)},$0=class q{constructor(){this.deprecated=($,W)=>{this.deprecationWarning(`${$} is deprecated and will be removed in a future version. ${W}`)},this.shouldLog=($)=>{return $<=this.logLevel},this.setLog=($,W)=>{if($!==void 0)this.logLevel=$;if(W!==void 0)this.logHandler=this.logErrorHandler=W},this.logLevel=q.defaultLogLevel,this.logHandler=q.defaultLogHandler,this.logErrorHandler=q.defaultLogErrorHandler}static initLogHandlers(){let[$,W]=X0();this.defaultLogHandler=$,this.defaultLogErrorHandler=W,this.defaultLogger=new q}static logActionNoStrip($,W,X,G){$.logAction(W,X,G)}logAction($,W,X){if(this.shouldLog($))($===1?this.logErrorHandler:this.logHandler)("Ably: "+W+": "+X,$)}renamedClientOption($,W){this.deprecationWarning(`The \`${$}\` client option has been renamed to \`${W}\`. Please update your code to use \`${W}\` instead. \`${$}\` will be removed in a future version.`)}renamedMethod($,W,X){this.deprecationWarning(`\`${$}\`’s \`${W}\` method has been renamed to \`${X}\`. Please update your code to use \`${X}\` instead. \`${W}\` will be removed in a future version.`)}deprecationWarning($){if(this.shouldLog(1))this.logErrorHandler(`Ably: Deprecation warning - ${$}`,1)}};$0.defaultLogLevel=1,$0.LOG_NONE=0,$0.LOG_ERROR=1,$0.LOG_MAJOR=2,$0.LOG_MINOR=3,$0.LOG_MICRO=4,$0.logAction=(q,$,W,X)=>{$0.logActionNoStrip(q,$,W,X)};var J0=$0,H=J0,G0={};i(G0,{Format:()=>H8,allSame:()=>J8,allToLowerCase:()=>lq,allToUpperCase:()=>N8,arrChooseN:()=>D8,arrDeleteValue:()=>Z8,arrEquals:()=>F8,arrIntersect:()=>$8,arrIntersectOb:()=>W8,arrPopRandomElement:()=>nq,arrWithoutValue:()=>rZ,cheapRandStr:()=>Vq,containsValue:()=>tZ,copy:()=>v0,createMissingPluginError:()=>Dq,dataSizeBytes:()=>V8,decodeBody:()=>j0,encodeBody:()=>i0,ensureArray:()=>Q1,forInOwnNonNullProperties:()=>G8,getBackoffCoefficient:()=>O8,getGlobalObject:()=>rq,getJitterCoefficient:()=>Q8,getRetryTime:()=>tq,inherits:()=>lZ,inspectBody:()=>U8,inspectError:()=>H0,intersect:()=>q8,isEmpty:()=>fq,isErrorInfoOrPartialErrorInfo:()=>_q,isNil:()=>h0,isObject:()=>l0,keysArray:()=>E1,matchDerivedChannel:()=>B8,mixin:()=>p,parseQueryString:()=>Uq,prototypicalClone:()=>e$,randomString:()=>z8,shallowClone:()=>oq,shallowEquals:()=>w8,throwMissingPluginError:()=>L0,toBase64:()=>zq,toQueryString:()=>b1,valuesArray:()=>X8,whenPromiseSettles:()=>S0,withTimeoutAsync:()=>K8});function K0(q){let $="["+q.constructor.name;if(q.message)$+=": "+q.message;if(q.statusCode)$+="; statusCode="+q.statusCode;if(q.code)$+="; code="+q.code;if(q.cause)$+="; cause="+H0(q.cause);if(q.href&&!(q.message&&q.message.indexOf("help.ably.io")>-1))$+="; see "+q.href+" ";return $+="]",$}var K=class q extends Error{constructor($,W,X,G){super($);if(typeof Object.setPrototypeOf<"u")Object.setPrototypeOf(this,q.prototype);this.code=W,this.statusCode=X,this.cause=G}toString(){return K0(this)}static fromValues($){let{message:W,code:X,statusCode:G}=$;if(typeof W!=="string"||typeof X!=="number"||typeof G!=="number")throw Error("ErrorInfo.fromValues(): invalid values: "+j.Config.inspect($));let J=Object.assign(new q(W,X,G),$);if(J.code&&!J.href)J.href="https://help.ably.io/error/"+J.code;return J}},s=class q extends Error{constructor($,W,X,G){super($);if(typeof Object.setPrototypeOf<"u")Object.setPrototypeOf(this,q.prototype);this.code=W,this.statusCode=X,this.cause=G}toString(){return K0(this)}static fromValues($){let{message:W,code:X,statusCode:G}=$;if(typeof W!=="string"||!h0(X)&&typeof X!=="number"||!h0(G)&&typeof G!=="number")throw Error("PartialErrorInfo.fromValues(): invalid values: "+j.Config.inspect($));let J=Object.assign(new q(W,X,G),$);if(J.code&&!J.href)J.href="https://help.ably.io/error/"+J.code;return J}};function P0(q){return Math.floor(Math.random()*q.length)}function p(q,...$){for(let W=0;W<$.length;W++){let X=$[W];if(!X)break;for(let G in X)if(Object.prototype.hasOwnProperty.call(X,G))q[G]=X[G]}return q}function v0(q){return p({},q)}function Q1(q){if(h0(q))return[];if(Array.isArray(q))return q;return[q]}function l0(q){return Object.prototype.toString.call(q)=="[object Object]"}function fq(q){for(let $ in q)return!1;return!0}function h0(q){return q==null}function oq(q){let $={};for(let W in q)$[W]=q[W];return $}function e$(q,$){class W{}W.prototype=q;let X=new W;if($)p(X,$);return X}var lZ=function(q,$){if(j.Config.inherits){j.Config.inherits(q,$);return}q.super_=$,q.prototype=e$($.prototype,{constructor:q})};function tZ(q,$){for(let W in q)if(q[W]==$)return!0;return!1}function q8(q,$){return Array.isArray($)?$8(q,$):W8(q,$)}function $8(q,$){let W=[];for(let X=0;X<q.length;X++){let G=q[X];if($.indexOf(G)!=-1)W.push(G)}return W}function W8(q,$){let W=[];for(let X=0;X<q.length;X++){let G=q[X];if(G in $)W.push(G)}return W}function Z8(q,$){let W=q.indexOf($),X=W!=-1;if(X)q.splice(W,1);return X}function rZ(q,$){let W=q.slice();return Z8(W,$),W}function E1(q,$){let W=[];for(let X in q){if($&&!Object.prototype.hasOwnProperty.call(q,X))continue;W.push(X)}return W}function X8(q,$){let W=[];for(let X in q){if($&&!Object.prototype.hasOwnProperty.call(q,X))continue;W.push(q[X])}return W}function G8(q,$){for(let W in q)if(Object.prototype.hasOwnProperty.call(q,W)&&q[W])$(W)}function J8(q,$){if(q.length===0)return!0;let W=q[0][$];return q.every(function(X){return X[$]===W})}var H8=((q)=>{return q.msgpack="msgpack",q.json="json",q})(H8||{});function nq(q){return q.splice(P0(q),1)[0]}function b1(q){let $=[];if(q)for(let W in q)$.push(encodeURIComponent(W)+"="+encodeURIComponent(q[W]));return $.length?"?"+$.join("&"):""}function Uq(q){let $,W=/([^?&=]+)=?([^&]*)/g,X={};while($=W.exec(q))X[decodeURIComponent($[1])]=decodeURIComponent($[2]);return X}function _q(q){return typeof q=="object"&&q!==null&&(q instanceof K||q instanceof s)}function H0(q){var $,W;if(q instanceof Error||(($=q==null?void 0:q.constructor)==null?void 0:$.name)==="ErrorInfo"||((W=q==null?void 0:q.constructor)==null?void 0:W.name)==="PartialErrorInfo")return q.toString();return j.Config.inspect(q)}function U8(q){if(j.BufferUtils.isBuffer(q))return q.toString();else if(typeof q==="string")return q;else return j.Config.inspect(q)}function V8(q){if(j.BufferUtils.isBuffer(q))return j.BufferUtils.byteLength(q);if(typeof q==="string")return j.Config.stringByteSize(q);if(typeof q==="number")return 8;if(typeof q==="boolean")return 1;throw Error(`Expected input of Utils.dataSizeBytes to be a string, a number, a boolean or a buffer, but was: ${typeof q}`)}function Vq(){return String(Math.random()).substr(2)}var z8=async(q)=>{let $=await j.Config.getRandomArrayBuffer(q);return j.BufferUtils.base64Encode($)};function D8(q,$){let W=Math.min($,q.length),X=q.slice(),G=[];for(let J=0;J<W;J++)G.push(nq(X));return G}function S0(q,$){q.then((W)=>{$==null||$(null,W)}).catch((W)=>{$==null||$(W)})}function j0(q,$,W){if(W=="msgpack"){if(!$)L0("MsgPack");return $.decode(q)}return JSON.parse(String(q))}function i0(q,$,W){if(W=="msgpack"){if(!$)L0("MsgPack");return $.encode(q,!0)}return JSON.stringify(q)}function lq(q){return q.map(function($){return $&&$.toLowerCase()})}function N8(q){return q.map(function($){return $&&$.toUpperCase()})}function O8(q){return Math.min((q+2)/3,2)}function Q8(){return 1-Math.random()*0.2}function tq(q,$){return q*O8($)*Q8()}function rq(){if(typeof global<"u")return global;if(typeof window<"u")return window;return self}function w8(q,$){return Object.keys(q).every((W)=>q[W]===$[W])&&Object.keys($).every((W)=>$[W]===q[W])}function B8(q){let $=/^(\[([^?]*)(?:(.*))\])?(.+)$/,W=q.match($);if(!W||!W.length||W.length<5)throw new K("regex match failed",400,40010);if(W[2])throw new K(`cannot use a derived option with a ${W[2]} channel`,400,40010);return{qualifierParam:W[3]||"",channelName:W[4]}}function zq(q){let $=j.BufferUtils,W=$.utf8Encode(q);return $.base64Encode(W)}function F8(q,$){return q.length===$.length&&q.every(function(W,X){return W===$[X]})}function Dq(q){return new K(`${q} plugin not provided`,40019,400)}function L0(q){throw Dq(q)}async function K8(q,$=5000,W="Timeout expired"){let X=new K(W,50000,500);return Promise.race([q,new Promise((G,J)=>setTimeout(()=>J(X),$))])}var j8="2.15.0",sZ="ably-js/"+j8,m0={ENDPOINT:"main",ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["main.a.fallback.ably-realtime.com","main.b.fallback.ably-realtime.com","main.c.fallback.ably-realtime.com","main.d.fallback.ably-realtime.com","main.e.fallback.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15000,suspendedRetryTimeout:30000,httpRequestTimeout:1e4,httpMaxRetryDuration:15000,channelRetryTimeout:15000,fallbackRetryTimeout:600000,connectionStateTtl:120000,realtimeRequestTimeout:1e4,recvTimeout:90000,webSocketConnectTimeout:1e4,webSocketSlowTimeout:4000},httpMaxRetryCount:3,maxMessageSize:65536,version:j8,protocolVersion:4,agent:sZ,getPort:aZ,getHttpScheme:eZ,getPrimaryDomainFromEndpoint:I8,getEndpointFallbackHosts:Y8,getFallbackHosts:S8,getHosts:qX,checkHost:A8,objectifyOptions:WX,normaliseOptions:XX,defaultGetHeaders:GX,defaultPostHeaders:JX};function aZ(q,$){return $||q.tls?q.tlsPort:q.port}function eZ(q){return q.tls?"https://":"http://"}function L8(q){return q.includes(".")||q.includes("::")||q==="localhost"}function I8(q){if(L8(q))return q;if(q.startsWith("nonprod:"))return`${q.replace("nonprod:","")}.realtime.ably-nonprod.net`;return`${q}.realtime.ably.net`}function Y8(q){if(L8(q))return[];if(q.startsWith("nonprod:")){let $=q.replace("nonprod:","");return M8($,"ably-realtime-nonprod.com")}return M8(q,"ably-realtime.com")}function M8(q,$){return["a","b","c","d","e"].map((W)=>`${q}.${W}.fallback.${$}`)}function S8(q){let $=q.fallbackHosts,W=typeof q.httpMaxRetryCount<"u"?q.httpMaxRetryCount:m0.httpMaxRetryCount;return $?D8($,W):[]}function qX(q){return[q.primaryDomain].concat(S8(q))}function A8(q){if(typeof q!=="string")throw new K("host must be a string; was a "+typeof q,40000,400);if(!q.length)throw new K("host must not be zero-length",40000,400)}function $X(q){let $={};for(let W in m0.TIMEOUTS)$[W]=q[W]||m0.TIMEOUTS[W];return $}function sq(q){let $=m0.agent;if(q.agents)for(var W in q.agents)$+=" "+W+"/"+q.agents[W];return $}function WX(q,$,W,X,G){if(q===void 0){let N=$?`${W} must be initialized with either a client options object, an Ably API key, or an Ably Token`:`${W} must be initialized with a client options object`;throw H.logAction(X,H.LOG_ERROR,`${W}()`,N),Error(N)}let J;if(typeof q==="string")if(q.indexOf(":")==-1){if(!$){let N=`${W} cannot be initialized with just an Ably Token; you must provide a client options object with a \`plugins\` property. (Set this Ably Token as the object’s \`token\` property.)`;throw H.logAction(X,H.LOG_ERROR,`${W}()`,N),Error(N)}J={token:q}}else{if(!$){let N=`${W} cannot be initialized with just an Ably API key; you must provide a client options object with a \`plugins\` property. (Set this Ably API key as the object’s \`key\` property.)`;throw H.logAction(X,H.LOG_ERROR,`${W}()`,N),Error(N)}J={key:q}}else J=q;if(G)J=E(P({},J),{plugins:P(P({},G),J.plugins)});return J}function ZX(q){if(q.endpoint&&(q.environment||q.restHost||q.realtimeHost))throw new K("The `endpoint` option cannot be used in conjunction with the `environment`, `restHost`, or `realtimeHost` options.",40106,400);if(q.environment&&(q.restHost||q.realtimeHost))throw new K("The `environment` option cannot be used in conjunction with the `restHost`, or `realtimeHost` options.",40106,400)}function XX(q,$,W){let X=W!=null?W:H.defaultLogger;if(q.environment)X.deprecated("The `environment` client option","Use the `endpoint` client option instead.");if(q.restHost)X.deprecated("The `restHost` client option","Use the `endpoint` client option instead.");if(q.realtimeHost)X.deprecated("The `realtimeHost` client option","Use the `endpoint` client option instead.");if(ZX(q),typeof q.recover==="function"&&q.closeOnUnload===!0)H.logAction(X,H.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),q.recover=void 0;if(!("closeOnUnload"in q))q.closeOnUnload=!q.recover;if(!("queueMessages"in q))q.queueMessages=!0;let G=q.endpoint||m0.ENDPOINT;if(!q.fallbackHosts&&!q.restHost&&!q.realtimeHost&&!q.port&&!q.tlsPort)q.fallbackHosts=Y8(q.environment||G);let J=q.environment&&`${q.environment}.realtime.ably.net`,Q=q.restHost||q.realtimeHost||J||I8(G);if((q.fallbackHosts||[]).concat(Q).forEach(A8),q.port=q.port||m0.PORT,q.tlsPort=q.tlsPort||m0.TLS_PORT,!("tls"in q))q.tls=!0;let F=$X(q);if($)if("useBinaryProtocol"in q)q.useBinaryProtocol=j.Config.supportsBinary&&q.useBinaryProtocol;else q.useBinaryProtocol=j.Config.preferBinary;else q.useBinaryProtocol=!1;let B={};if(q.clientId)B["X-Ably-ClientId"]=j.BufferUtils.base64Encode(j.BufferUtils.utf8Encode(q.clientId));if(!("idempotentRestPublishing"in q))q.idempotentRestPublishing=!0;let Y=null,M=q.connectivityCheckUrl;if(q.connectivityCheckUrl){let[R,d]=q.connectivityCheckUrl.split("?");if(Y=d?Uq(d):{},R.indexOf("://")===-1)R="https://"+R;M=R}let S=q.wsConnectivityCheckUrl;if(S&&S.indexOf("://")===-1)S="wss://"+S;return E(P({},q),{primaryDomain:Q,maxMessageSize:q.maxMessageSize||m0.maxMessageSize,timeouts:F,connectivityCheckParams:Y,connectivityCheckUrl:M,wsConnectivityCheckUrl:S,headers:B})}function Nq(q,$,W){let X=W||{};if(X.cipher){if(!q)L0("Crypto");let G=q.getCipher(X.cipher,$);X.cipher=G.cipherParams,X.channelCipher=G.cipher}else if("cipher"in X)X.cipher=void 0,X.channelCipher=null;return X}var R8={json:"application/json",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack",text:"text/plain"},C8={format:"json",protocolVersion:m0.protocolVersion};function GX(q,{format:$,protocolVersion:W=C8.protocolVersion}={}){return{accept:R8[$!=null?$:q.useBinaryProtocol?"msgpack":"json"],"X-Ably-Version":W.toString(),"Ably-Agent":sq(q)}}function JX(q,{format:$,protocolVersion:W=C8.protocolVersion}={}){let X=R8[$!=null?$:q.useBinaryProtocol?"msgpack":"json"];return{accept:X,"content-type":X,"X-Ably-Version":W.toString(),"Ably-Agent":sq(q)}}var o=m0;function HX(q){return Object.assign(m0,q)}var UX=class q{constructor($,W){this.logger=$,this.members=W||[]}call($,W){for(let X of this.members)if(X)try{X($,W)}catch(G){H.logAction(this.logger,H.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+G+"; stack = "+G.stack)}}push(...$){this.members.push(...$)}createPromise(){return new Promise(($,W)=>{this.push((X,G)=>{X?W(X):$(G)})})}resolveAll($){this.call(null,$)}rejectAll($){this.call($)}static create($,W){let X=new q($,W);return Object.assign((G,J)=>X.call(G,J),{push:(G)=>X.push(G),createPromise:()=>X.createPromise(),resolveAll:(G)=>X.resolveAll(G),rejectAll:(G)=>X.rejectAll(G)})}},aq=UX,T8=((q)=>{return q.Get="get",q.Delete="delete",q.Post="post",q.Put="put",q.Patch="patch",q})(T8||{}),N0=T8,P8=((q)=>{return q[q.Success=200]="Success",q[q.NoContent=204]="NoContent",q[q.BadRequest=400]="BadRequest",q[q.Unauthorized=401]="Unauthorized",q[q.Forbidden=403]="Forbidden",q[q.RequestTimeout=408]="RequestTimeout",q[q.InternalServerError=500]="InternalServerError",q})(P8||{});function VX(q){return q>=200&&q<400}var Oq=P8,eq=Math.pow(2,17);function zX(){return("000000"+Math.floor(Math.random()*10000000000000000)).slice(-16)}function DX(q){return!!q.connection}function h8(q){if(!_q(q))return new K(H0(q),q.code||40170,q.statusCode||401);if(!q.code)if(q.statusCode===403)q.code=40300;else q.code=40170,q.statusCode=401;return q}var NX=(q,$)=>{let W=j.BufferUtils,X=W.utf8Encode(q),G=W.utf8Encode($),J=W.hmacSha256(X,G);return W.base64Encode(J)};function E8(q){if(!q)return"";if(typeof q=="string")q=JSON.parse(q);let $=Object.create(null),W=E1(q,!0);if(!W)return"";W.sort();for(let X=0;X<W.length;X++)$[W[X]]=q[W[X]].sort();return JSON.stringify($)}function b8(q,$){if(q.authCallback)H.logAction($,H.LOG_MINOR,"Auth()","using token auth with authCallback");else if(q.authUrl)H.logAction($,H.LOG_MINOR,"Auth()","using token auth with authUrl");else if(q.key)H.logAction($,H.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(q.tokenDetails)H.logAction($,H.LOG_MINOR,"Auth()","using token auth with supplied token only");else throw H.logAction($,H.LOG_ERROR,"Auth()","authOptions must include valid authentication parameters"),Error("authOptions must include valid authentication parameters")}function OX(q){return"useTokenAuth"in q&&!q.useTokenAuth}function k8(q){return q.useTokenAuth||!OX(q)&&(q.authCallback||q.authUrl||q.token||q.tokenDetails)}function QX(q){return!q.key&&!q.authCallback&&!q.authUrl}var wX=0;function BX(){return wX++}var FX=class{constructor(q,$){if(this.authOptions={},this.client=q,this.tokenParams=$.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,k8($)){if(QX($))H.logAction(this.logger,H.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help");this._saveTokenOptions($.defaultTokenParams,$),b8(this.authOptions,this.logger)}else{if(!$.key)throw H.logAction(this.logger,H.LOG_ERROR,"Auth()","No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)"),new K("No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)",40160,401);H.logAction(this.logger,H.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions($)}}get logger(){return this.client.logger}async authorize(q,$){if($&&$.key&&this.authOptions.key!==$.key)throw new K("Unable to update auth options with incompatible key",40102,401);try{let W=await this._forceNewToken(q!=null?q:null,$!=null?$:null);if(DX(this.client))return new Promise((X,G)=>{this.client.connection.connectionManager.onAuthUpdated(W,(J,N)=>J?G(J):X(N))});else return W}catch(W){if(this.client.connection&&W.statusCode===Oq.Forbidden)this.client.connection.connectionManager.actOnErrorFromAuthorize(W);throw W}}async _forceNewToken(q,$){this.tokenDetails=null,this._saveTokenOptions(q,$),b8(this.authOptions,this.logger);try{return this._ensureValidAuthCredentials(!0)}finally{delete this.tokenParams.timestamp,delete this.authOptions.queryTime}}async requestToken(q,$){let W=$||this.authOptions,X=q||v0(this.tokenParams),G,J=this.client;if(W.authCallback)H.logAction(this.logger,H.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),G=W.authCallback;else if(W.authUrl)H.logAction(this.logger,H.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),G=(Q,F)=>{let B=p({accept:"application/json, text/plain"},W.authHeaders),Y=W.authMethod&&W.authMethod.toLowerCase()==="post",M,S=W.authUrl.indexOf("?");if(S>-1){if(M=Uq(W.authUrl.slice(S)),W.authUrl=W.authUrl.slice(0,S),!Y)W.authParams=p(M,W.authParams)}let R=p({},W.authParams||{},Q),d=(g)=>{var t,W0;let Z0=(t=g.body)!=null?t:null,I0=null;if(g.error)H.logAction(this.logger,H.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+H0(g.error));else{let Y0=(W0=g.headers["content-type"])!=null?W0:null;if(Array.isArray(Y0))I0=Y0.join(", ");else I0=Y0;H.logAction(this.logger,H.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+I0+"; body: "+U8(Z0))}if(g.error){F(g.error,null);return}if(g.unpacked){F(null,Z0);return}if(j.BufferUtils.isBuffer(Z0))Z0=Z0.toString();if(!I0){F(new K("authUrl response is missing a content-type header",40170,401),null);return}let n=I0.indexOf("application/json")>-1,b0=I0.indexOf("text/plain")>-1||I0.indexOf("application/jwt")>-1;if(!n&&!b0){F(new K("authUrl responded with unacceptable content-type "+I0+", should be either text/plain, application/jwt or application/json",40170,401),null);return}if(n){if(Z0.length>eq){F(new K("authUrl response exceeded max permitted length",40170,401),null);return}try{Z0=JSON.parse(Z0)}catch(Y0){F(new K("Unexpected error processing authURL response; err = "+Y0.message,40170,401),null);return}}F(null,Z0,I0)};if(H.logAction(this.logger,H.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+W.authUrl+"; Params: "+JSON.stringify(R)+"; method: "+(Y?"POST":"GET")),Y){let g=B||{};g["content-type"]="application/x-www-form-urlencoded";let t=b1(R).slice(1);S0(this.client.http.doUri(N0.Post,W.authUrl,g,t,M),(W0,Z0)=>W0?d(W0):d(Z0))}else S0(this.client.http.doUri(N0.Get,W.authUrl,B||{},null,R),(g,t)=>g?d(g):d(t))};else if(W.key)H.logAction(this.logger,H.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),G=(Q,F)=>{S0(this.createTokenRequest(Q,W),(B,Y)=>F(B,Y!=null?Y:null))};else throw H.logAction(this.logger,H.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),new K("Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)",40171,403);if("capability"in X)X.capability=E8(X.capability);let N=(Q,F)=>{let B=Q.keyName,Y="/keys/"+B+"/requestToken",M=function(R){return J.baseUri(R)+Y},S=o.defaultPostHeaders(this.client.options,{format:"json"});if(W.requestHeaders)p(S,W.requestHeaders);H.logAction(this.logger,H.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+Y+"; Token params: "+JSON.stringify(Q)),S0(this.client.http.do(N0.Post,M,S,JSON.stringify(Q),null),(R,d)=>R?F(R):F(d.error,d.body,d.unpacked))};return new Promise((Q,F)=>{let B=!1,Y=this.client.options.timeouts.realtimeRequestTimeout,M=setTimeout(()=>{B=!0;let S="Token request callback timed out after "+Y/1000+" seconds";H.logAction(this.logger,H.LOG_ERROR,"Auth.requestToken()",S),F(new K(S,40170,401))},Y);G(X,(S,R,d)=>{if(B)return;if(clearTimeout(M),S){H.logAction(this.logger,H.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+H0(S)),F(h8(S));return}if(typeof R==="string"){if(R.length===0)F(new K("Token string is empty",40170,401));else if(R.length>eq)F(new K("Token string exceeded max permitted length (was "+R.length+" bytes)",40170,401));else if(R==="undefined"||R==="null")F(new K("Token string was literal null/undefined",40170,401));else if(R[0]==="{"&&!(d&&d.indexOf("application/jwt")>-1))F(new K("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401));else Q({token:R});return}if(typeof R!=="object"||R===null){let t="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof R;H.logAction(this.logger,H.LOG_ERROR,"Auth.requestToken()",t),F(new K(t,40170,401));return}let g=JSON.stringify(R).length;if(g>eq&&!W.suppressMaxLengthCheck){F(new K("Token request/details object exceeded max permitted stringified size (was "+g+" bytes)",40170,401));return}if("issued"in R){Q(R);return}if(!("keyName"in R)){H.logAction(this.logger,H.LOG_ERROR,"Auth.requestToken()","Expected token request callback to call back with a token string, token request object, or token details object"),F(new K("Expected token request callback to call back with a token string, token request object, or token details object",40170,401));return}N(R,(t,W0,Z0)=>{if(t){H.logAction(this.logger,H.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+H0(t)),F(h8(t));return}if(!Z0)W0=JSON.parse(W0);H.logAction(this.logger,H.LOG_MINOR,"Auth.getToken()","token received"),Q(W0)})})})}async createTokenRequest(q,$){$=$||this.authOptions,q=q||v0(this.tokenParams);let W=$.key;if(!W)throw new K("No key specified",40101,403);let X=W.split(":"),G=X[0],J=X[1];if(!J)throw new K("Invalid key specified",40101,403);if(q.clientId==="")throw new K("clientId can’t be an empty string",40012,400);if("capability"in q)q.capability=E8(q.capability);let N=p({keyName:G},q),Q=q.clientId||"",F=q.ttl||"",B=q.capability||"";if(!N.timestamp)N.timestamp=await this._getTimestamp($&&$.queryTime);let Y=N.nonce||(N.nonce=zX()),M=N.timestamp,S=N.keyName+`
`+F+`
`+B+`
`+Q+`
`+M+`
`+Y+`
`;return N.mac=N.mac||NX(S,J),H.logAction(this.logger,H.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),N}async getAuthParams(){if(this.method=="basic")return{key:this.key};else{let q=await this._ensureValidAuthCredentials(!1);if(!q)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{access_token:q.token}}}async getAuthHeaders(){if(this.method=="basic")return{authorization:"Basic "+this.basicKey};else{let q=await this._ensureValidAuthCredentials(!1);if(!q)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{authorization:"Bearer "+zq(q.token)}}}_saveBasicOptions(q){if(this.method="basic",this.key=q.key,this.basicKey=zq(q.key),this.authOptions=q||{},"clientId"in q)this._userSetClientId(q.clientId)}_saveTokenOptions(q,$){if(this.method="token",q)this.tokenParams=q;if($){if($.token)$.tokenDetails=typeof $.token==="string"?{token:$.token}:$.token;if($.tokenDetails)this.tokenDetails=$.tokenDetails;if("clientId"in $)this._userSetClientId($.clientId);this.authOptions=$}}async _ensureValidAuthCredentials(q){let $=this.tokenDetails;if($){if(this._tokenClientIdMismatch($.clientId))throw new K("Mismatch between clientId in token ("+$.clientId+") and current clientId ("+this.clientId+")",40102,403);if(!this.client.isTimeOffsetSet()||!$.expires||$.expires>=this.client.getTimestampUsingOffset())return H.logAction(this.logger,H.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+$.expires),$;H.logAction(this.logger,H.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}let W=(this.waitingForTokenRequest||(this.waitingForTokenRequest=aq.create(this.logger))).createPromise();if(this.currentTokenRequestId!==null&&!q)return W;let X=this.currentTokenRequestId=BX(),G,J=null;try{G=await this.requestToken(this.tokenParams,this.authOptions)}catch(Q){J=Q}if(this.currentTokenRequestId>X)return H.logAction(this.logger,H.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"),W;this.currentTokenRequestId=null;let N=this.waitingForTokenRequest;if(this.waitingForTokenRequest=null,J)return N==null||N.rejectAll(J),W;return N==null||N.resolveAll(this.tokenDetails=G),W}_userSetClientId(q){if(!(typeof q==="string"||q===null))throw new K("clientId must be either a string or null",40012,400);else if(q==="*")throw new K('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);else{let $=this._uncheckedSetClientId(q);if($)throw $}}_uncheckedSetClientId(q){if(this._tokenClientIdMismatch(q)){let $="Unexpected clientId mismatch: client has "+this.clientId+", requested "+q,W=new K($,40102,401);return H.logAction(this.logger,H.LOG_ERROR,"Auth._uncheckedSetClientId()",$),W}else return this.clientId=this.tokenParams.clientId=q,null}_tokenClientIdMismatch(q){return!!(this.clientId&&this.clientId!=="*"&&q&&q!=="*"&&this.clientId!==q)}static isTokenErr(q){return q.code&&q.code>=40140&&q.code<40150}revokeTokens(q,$){return this.client.rest.revokeTokens(q,$)}async _getTimestamp(q){return this.client.getTimestamp(q||!!this.authOptions.queryTime)}},t0=FX;function q$(q){let $=[];if(q)for(let W in q)$.push(W+"="+q[W]);return $.join("&")}function w1(q,$){return q+($?"?":"")+q$($)}function KX(q,$,W,X,G){if(q.error)H.logActionNoStrip(G,H.LOG_MICRO,"Http."+$+"()","Received Error; "+w1(W,X)+"; Error: "+H0(q.error));else H.logActionNoStrip(G,H.LOG_MICRO,"Http."+$+"()","Received; "+w1(W,X)+"; Headers: "+q$(q.headers)+"; StatusCode: "+q.statusCode+"; Body"+(j.BufferUtils.isBuffer(q.body)?" (Base64): "+j.BufferUtils.base64Encode(q.body):": "+q.body))}function jX(q,$,W,X,G){if(G.shouldLog(H.LOG_MICRO))H.logActionNoStrip(G,H.LOG_MICRO,"Http."+q+"()","Sending; "+w1($,X)+"; Body"+(j.BufferUtils.isBuffer(W)?" (Base64): "+j.BufferUtils.base64Encode(W):": "+W))}var $$=class{constructor(q){this.client=q,this.platformHttp=new j.Http(q),this.checkConnectivity=this.platformHttp.checkConnectivity?()=>this.platformHttp.checkConnectivity():void 0}get logger(){var q,$;return($=(q=this.client)==null?void 0:q.logger)!=null?$:H.defaultLogger}get supportsAuthHeaders(){return this.platformHttp.supportsAuthHeaders}get supportsLinkHeaders(){return this.platformHttp.supportsLinkHeaders}_getHosts(q){let $=q.connection,W=$&&$.connectionManager.host;if(W)return[W].concat(o.getFallbackHosts(q.options));return o.getHosts(q.options)}async do(q,$,W,X,G){try{let J=this.client;if(!J)return{error:new K("http.do called without client",50000,500)};let N=typeof $==="function"?$:function(M){return J.baseUri(M)+$},Q=J._currentFallback;if(Q)if(Q.validUntil>Date.now()){let M=await this.doUri(q,N(Q.host),W,X,G);if(M.error&&this.platformHttp.shouldFallback(M.error))return J._currentFallback=null,this.do(q,$,W,X,G);return M}else J._currentFallback=null;let F=this._getHosts(J);if(F.length===1)return this.doUri(q,N(F[0]),W,X,G);let B=null,Y=async(M,S)=>{let R=M.shift();B=B!=null?B:new Date;let d=await this.doUri(q,N(R),W,X,G);if(d.error&&this.platformHttp.shouldFallback(d.error)&&M.length){if(Date.now()-B.getTime()>J.options.timeouts.httpMaxRetryDuration)return{error:new K(`Timeout for trying fallback hosts retries. Total elapsed time exceeded the ${J.options.timeouts.httpMaxRetryDuration}ms limit`,50003,500)};return Y(M,!0)}if(S)J._currentFallback={host:R,validUntil:Date.now()+J.options.timeouts.fallbackRetryTimeout};return d};return Y(F)}catch(J){return{error:new K(`Unexpected error in Http.do: ${H0(J)}`,500,50000)}}}async doUri(q,$,W,X,G){try{jX(q,$,X,G,this.logger);let J=await this.platformHttp.doUri(q,$,W,X,G);if(this.logger.shouldLog(H.LOG_MICRO))KX(J,q,$,G,this.logger);return J}catch(J){return{error:new K(`Unexpected error in Http.doUri: ${H0(J)}`,500,50000)}}}};function LX(q,$,W,X){try{W.apply($,X)}catch(G){H.logAction(q,H.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+G+"; stack = "+(G&&G.stack))}}function W$(q,$,W){let X,G,J;for(let N=0;N<q.length;N++){if(X=q[N],W)X=X[W];if(Array.isArray(X)){while((G=X.indexOf($))!==-1)X.splice(G,1);if(W&&X.length===0)delete q[N][W]}else if(l0(X)){for(J in X)if(Object.prototype.hasOwnProperty.call(X,J)&&Array.isArray(X[J]))W$([X],$,J)}}}var IX=class{constructor(q){this.logger=q,this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}on(...q){if(q.length===1){let $=q[0];if(typeof $==="function")this.any.push($);else throw Error("EventListener.on(): Invalid arguments: "+j.Config.inspect(q))}if(q.length===2){let[$,W]=q;if(typeof W!=="function")throw Error("EventListener.on(): Invalid arguments: "+j.Config.inspect(q));if(h0($))this.any.push(W);else if(Array.isArray($))$.forEach((X)=>{this.on(X,W)});else{if(typeof $!=="string")throw Error("EventListener.on(): Invalid arguments: "+j.Config.inspect(q));(this.events[$]||(this.events[$]=[])).push(W)}}}off(...q){if(q.length==0||h0(q[0])&&h0(q[1])){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null);return}let[$,W]=q,X=null,G=null;if(q.length===1||!W)if(typeof $==="function")X=$;else G=$;else{if(typeof W!=="function")throw Error("EventEmitter.off(): invalid arguments:"+j.Config.inspect(q));[G,X]=[$,W]}if(X&&h0(G)){W$([this.any,this.events,this.anyOnce,this.eventsOnce],X);return}if(Array.isArray(G)){G.forEach((J)=>{this.off(J,X)});return}if(typeof G!=="string")throw Error("EventEmitter.off(): invalid arguments:"+j.Config.inspect(q));if(X)W$([this.events,this.eventsOnce],X,G);else delete this.events[G],delete this.eventsOnce[G]}listeners(q){if(q){let $=this.events[q]||[];if(this.eventsOnce[q])Array.prototype.push.apply($,this.eventsOnce[q]);return $.length?$:null}return this.any.length?this.any:null}emit(q,...$){let W={event:q},X=[];if(this.anyOnce.length)Array.prototype.push.apply(X,this.anyOnce),this.anyOnce=[];if(this.any.length)Array.prototype.push.apply(X,this.any);let G=this.eventsOnce[q];if(G)Array.prototype.push.apply(X,G),delete this.eventsOnce[q];let J=this.events[q];if(J)Array.prototype.push.apply(X,J);X.forEach((N)=>{LX(this.logger,W,N,$)})}once(...q){let $=q.length;if($===0||$===1&&typeof q[0]!=="function"){let G=q[0];return new Promise((J)=>{this.once(G,J)})}let[W,X]=q;if(q.length===1&&typeof W==="function")this.anyOnce.push(W);else if(h0(W)){if(typeof X!=="function")throw Error("EventEmitter.once(): Invalid arguments:"+j.Config.inspect(q));this.anyOnce.push(X)}else if(Array.isArray(W)){let G=this,J=function(){let N=Array.prototype.slice.call(arguments);if(W.forEach(function(Q){G.off(Q,J)}),typeof X!=="function")throw Error("EventEmitter.once(): Invalid arguments:"+j.Config.inspect(q));X.apply(this,N)};W.forEach(function(N){G.on(N,J)})}else{if(typeof W!=="string")throw Error("EventEmitter.once(): Invalid arguments:"+j.Config.inspect(q));let G=this.eventsOnce[W]||(this.eventsOnce[W]=[]);if(X){if(typeof X!=="function")throw Error("EventEmitter.once(): Invalid arguments:"+j.Config.inspect(q));G.push(X)}}}async whenState(q,$){if(typeof q!=="string"||typeof $!=="string")throw Error("whenState requires a valid state String argument");if(q===$)return null;else return this.once(q)}},B0=IX,c={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17,ACTIVATE:18,OBJECT:19,OBJECT_SYNC:20,ANNOTATION:21},u8=[];Object.keys(c).forEach(function(q){u8[c[q]]=q});var A0={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,HAS_OBJECTS:128,PRESENCE:65536,PUBLISH:131072,SUBSCRIBE:262144,PRESENCE_SUBSCRIBE:524288,ANNOTATION_PUBLISH:2097152,ANNOTATION_SUBSCRIBE:4194304,OBJECT_SUBSCRIBE:16777216,OBJECT_PUBLISH:33554432},YX=Object.keys(A0);A0.MODE_ALL=A0.PRESENCE|A0.PUBLISH|A0.SUBSCRIBE|A0.PRESENCE_SUBSCRIBE|A0.ANNOTATION_PUBLISH|A0.ANNOTATION_SUBSCRIBE|A0.OBJECT_SUBSCRIBE|A0.OBJECT_PUBLISH;var y8=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE","ANNOTATION_PUBLISH","ANNOTATION_SUBSCRIBE","OBJECT_SUBSCRIBE","OBJECT_PUBLISH"];function MX(q){if(!q||!q.channelOptions)return{channelOptions:q,plugins:{},baseEncodedPreviousPayload:void 0};return q}function g8(q,$,W){if(W&&W.cipher){if(!q)L0("Crypto");let X=q.getCipher(W.cipher,$);return{cipher:X.cipherParams,channelCipher:X.cipher}}return W!=null?W:{}}async function SX(q,$){let{data:W,encoding:X}=await v8(q.data,q.encoding,$);return q.data=W,q.encoding=X,q}async function v8(q,$,W){let X=W.channelCipher,G=q,J=$?$+"/":"";if(!j.BufferUtils.isBuffer(G))G=j.BufferUtils.utf8Encode(String(G)),J=J+"utf-8/";let N=await X.encrypt(G);return J=J+"cipher+"+X.algorithm,{data:N,encoding:J}}async function Z$(q,$){let{data:W,encoding:X}=i8(q.data,q.encoding);if(q.data=W,q.encoding=X,$!=null&&$.cipher)return SX(q,$);else return q}function i8(q,$){if(typeof q=="string"||j.BufferUtils.isBuffer(q)||q===null||q===void 0)return{data:q,encoding:$};if(l0(q)||Array.isArray(q))return{data:JSON.stringify(q),encoding:$?$+"/json":"json"};throw new K("Data type is unsupported",40013,400)}async function X$(q,$){let{data:W,encoding:X,error:G}=await m8(q.data,q.encoding,$);if(q.data=W,q.encoding=X,G)throw G}async function m8(q,$,W){let X=MX(W),G=q,J=q,N=$,Q;if($){let F=$.split("/"),B,Y=F.length,M="";try{while((B=Y)>0){let S=F[--Y].match(/([-\w]+)(\+([\w-]+))?/);if(!S)break;switch(M=S[1],M){case"base64":if(J=j.BufferUtils.base64Decode(String(J)),B==F.length)G=J;continue;case"utf-8":J=j.BufferUtils.utf8Decode(J);continue;case"json":J=JSON.parse(J);continue;case"cipher":if(X.channelOptions!=null&&X.channelOptions.cipher&&X.channelOptions.channelCipher){let R=S[3],d=X.channelOptions.channelCipher;if(R!=d.algorithm)throw Error("Unable to decrypt message with given cipher; incompatible cipher params");J=await d.decrypt(J);continue}else throw Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!X.plugins||!X.plugins.vcdiff)throw new K("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if(typeof Uint8Array>"u")throw new K("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{let R=X.baseEncodedPreviousPayload;if(typeof R==="string")R=j.BufferUtils.utf8Encode(R);let d=j.BufferUtils.toBuffer(R);J=j.BufferUtils.toBuffer(J),J=j.BufferUtils.arrayBufferViewToBuffer(X.plugins.vcdiff.decode(J,d)),G=J}catch(R){throw new K("Vcdiff delta decode failed with "+R,40018,400)}continue;default:throw Error("Unknown encoding")}}}catch(S){let R=S;Q=new K(`Error processing the ${M} encoding, decoder returned ‘${R.message}’`,R.code||40013,400)}finally{N=B<=0?null:F.slice(0,B).join("/")}}if(Q)return{error:Q,data:J,encoding:N};return X.baseEncodedPreviousPayload=G,{data:J,encoding:N}}function G$(...q){let $=q.length>0?"json":"msgpack",{data:W,encoding:X}=p8(this.data,this.encoding,$);return Object.assign({},this,{encoding:X,data:W})}function p8(q,$,W){if(!q||!j.BufferUtils.isBuffer(q))return{data:q,encoding:$};if(W==="msgpack")return{data:j.BufferUtils.toBuffer(q),encoding:$};return{data:j.BufferUtils.base64Encode(q),encoding:$?$+"/base64":"base64"}}var Qq={encryptData:v8,encodeData:i8,encodeDataForWire:p8,decodeData:m8};function wq(q){let{id:$,connectionId:W,timestamp:X}=q,G;switch(q.action){case c.MESSAGE:{G=q.messages;break}case c.PRESENCE:case c.SYNC:G=q.presence;break;case c.ANNOTATION:G=q.annotations;break;case c.OBJECT:case c.OBJECT_SYNC:G=q.state;break;default:throw new K("Unexpected action "+q.action,40000,400)}for(let J=0;J<G.length;J++){let N=G[J];if(!N.connectionId)N.connectionId=W;if(!N.timestamp)N.timestamp=X;if($&&!N.id)N.id=$+":"+J}}function B1(q,$){let W="["+$;for(let X in q)if(X==="data"){if(typeof q.data=="string")W+="; data="+q.data;else if(j.BufferUtils.isBuffer(q.data))W+="; data (buffer)="+j.BufferUtils.base64Encode(q.data);else if(typeof q.data<"u")W+="; data (json)="+JSON.stringify(q.data)}else if(X&&(X==="extras"||X==="operation"))W+="; "+X+"="+JSON.stringify(q[X]);else if(X==="version")W+="; version="+JSON.stringify(q[X]);else if(X==="annotations")W+="; annotations="+JSON.stringify(q[X]);else if(q[X]!==void 0)W+="; "+X+"="+q[X];return W+="]",W}var F1=class{},d8=class{constructor(q){this.Platform=j,this.ErrorInfo=K,this.Logger=H,this.Defaults=o,this.Utils=G0,this.EventEmitter=B0,this.MessageEncoding=Qq;var $,W,X,G,J,N,Q,F,B,Y;this._additionalHTTPRequestImplementations=($=q.plugins)!=null?$:null,this.logger=new H,this.logger.setLog(q.logLevel,q.logHandler),H.logAction(this.logger,H.LOG_MICRO,"BaseClient()","initialized with clientOptions "+j.Config.inspect(q)),this._MsgPack=(X=(W=q.plugins)==null?void 0:W.MsgPack)!=null?X:null;let M=this.options=o.normaliseOptions(q,this._MsgPack,this.logger);if(M.key){let S=M.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!S)throw H.logAction(this.logger,H.LOG_ERROR,"BaseClient()","invalid key parameter"),new K("invalid key parameter",40400,404);M.keyName=S[1],M.keySecret=S[2]}if("clientId"in M){if(!(typeof M.clientId==="string"||M.clientId===null))throw new K("clientId must be either a string or null",40012,400);else if(M.clientId==="*")throw new K('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}H.logAction(this.logger,H.LOG_MINOR,"BaseClient()","started; version = "+o.version),this._currentFallback=null,this.serverTimeOffset=null,this.http=new $$(this),this.auth=new t0(this,M),this._rest=((G=q.plugins)==null?void 0:G.Rest)?new q.plugins.Rest(this):null,this._Crypto=(N=(J=q.plugins)==null?void 0:J.Crypto)!=null?N:null,this.__FilteredSubscriptions=(F=(Q=q.plugins)==null?void 0:Q.MessageInteractions)!=null?F:null,this._Annotations=(Y=(B=q.plugins)==null?void 0:B.Annotations)!=null?Y:null}get rest(){if(!this._rest)L0("Rest");return this._rest}get _FilteredSubscriptions(){if(!this.__FilteredSubscriptions)L0("MessageInteractions");return this.__FilteredSubscriptions}get channels(){return this.rest.channels}get push(){return this.rest.push}device(){var q;if(!((q=this.options.plugins)==null?void 0:q.Push)||!this.push.LocalDevice)L0("Push");if(!this._device)this._device=this.push.LocalDevice.load(this);return this._device}baseUri(q){return o.getHttpScheme(this.options)+q+":"+o.getPort(this.options,!1)}async stats(q){return this.rest.stats(q)}async time(q){return this.rest.time(q)}async request(q,$,W,X,G,J){return this.rest.request(q,$,W,X,G,J)}batchPublish(q){return this.rest.batchPublish(q)}batchPresence(q){return this.rest.batchPresence(q)}setLog(q){this.logger.setLog(q.level,q.handler)}async getTimestamp(q){if(!this.isTimeOffsetSet()&&q)return this.time();return this.getTimestampUsingOffset()}getTimestampUsingOffset(){return Date.now()+(this.serverTimeOffset||0)}isTimeOffsetSet(){return this.serverTimeOffset!==null}};d8.Platform=j;var c8=d8,AX=class q{toJSON(){var $,W,X;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:($=this.push)==null?void 0:$.recipient,state:(W=this.push)==null?void 0:W.state,error:(X=this.push)==null?void 0:X.error}}}toString(){var $,W,X,G;let J="[DeviceDetails";if(this.id)J+="; id="+this.id;if(this.platform)J+="; platform="+this.platform;if(this.formFactor)J+="; formFactor="+this.formFactor;if(this.clientId)J+="; clientId="+this.clientId;if(this.metadata)J+="; metadata="+this.metadata;if(this.deviceIdentityToken)J+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken);if(($=this.push)==null?void 0:$.recipient)J+="; push.recipient="+JSON.stringify(this.push.recipient);if((W=this.push)==null?void 0:W.state)J+="; push.state="+this.push.state;if((X=this.push)==null?void 0:X.error)J+="; push.error="+JSON.stringify(this.push.error);if((G=this.push)==null?void 0:G.metadata)J+="; push.metadata="+this.push.metadata;return J+="]",J}static toRequestBody($,W,X){return i0($,W,X)}static fromResponseBody($,W,X){if(X)$=j0($,W,X);if(Array.isArray($))return q.fromValuesArray($);else return q.fromValues($)}static fromValues($){return $.error=$.error&&K.fromValues($.error),Object.assign(new q,$)}static fromLocalDevice($){return Object.assign(new q,$)}static fromValuesArray($){let W=$.length,X=Array(W);for(let G=0;G<W;G++)X[G]=q.fromValues($[G]);return X}},K1=AX;async function x8(q,$,W,X){if(q.http.supportsAuthHeaders){let G=await q.auth.getAuthHeaders();return X(p(G,$),W)}else{let G=await q.auth.getAuthParams();return X($,p(G,W))}}function RX(q,$,W){if(q.err&&!q.body)return{err:q.err};if(q.statusCode===Oq.NoContent)return E(P({},q),{body:[],unpacked:!0});let X=q.body;if(!q.unpacked)try{X=j0(X,$,W)}catch(Q){if(_q(Q))return{err:Q};else return{err:new s(H0(Q),null)}}if(!X)return{err:new s("unenvelope(): Response body is missing",null)};let{statusCode:G,response:J,headers:N}=X;if(G===void 0)return E(P({},q),{body:X,unpacked:!0});if(G<200||G>=300){let Q=J&&J.error||q.err;if(!Q)Q=Error("Error in unenveloping "+X),Q.statusCode=G;return{err:Q,body:J,headers:N,unpacked:!0,statusCode:G}}return{err:q.err,body:J,headers:N,unpacked:!0,statusCode:G}}function CX(q,$,W,X,G){if(q.err)H.logAction(G,H.LOG_MICRO,"Resource."+$+"()","Received Error; "+w1(W,X)+"; Error: "+H0(q.err));else H.logAction(G,H.LOG_MICRO,"Resource."+$+"()","Received; "+w1(W,X)+"; Headers: "+q$(q.headers)+"; StatusCode: "+q.statusCode+"; Body: "+(j.BufferUtils.isBuffer(q.body)?" (Base64): "+j.BufferUtils.base64Encode(q.body):": "+j.Config.inspect(q.body)))}var TX=class q{static async get($,W,X,G,J,N){return q.do(N0.Get,$,W,null,X,G,J,N!=null?N:!1)}static async delete($,W,X,G,J,N){return q.do(N0.Delete,$,W,null,X,G,J,N)}static async post($,W,X,G,J,N,Q){return q.do(N0.Post,$,W,X,G,J,N,Q)}static async patch($,W,X,G,J,N,Q){return q.do(N0.Patch,$,W,X,G,J,N,Q)}static async put($,W,X,G,J,N,Q){return q.do(N0.Put,$,W,X,G,J,N,Q)}static async do($,W,X,G,J,N,Q,F){if(Q)(N=N||{}).envelope=Q;let B=W.logger;async function Y(S,R){var d;if(B.shouldLog(H.LOG_MICRO)){let t=G;if(((d=S["content-type"])==null?void 0:d.indexOf("msgpack"))>0)try{if(!W._MsgPack)L0("MsgPack");t=W._MsgPack.decode(G)}catch(W0){H.logAction(B,H.LOG_MICRO,"Resource."+$+"()","Sending MsgPack Decoding Error: "+H0(W0))}H.logAction(B,H.LOG_MICRO,"Resource."+$+"()","Sending; "+w1(X,R)+"; Body: "+t)}let g=await W.http.do($,X,S,G,R);if(g.error&&t0.isTokenErr(g.error))return await W.auth.authorize(null,null),x8(W,S,R,Y);return{err:g.error,body:g.body,headers:g.headers,unpacked:g.unpacked,statusCode:g.statusCode}}let M=await x8(W,J,N,Y);if(Q)M=RX(M,W._MsgPack,Q);if(B.shouldLog(H.LOG_MICRO))CX(M,$,X,N,B);if(F)if(M.err)throw M.err;else{let S=P({},M);return delete S.err,S}return M}},D0=TX;function PX(q){let $=q.match(/^\.\/(\w+)\?(.*)$/);return $&&$[2]&&Uq($[2])}function hX(q){if(typeof q=="string")q=q.split(",");let $={};for(let W=0;W<q.length;W++){let X=q[W].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(X){let G=PX(X[1]);if(G)$[X[2]]=G}}return $}function EX(q,$,W){return!(W&&($||typeof q.code==="number"))}var bX=class{constructor(q,$,W,X,G,J){this.client=q,this.path=$,this.headers=W,this.envelope=X!=null?X:null,this.bodyHandler=G,this.useHttpPaginatedResponse=J||!1}get logger(){return this.client.logger}async get(q){let $=await D0.get(this.client,this.path,this.headers,q,this.envelope,!1);return this.handlePage($)}async delete(q){let $=await D0.delete(this.client,this.path,this.headers,q,this.envelope,!1);return this.handlePage($)}async post(q,$){let W=await D0.post(this.client,this.path,$,this.headers,q,this.envelope,!1);return this.handlePage(W)}async put(q,$){let W=await D0.put(this.client,this.path,$,this.headers,q,this.envelope,!1);return this.handlePage(W)}async patch(q,$){let W=await D0.patch(this.client,this.path,$,this.headers,q,this.envelope,!1);return this.handlePage(W)}async handlePage(q){if(q.err&&EX(q.err,q.body,this.useHttpPaginatedResponse))throw H.logAction(this.logger,H.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+H0(q.err)),q.err;let $,W,X;try{$=q.statusCode==Oq.NoContent?[]:await this.bodyHandler(q.body,q.headers||{},q.unpacked)}catch(G){throw q.err||G}if(q.headers&&(W=q.headers.Link||q.headers.link))X=hX(W);if(this.useHttpPaginatedResponse)return new kX(this,$,q.headers||{},q.statusCode,X,q.err);else return new f8(this,$,X)}},f8=class{constructor(q,$,W){this.resource=q,this.items=$,this._relParams=W}async first(){if(this.hasFirst())return this.get(this._relParams.first);throw new K("No link to the first page of results",40400,404)}async current(){if(this.hasCurrent())return this.get(this._relParams.current);throw new K("No link to the current page of results",40400,404)}async next(){if(this.hasNext())return this.get(this._relParams.next);return null}hasFirst(){return this._relParams!=null&&"first"in this._relParams}hasCurrent(){return this._relParams!=null&&"current"in this._relParams}hasNext(){return this._relParams!=null&&"next"in this._relParams}isLast(){return!this.hasNext()}async get(q){let $=this.resource,W=await D0.get($.client,$.path,$.headers,q,$.envelope,!1);return $.handlePage(W)}},kX=class extends f8{constructor(q,$,W,X,G,J){super(q,$,G);this.statusCode=X,this.success=X<300&&X>=200,this.headers=W,this.errorCode=J&&J.code,this.errorMessage=J&&J.message}toJSON(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}}},p0=bX,o8=class q{toJSON(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}}toString(){let $="[PushChannelSubscription";if(this.channel)$+="; channel="+this.channel;if(this.deviceId)$+="; deviceId="+this.deviceId;if(this.clientId)$+="; clientId="+this.clientId;return $+="]",$}static fromResponseBody($,W,X){if(X)$=j0($,W,X);if(Array.isArray($))return q.fromValuesArray($);else return q.fromValues($)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){let W=$.length,X=Array(W);for(let G=0;G<W;G++)X[G]=q.fromValues($[G]);return X}};o8.toRequestBody=i0;var uX=o8,Bq=uX,yX=class{constructor(q){var $;if(this.client=q,this.admin=new gX(q),j.Config.push&&(($=q.options.plugins)==null?void 0:$.Push))this.stateMachine=new q.options.plugins.Push.ActivationStateMachine(q),this.LocalDevice=q.options.plugins.Push.localDeviceFactory(K1)}async activate(q,$){await new Promise((W,X)=>{var G;if(!((G=this.client.options.plugins)==null?void 0:G.Push)){X(Dq("Push"));return}if(!this.stateMachine){X(new K("This platform is not supported as a target of push notifications",40000,400));return}if(this.stateMachine.activatedCallback){X(new K("Activation already in progress",40000,400));return}this.stateMachine.activatedCallback=(J)=>{if(J){X(J);return}W()},this.stateMachine.updateFailedCallback=$,this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledActivate(this.stateMachine,q))})}async deactivate(q){await new Promise(($,W)=>{var X;if(!((X=this.client.options.plugins)==null?void 0:X.Push)){W(Dq("Push"));return}if(!this.stateMachine){W(new K("This platform is not supported as a target of push notifications",40000,400));return}if(this.stateMachine.deactivatedCallback){W(new K("Deactivation already in progress",40000,400));return}this.stateMachine.deactivatedCallback=(G)=>{if(G){W(G);return}$()},this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledDeactivate(this.stateMachine,q))})}},gX=class{constructor(q){this.client=q,this.deviceRegistrations=new vX(q),this.channelSubscriptions=new iX(q)}async publish(q,$){let W=this.client,X=W.options.useBinaryProtocol?"msgpack":"json",G=o.defaultPostHeaders(W.options),J={},N=p({recipient:q},$);if(p(G,W.options.headers),W.options.pushFullWait)p(J,{fullWait:"true"});let Q=i0(N,W._MsgPack,X);await D0.post(W,"/push/publish",Q,G,J,null,!0)}},vX=class{constructor(q){this.client=q}async save(q){let $=this.client,W=K1.fromValues(q),X=$.options.useBinaryProtocol?"msgpack":"json",G=o.defaultPostHeaders($.options),J={};if(p(G,$.options.headers),$.options.pushFullWait)p(J,{fullWait:"true"});let N=i0(W,$._MsgPack,X),Q=await D0.put($,"/push/deviceRegistrations/"+encodeURIComponent(q.id),N,G,J,null,!0);return K1.fromResponseBody(Q.body,$._MsgPack,Q.unpacked?void 0:X)}async get(q){let $=this.client,W=$.options.useBinaryProtocol?"msgpack":"json",X=o.defaultGetHeaders($.options),G=q.id||q;if(typeof G!=="string"||!G.length)throw new K("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",40000,400);p(X,$.options.headers);let J=await D0.get($,"/push/deviceRegistrations/"+encodeURIComponent(G),X,{},null,!0);return K1.fromResponseBody(J.body,$._MsgPack,J.unpacked?void 0:W)}async list(q){let $=this.client,W=$.options.useBinaryProtocol?"msgpack":"json",X=this.client.http.supportsLinkHeaders?void 0:W,G=o.defaultGetHeaders($.options);return p(G,$.options.headers),new p0($,"/push/deviceRegistrations",G,X,async function(J,N,Q){return K1.fromResponseBody(J,$._MsgPack,Q?void 0:W)}).get(q)}async remove(q){let $=this.client,W=o.defaultGetHeaders($.options),X={},G=q.id||q;if(typeof G!=="string"||!G.length)throw new K("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",40000,400);if(p(W,$.options.headers),$.options.pushFullWait)p(X,{fullWait:"true"});await D0.delete($,"/push/deviceRegistrations/"+encodeURIComponent(G),W,X,null,!0)}async removeWhere(q){let $=this.client,W=$.options.useBinaryProtocol?"msgpack":"json",X=o.defaultGetHeaders($.options,{format:W});if(p(X,$.options.headers),$.options.pushFullWait)p(q,{fullWait:"true"});await D0.delete($,"/push/deviceRegistrations",X,q,null,!0)}},iX=class q{constructor($){this.remove=q.prototype.removeWhere,this.client=$}async save($){let W=this.client,X=Bq.fromValues($),G=W.options.useBinaryProtocol?"msgpack":"json",J=o.defaultPostHeaders(W.options),N={};if(p(J,W.options.headers),W.options.pushFullWait)p(N,{fullWait:"true"});let Q=i0(X,W._MsgPack,G),F=await D0.post(W,"/push/channelSubscriptions",Q,J,N,null,!0);return Bq.fromResponseBody(F.body,W._MsgPack,F.unpacked?void 0:G)}async list($){let W=this.client,X=W.options.useBinaryProtocol?"msgpack":"json",G=this.client.http.supportsLinkHeaders?void 0:X,J=o.defaultGetHeaders(W.options);return p(J,W.options.headers),new p0(W,"/push/channelSubscriptions",J,G,async function(N,Q,F){return Bq.fromResponseBody(N,W._MsgPack,F?void 0:X)}).get($)}async removeWhere($){let W=this.client,X=W.options.useBinaryProtocol?"msgpack":"json",G=o.defaultGetHeaders(W.options,{format:X});if(p(G,W.options.headers),W.options.pushFullWait)p($,{fullWait:"true"});await D0.delete(W,"/push/channelSubscriptions",G,$,null,!0)}async listChannels($){let W=this.client,X=W.options.useBinaryProtocol?"msgpack":"json",G=this.client.http.supportsLinkHeaders?void 0:X,J=o.defaultGetHeaders(W.options);if(p(J,W.options.headers),W.options.pushFullWait)p($,{fullWait:"true"});return new p0(W,"/push/channels",J,G,async function(N,Q,F){let B=!F&&X?j0(N,W._MsgPack,X):N;for(let Y=0;Y<B.length;Y++)B[Y]=String(B[Y]);return B}).get($)}},mX=yX,n8=["absent","present","enter","leave","update"];async function _8(q,$,W,X){let G=g8($,q,X!=null?X:null);return k1.fromValues(W).decode(G,q)}async function pX(q,$,W,X){return Promise.all(W.map(function(G){return _8(q,$,G,X)}))}async function dX(q,$){return k1.fromValues(q).decode($.channelOptions,$.logger)}async function l8(q,$){return Promise.all(q.map(function(W){return dX(W,$)}))}var t8=class q extends F1{isSynthesized(){if(!this.id||!this.connectionId)return!0;return this.id.substring(this.connectionId.length,0)!==this.connectionId}parseId(){if(!this.id)throw Error("parseId(): Presence message does not contain an id");let $=this.id.split(":");return{connectionId:$[0],msgSerial:parseInt($[1],10),index:parseInt($[2],10)}}async encode($){let W=Object.assign(new k1,this,{action:n8.indexOf(this.action||"present")});return Z$(W,$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((W)=>q.fromValues(W))}static fromData($){if($ instanceof q)return $;return q.fromValues({data:$})}toString(){return B1(this,"PresenceMessage")}},k1=class q extends F1{toJSON(...$){return G$.call(this,...$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((W)=>q.fromValues(W))}async decode($,W){let X=Object.assign(new t8,E(P({},this),{action:n8[this.action]}));try{await X$(X,$)}catch(G){H.logAction(W,H.LOG_ERROR,"WirePresenceMessage.decode()",H0(G))}return X}toString(){return B1(this,"WirePresenceMessage")}},r0=t8,cX=class{constructor(q){this.channel=q}get logger(){return this.channel.logger}async get(q){H.logAction(this.logger,H.LOG_MICRO,"RestPresence.get()","channel = "+this.channel.name);let $=this.channel.client,W=$.options.useBinaryProtocol?"msgpack":"json",X=this.channel.client.http.supportsLinkHeaders?void 0:W,G=o.defaultGetHeaders($.options);return p(G,$.options.headers),new p0($,this.channel.client.rest.presenceMixin.basePath(this),G,X,async(J,N,Q)=>{let F=Q?J:j0(J,$._MsgPack,W);return l8(F,this.channel)}).get(q)}async history(q){return H.logAction(this.logger,H.LOG_MICRO,"RestPresence.history()","channel = "+this.channel.name),this.channel.client.rest.presenceMixin.history(this,q)}},xX=cX,r8=["message.create","message.update","message.delete","meta","message.summary"];function fX(q){return r8[q||0]||"unknown"}function oX(q){let $=0;if(q.name)$+=q.name.length;if(q.clientId)$+=q.clientId.length;if(q.extras)$+=JSON.stringify(q.extras).length;if(q.data)$+=V8(q.data);return $}async function s8(q,$,W,X){let G=g8($,q,X!=null?X:null);return u1.fromValues(W).decode(G,q)}async function nX(q,$,W,X){return Promise.all(W.map(function(G){return s8(q,$,G,X)}))}async function a8(q,$){return u1.fromValues(q).decode($.channelOptions,$.logger)}async function e8(q,$){return Promise.all(q.map(function(W){return a8(W,$)}))}async function qW(q,$){return Promise.all(q.map((W)=>W.encode($)))}var $W=i0;function J$(q){let $,W=0;for(let X=0;X<q.length;X++)$=q[X],W+=$.size||($.size=oX($));return W}var WW=class q extends F1{expandFields(){if(!this.version)this.version={};if(!this.version.serial&&this.serial)this.version.serial=this.serial;if(!this.version.timestamp&&this.timestamp)this.version.timestamp=this.timestamp;if(!this.annotations)this.annotations={summary:{}};else if(!this.annotations.summary)this.annotations.summary={};if(this.annotations&&this.annotations.summary){for(let[$,W]of Object.entries(this.annotations.summary))if($.endsWith(":distinct.v1")||$.endsWith(":unique.v1")||$.endsWith(":multiple.v1")){for(let[,X]of Object.entries(W))if(!X.clipped)X.clipped=!1}else if($.endsWith(":flag.v1")){if(!W.clipped)W.clipped=!1}}}async encode($){let W=Object.assign(new u1,this,{action:r8.indexOf(this.action||"message.create")});return Z$(W,$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((W)=>q.fromValues(W))}toString(){return B1(this,"Message")}},u1=class q extends F1{toJSON(...$){return G$.call(this,...$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((W)=>q.fromValues(W))}async decodeWithErr($,W){let X=Object.assign(new WW,E(P({},this),{action:fX(this.action)})),G;try{await X$(X,$)}catch(J){H.logAction(W,H.LOG_ERROR,"WireMessage.decode()",H0(J)),G=J}return X.expandFields(),{decoded:X,err:G}}async decode($,W){let{decoded:X}=await this.decodeWithErr($,W);return X}toString(){return B1(this,"WireMessage")}},s0=WW,_X=9;function lX(q){return q.every(function($){return!$.id})}var tX=class{constructor(q,$,W){this._annotations=null;var X,G;if(H.logAction(q.logger,H.LOG_MINOR,"RestChannel()","started; name = "+$),this.name=$,this.client=q,this.presence=new xX(this),this.channelOptions=Nq((X=q._Crypto)!=null?X:null,this.logger,W),(G=q.options.plugins)==null?void 0:G.Push)this._push=new q.options.plugins.Push.PushChannel(this);if(q._Annotations)this._annotations=new q._Annotations.RestAnnotations(this)}get annotations(){if(!this._annotations)L0("Annotations");return this._annotations}get push(){if(!this._push)L0("Push");return this._push}get logger(){return this.client.logger}setOptions(q){var $;this.channelOptions=Nq(($=this.client._Crypto)!=null?$:null,this.logger,q)}async history(q){return H.logAction(this.logger,H.LOG_MICRO,"RestChannel.history()","channel = "+this.name),this.client.rest.channelMixin.history(this,q)}async publish(...q){let $=q[0],W=q[1],X,G;if(typeof $==="string"||$===null)X=[s0.fromValues({name:$,data:W})],G=q[2];else if(l0($))X=[s0.fromValues($)],G=q[1];else if(Array.isArray($))X=s0.fromValuesArray($),G=q[1];else throw new K("The single-argument form of publish() expects a message object or an array of message objects",40013,400);if(!G)G={};let J=this.client,N=J.options,Q=N.useBinaryProtocol?"msgpack":"json",F=J.options.idempotentRestPublishing,B=o.defaultPostHeaders(J.options);if(p(B,N.headers),F&&lX(X)){let R=await z8(_X);X.forEach(function(d,g){d.id=R+":"+g.toString()})}let Y=await qW(X,this.channelOptions),M=J$(Y),S=N.maxMessageSize;if(M>S)throw new K(`Maximum size of messages that can be published at once exceeded (was ${M} bytes; limit is ${S} bytes)`,40009,400);await this._publish($W(Y,J._MsgPack,Q),B,G)}async _publish(q,$,W){await D0.post(this.client,this.client.rest.channelMixin.basePath(this)+"/messages",q,$,W,null,!0)}async status(){return this.client.rest.channelMixin.status(this)}async getMessage(q){return H.logAction(this.logger,H.LOG_MICRO,"RestChannel.getMessage()","channel = "+this.name),this.client.rest.channelMixin.getMessage(this,q)}async updateMessage(q,$,W){return H.logAction(this.logger,H.LOG_MICRO,"RestChannel.updateMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!1},q,$,W)}async deleteMessage(q,$,W){return H.logAction(this.logger,H.LOG_MICRO,"RestChannel.deleteMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!0},q,$,W)}async getMessageVersions(q,$){return H.logAction(this.logger,H.LOG_MICRO,"RestChannel.getMessageVersions()","channel = "+this.name),this.client.rest.channelMixin.getMessageVersions(this,q,$)}},rX=tX,sX=class q{constructor($){this.entries=$&&$.entries||void 0,this.schema=$&&$.schema||void 0,this.appId=$&&$.appId||void 0,this.inProgress=$&&$.inProgress||void 0,this.unit=$&&$.unit||void 0,this.intervalId=$&&$.intervalId||void 0}static fromValues($){return new q($)}},aX=sX,ZW=class{static basePath(q){return"/channels/"+encodeURIComponent(q.name)}static history(q,$){let W=q.client,X=W.options.useBinaryProtocol?"msgpack":"json",G=q.client.http.supportsLinkHeaders?void 0:X,J=o.defaultGetHeaders(W.options);return p(J,W.options.headers),new p0(W,this.basePath(q)+"/messages",J,G,async function(N,Q,F){let B=F?N:j0(N,W._MsgPack,X);return e8(B,q)}).get($)}static async status(q){let $=q.client.options.useBinaryProtocol?"msgpack":"json",W=o.defaultPostHeaders(q.client.options);return(await D0.get(q.client,this.basePath(q),W,{},$,!0)).body}static async getMessage(q,$){let W=typeof $==="string"?$:$.serial;if(!W)throw new K('This message lacks a serial. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let X=q.client,G=X.options.useBinaryProtocol?"msgpack":"json",J=o.defaultGetHeaders(X.options);p(J,X.options.headers);let{body:N,unpacked:Q}=await D0.get(X,this.basePath(q)+"/messages/"+encodeURIComponent(W),J,{},null,!0),F=Q?N:j0(N,X._MsgPack,G);return a8(F,q)}static async updateDeleteMessage(q,$,W,X,G){if(!W.serial)throw new K('This message lacks a serial and cannot be updated. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let J=q.client,N=J.options.useBinaryProtocol?"msgpack":"json",Q=o.defaultPostHeaders(J.options);p(Q,J.options.headers);let F=null;if(W.data!==void 0)F=await s0.fromValues(W).encode(q.channelOptions);let B={serial:W.serial,operation:X,name:W.name,data:F&&F.data,encoding:F&&F.encoding,extras:W.extras},Y=$W(B,J._MsgPack,N),M=$.isDelete?D0.post:D0.patch,S=$.isDelete?"/delete":"";await M(J,this.basePath(q)+"/messages/"+encodeURIComponent(W.serial)+S,Y,Q,G||{},null,!0)}static getMessageVersions(q,$,W){let X=typeof $==="string"?$:$.serial;if(!X)throw new K('This message lacks a serial. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let G=q.client,J=G.options.useBinaryProtocol?"msgpack":"json",N=q.client.http.supportsLinkHeaders?void 0:J,Q=o.defaultGetHeaders(G.options);return p(Q,G.options.headers),new p0(G,this.basePath(q)+"/messages/"+encodeURIComponent(X)+"/versions",Q,N,async(F,B,Y)=>{let M=Y?F:j0(F,G._MsgPack,J);return e8(M,q)}).get(W||{})}},eX=class{static basePath(q){return ZW.basePath(q.channel)+"/presence"}static async history(q,$){let W=q.channel.client,X=W.options.useBinaryProtocol?"msgpack":"json",G=q.channel.client.http.supportsLinkHeaders?void 0:X,J=o.defaultGetHeaders(W.options);return p(J,W.options.headers),new p0(W,this.basePath(q)+"/history",J,G,async(N,Q,F)=>{let B=F?N:j0(N,W._MsgPack,X);return l8(B,q.channel)}).get($)}},XW=class{constructor(q){this.channelMixin=ZW,this.presenceMixin=eX,this.Resource=D0,this.PaginatedResource=p0,this.DeviceDetails=K1,this.PushChannelSubscription=Bq,this.client=q,this.channels=new qG(this.client),this.push=new mX(this.client)}async stats(q){let $=o.defaultGetHeaders(this.client.options),W=this.client.options.useBinaryProtocol?"msgpack":"json",X=this.client.http.supportsLinkHeaders?void 0:W;return p($,this.client.options.headers),new p0(this.client,"/stats",$,X,async(G,J,N)=>{let Q=N?G:j0(G,this.client._MsgPack,W);for(let F=0;F<Q.length;F++)Q[F]=aX.fromValues(Q[F]);return Q}).get(q)}async time(q){let $=o.defaultGetHeaders(this.client.options,{format:"json"});if(this.client.options.headers)p($,this.client.options.headers);let W=(Q)=>{return this.client.baseUri(Q)+"/time"},{error:X,body:G,unpacked:J}=await this.client.http.do(N0.Get,W,$,null,q);if(X)throw X;if(!J)G=JSON.parse(G);let N=G[0];if(!N)throw new K("Internal error (unexpected result type from GET /time)",50000,500);return this.client.serverTimeOffset=N-Date.now(),N}async request(q,$,W,X,G,J){var N;let[Q,F,B]=(()=>{if(this.client.options.useBinaryProtocol){if(!this.client._MsgPack)L0("MsgPack");return[this.client._MsgPack.encode,this.client._MsgPack.decode,"msgpack"]}else return[JSON.stringify,JSON.parse,"json"]})(),Y=this.client.http.supportsLinkHeaders?void 0:B;X=X||{};let M=q.toLowerCase(),S=M=="get"?o.defaultGetHeaders(this.client.options,{format:B,protocolVersion:W}):o.defaultPostHeaders(this.client.options,{format:B,protocolVersion:W});if(typeof G!=="string")G=(N=Q(G))!=null?N:null;if(p(S,this.client.options.headers),J)p(S,J);let R=new p0(this.client,$,S,Y,async function(d,g,t){return Q1(t?d:F(d))},!0);if(!j.Http.methods.includes(M))throw new K("Unsupported method "+M,40500,405);if(j.Http.methodsWithBody.includes(M))return R[M](X,G);else return R[M](X)}async batchPublish(q){let $,W;if(Array.isArray(q))$=q,W=!1;else $=[q],W=!0;let X=this.client.options.useBinaryProtocol?"msgpack":"json",G=o.defaultPostHeaders(this.client.options);if(this.client.options.headers)p(G,this.client.options.headers);let J=i0($,this.client._MsgPack,X),N=await D0.post(this.client,"/messages",J,G,{},null,!0),Q=N.unpacked?N.body:j0(N.body,this.client._MsgPack,X);if(W)return Q[0];else return Q}async batchPresence(q){let $=this.client.options.useBinaryProtocol?"msgpack":"json",W=o.defaultGetHeaders(this.client.options);if(this.client.options.headers)p(W,this.client.options.headers);let X=q.join(","),G=await D0.get(this.client,"/presence",W,{channels:X},null,!0);return G.unpacked?G.body:j0(G.body,this.client._MsgPack,$)}async revokeTokens(q,$){if(k8(this.client.options))throw new K("Cannot revoke tokens when using token auth",40162,401);let W=this.client.options.keyName,X=$!=null?$:{},G=P({targets:q.map((B)=>`${B.type}:${B.value}`)},X),J=this.client.options.useBinaryProtocol?"msgpack":"json",N=o.defaultPostHeaders(this.client.options);if(this.client.options.headers)p(N,this.client.options.headers);let Q=i0(G,this.client._MsgPack,J),F=await D0.post(this.client,`/keys/${W}/revokeTokens`,Q,N,{},null,!0);return F.unpacked?F.body:j0(F.body,this.client._MsgPack,J)}},qG=class{constructor(q){this.client=q,this.all=Object.create(null)}get(q,$){q=String(q);let W=this.all[q];if(!W)this.all[q]=W=new rX(this.client,q,$);else if($)W.setOptions($);return W}release(q){delete this.all[String(q)]}},$G=class extends c8{constructor(q){super(o.objectifyOptions(q,!1,"BaseRest",H.defaultLogger,{Rest:XW}))}},GW={Rest:XW},JW=class extends s0{static async fromEncoded(q,$){return s8(H.defaultLogger,j.Crypto,q,$)}static async fromEncodedArray(q,$){return nX(H.defaultLogger,j.Crypto,q,$)}static fromValues(q){return s0.fromValues(q)}},HW=class extends r0{static async fromEncoded(q,$){return _8(H.defaultLogger,j.Crypto,q,$)}static async fromEncodedArray(q,$){return pX(H.defaultLogger,j.Crypto,q,$)}static fromValues(q){return r0.fromValues(q)}},UW=["annotation.create","annotation.delete"];async function VW(q,$,W){return j1.fromValues($).decode(W||{},q)}async function WG(q,$,W){return Promise.all($.map(function(X){return VW(q,X,W)}))}async function ZG(q,$){return j1.fromValues(q).decode($.channelOptions,$.logger)}async function XG(q,$){return Promise.all(q.map(function(W){return ZG(W,$)}))}var zW=class q extends F1{async encode(){let $=Object.assign(new j1,this,{action:UW.indexOf(this.action||"annotation.create")});return Z$($,{})}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((W)=>q.fromValues(W))}toString(){return B1(this,"Annotation")}},j1=class q extends F1{toJSON(...$){return G$.call(this,...$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((W)=>q.fromValues(W))}async decode($,W){let X=Object.assign(new zW,E(P({},this),{action:UW[this.action]}));try{await X$(X,$)}catch(G){H.logAction(W,H.LOG_ERROR,"WireAnnotation.decode()",H0(G))}return X}toString(){return B1(this,"WireAnnotation")}},L1=zW,DW=class extends L1{static async fromEncoded(q,$){return VW(H.defaultLogger,q,$)}static async fromEncodedArray(q,$){return WG(H.defaultLogger,q,$)}static fromValues(q){return L1.fromValues(q)}};function NW(q){let $;switch(typeof q){case"string":$=q;break;case"object":$=q.serial;break}if(!$||typeof $!=="string")throw new K("First argument of annotations.publish() must be either a Message (or at least an object with a string `serial` property) or a message serial (string)",40003,400);return $}function OW(q,$){let W=NW(q);if(!$||typeof $!=="object")throw new K("Second argument of annotations.publish() must be an object (the intended annotation to publish)",40003,400);let X=L1.fromValues($);if(X.messageSerial=W,!X.action)X.action="annotation.create";return X}function QW(q,$){return q.client.rest.channelMixin.basePath(q)+"/messages/"+encodeURIComponent($)+"/annotations"}var GG=class{constructor(q){this.channel=q}async publish(q,$){let W=OW(q,$),X=await W.encode(),G=this.channel.client,J=G.options,N=J.useBinaryProtocol?"msgpack":"json",Q=o.defaultPostHeaders(G.options),F={};p(Q,G.options.headers);let B=i0([X],G._MsgPack,N);await D0.post(G,QW(this.channel,W.messageSerial),B,Q,F,null,!0)}async delete(q,$){return $.action="annotation.delete",this.publish(q,$)}async get(q,$){let W=this.channel.client,X=NW(q),G=W.options.useBinaryProtocol?"msgpack":"json",J=W.http.supportsLinkHeaders?void 0:G,N=o.defaultGetHeaders(W.options);return p(N,W.options.headers),new p0(W,QW(this.channel,X),N,J,async(Q,F,B)=>{let Y=B?Q:j0(Q,W._MsgPack,G);return XG(Y,this.channel)}).get($)}},Fq=GG,JG=i0;function Kq(q){let $=[];if(q)for(let W=0;W<q.length;W++)$.push(q[W].toString());return"[ "+$.join(", ")+" ]"}function HG(q,$,W,X,G,J){let N=j0(q,$,J);return H$(N,W,X,G)}function H$(q,$,W,X){let G;if(q.error)G=K.fromValues(q.error);let J;if(q.messages)J=u1.fromValuesArray(q.messages);let N;if($&&q.presence)N=$.WirePresenceMessage.fromValuesArray(q.presence);let Q;if(W&&q.annotations)Q=W.WireAnnotation.fromValuesArray(q.annotations);let F;if(X&&q.state)F=X.WireObjectMessage.fromValuesArray(q.state,G0,Qq);return Object.assign(new V$,E(P({},q),{presence:N,messages:J,annotations:Q,state:F,error:G}))}function wW(q){return($)=>{var W;return H$($,{PresenceMessage:r0,WirePresenceMessage:k1},{Annotation:L1,WireAnnotation:j1,RealtimeAnnotations:D$,RestAnnotations:Fq},(W=q==null?void 0:q.ObjectsPlugin)!=null?W:null)}}function E0(q){return Object.assign(new V$,q)}function U$(q,$,W,X){let G="[ProtocolMessage";if(q.action!==void 0)G+="; action="+u8[q.action]||q.action;let J=["id","channel","channelSerial","connectionId","count","msgSerial","timestamp"],N;for(let Q=0;Q<J.length;Q++)if(N=J[Q],q[N]!==void 0)G+="; "+N+"="+q[N];if(q.messages)G+="; messages="+Kq(u1.fromValuesArray(q.messages));if(q.presence&&$)G+="; presence="+Kq($.WirePresenceMessage.fromValuesArray(q.presence));if(q.annotations&&W)G+="; annotations="+Kq(W.WireAnnotation.fromValuesArray(q.annotations));if(q.state&&X)G+="; state="+Kq(X.WireObjectMessage.fromValuesArray(q.state,G0,Qq));if(q.error)G+="; error="+K.fromValues(q.error).toString();if(q.auth&&q.auth.accessToken)G+="; token="+q.auth.accessToken;if(q.flags)G+="; flags="+YX.filter(q.hasFlag).join(",");if(q.params){let Q="";if(G8(q.params,function(F){if(Q.length>0)Q+="; ";Q+=F+"="+q.params[F]}),Q.length>0)G+="; params=["+Q+"]"}return G+="]",G}var V$=class{constructor(){this.hasFlag=(q)=>{return(this.flags&A0[q])>0}}setFlag(q){return this.flags=this.flags|A0[q]}getMode(){return(this.flags||0)&A0.MODE_ALL}encodeModesToFlags(q){q.forEach(($)=>this.setFlag($))}decodeModesFromFlags(){let q=[];return y8.forEach(($)=>{if(this.hasFlag($))q.push($)}),q.length>0?q:void 0}},UG=V$,VG=class{constructor(q,$,W,X,G){if(this.previous=q,this.current=$,$==="attached")this.resumed=W,this.hasBacklog=X;if(G)this.reason=G}},z$=VG,BW=function(){};function zG(q){if(q&&"params"in q&&!l0(q.params))return new K("options.params must be an object",40000,400);if(q&&"modes"in q){if(!Array.isArray(q.modes))return new K("options.modes must be an array",40000,400);for(let $=0;$<q.modes.length;$++){let W=q.modes[$];if(!W||typeof W!=="string"||!y8.includes(String.prototype.toUpperCase.call(W)))return new K("Invalid channel mode: "+W,40000,400)}}}var DG=class q extends B0{constructor($,W,X){var G,J,N;super($.logger);if(this._annotations=null,this._mode=0,this.retryCount=0,this.history=async function(Q){H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name);let F=this.client.rest.channelMixin;if(Q&&Q.untilAttach){if(this.state!=="attached")throw new K("option untilAttach requires the channel to be attached",40000,400);if(!this.properties.attachSerial)throw new K("untilAttach was specified and channel is attached, but attachSerial is not defined",40000,400);delete Q.untilAttach,Q.from_serial=this.properties.attachSerial}return F.history(this,Q)},this.whenState=(Q)=>{return B0.prototype.whenState.call(this,Q,this.state)},H.logAction(this.logger,H.LOG_MINOR,"RealtimeChannel()","started; name = "+W),this.name=W,this.channelOptions=Nq((G=$._Crypto)!=null?G:null,this.logger,X),this.client=$,this._presence=$._RealtimePresence?new $._RealtimePresence.RealtimePresence(this):null,$._Annotations)this._annotations=new $._Annotations.RealtimeAnnotations(this);if(this.connectionManager=$.connection.connectionManager,this.state="initialized",this.subscriptions=new B0(this.logger),this.syncChannelSerial=void 0,this.properties={attachSerial:void 0,channelSerial:void 0},this.setOptions(X),this.errorReason=null,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:$.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new B0(this.logger),(J=$.options.plugins)==null?void 0:J.Push)this._push=new $.options.plugins.Push.PushChannel(this);if((N=$.options.plugins)==null?void 0:N.Objects)this._objects=new $.options.plugins.Objects.Objects(this)}get presence(){if(!this._presence)L0("RealtimePresence");return this._presence}get annotations(){if(!this._annotations)L0("Annotations");return this._annotations}get push(){if(!this._push)L0("Push");return this._push}get objects(){if(!this._objects)L0("Objects");return this._objects}invalidStateError(){return new K("Channel operation failed as channel state is "+this.state,90001,400,this.errorReason||void 0)}static processListenerArgs($){if($=Array.prototype.slice.call($),typeof $[0]==="function")$.unshift(null);return $}async setOptions($){var W;let X=this.channelOptions,G=zG($);if(G)throw G;if(this.channelOptions=Nq((W=this.client._Crypto)!=null?W:null,this.logger,$),this._decodingContext)this._decodingContext.channelOptions=this.channelOptions;if(this._shouldReattachToSetOptions($,X))return this.attachImpl(),new Promise((J,N)=>{this._allChannelChanges.once(["attached","update","detached","failed"],function(Q){switch(this.event){case"update":case"attached":J();break;default:N(Q.reason)}})})}_shouldReattachToSetOptions($,W){if(!(this.state==="attached"||this.state==="attaching"))return!1;if($==null?void 0:$.params){let X=FW($.params),G=FW(W.params);if(Object.keys(X).length!==Object.keys(G).length)return!0;if(!w8(G,X))return!0}if($==null?void 0:$.modes){if(!W.modes||!F8($.modes,W.modes))return!0}return!1}async publish(...$){let W;if($.length==1)if(l0($[0]))W=[s0.fromValues($[0])];else if(Array.isArray($[0]))W=s0.fromValuesArray($[0]);else throw new K("The single-argument form of publish() expects a message object or an array of message objects",40013,400);else W=[s0.fromValues({name:$[0],data:$[1]})];let G=this.client.options.maxMessageSize,J=await qW(W,this.channelOptions),N=J$(J);if(N>G)throw new K(`Maximum size of messages that can be published at once exceeded (was ${N} bytes; limit is ${G} bytes)`,40009,400);this.throwIfUnpublishableState(),H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+this.state+", message count = "+J.length);let Q=E0({action:c.MESSAGE,channel:this.name,messages:J});return this.sendMessage(Q)}throwIfUnpublishableState(){if(!this.connectionManager.activeState())throw this.connectionManager.getError();if(this.state==="failed"||this.state==="suspended")throw this.invalidStateError()}onEvent($){H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.onEvent()","received message");let W=this.subscriptions;for(let X=0;X<$.length;X++){let G=$[X];W.emit(G.name,G)}}async attach(){if(this.state==="attached")return null;return new Promise(($,W)=>{this._attach(!1,null,(X,G)=>X?W(X):$(G))})}_attach($,W,X){if(!X)X=(J)=>{if(J)H.logAction(this.logger,H.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+J.toString())};let G=this.connectionManager;if(!G.activeState()){X(G.getError());return}if(this.state!=="attaching"||$)this.requestState("attaching",W);this.once(function(J){switch(this.event){case"attached":X==null||X(null,J);break;case"detached":case"suspended":case"failed":X==null||X(J.reason||G.getError()||new K("Unable to attach; reason unknown; state = "+this.event,90000,500));break;case"detaching":X==null||X(new K("Attach request superseded by a subsequent detach request",90000,409));break}})}attachImpl(){H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");let $=E0({action:c.ATTACH,channel:this.name,params:this.channelOptions.params,channelSerial:this.properties.channelSerial});if(this.channelOptions.modes)$.encodeModesToFlags(N8(this.channelOptions.modes));if(this._attachResume)$.setFlag("ATTACH_RESUME");if(this._lastPayload.decodeFailureRecoveryInProgress)$.channelSerial=this._lastPayload.protocolMessageChannelSerial;this.sendMessage($).catch(BW)}async detach(){let $=this.connectionManager;if(!$.activeState())throw $.getError();switch(this.state){case"suspended":this.notifyState("detached");return;case"detached":return;case"failed":throw new K("Unable to detach; channel state = failed",90001,400);default:this.requestState("detaching");case"detaching":return new Promise((W,X)=>{this.once(function(G){switch(this.event){case"detached":W();break;case"attached":case"suspended":case"failed":X(G.reason||$.getError()||new K("Unable to detach; reason unknown; state = "+this.event,90000,500));break;case"attaching":X(new K("Detach request superseded by a subsequent attach request",90000,409));break}})})}}detachImpl(){H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");let $=E0({action:c.DETACH,channel:this.name});this.sendMessage($).catch(BW)}async subscribe(...$){let[W,X]=q.processListenerArgs($);if(this.state==="failed")throw K.fromValues(this.invalidStateError());if(W&&typeof W==="object"&&!Array.isArray(W))this.client._FilteredSubscriptions.subscribeFilter(this,W,X);else this.subscriptions.on(W,X);if(this.channelOptions.attachOnSubscribe!==!1)return this.attach();else return null}unsubscribe(...$){var W;let[X,G]=q.processListenerArgs($);if(typeof X==="object"&&!G||((W=this.filteredSubscriptions)==null?void 0:W.has(G))){this.client._FilteredSubscriptions.getAndDeleteFilteredSubscriptions(this,X,G).forEach((J)=>this.subscriptions.off(J));return}this.subscriptions.off(X,G)}sync(){switch(this.state){case"initialized":case"detaching":case"detached":throw new s("Unable to sync to channel; not attached",40000);default:}let $=this.connectionManager;if(!$.activeState())throw $.getError();let W=E0({action:c.SYNC,channel:this.name});if(this.syncChannelSerial)W.channelSerial=this.syncChannelSerial;$.send(W)}async sendMessage($){return new Promise((W,X)=>{this.connectionManager.send($,this.client.options.queueMessages,(G)=>{if(G)X(G);else W()})})}async sendPresence($){let W=E0({action:c.PRESENCE,channel:this.name,presence:$});return this.sendMessage(W)}sendState($){let W=E0({action:c.OBJECT,channel:this.name,state:$});return this.sendMessage(W)}async processMessage($){if($.action===c.ATTACHED||$.action===c.MESSAGE||$.action===c.PRESENCE||$.action===c.OBJECT||$.action===c.ANNOTATION)this.setChannelSerial($.channelSerial);let W,X=!1;switch($.action){case c.ATTACHED:{this.properties.attachSerial=$.channelSerial,this._mode=$.getMode(),this.params=$.params||{};let G=$.decodeModesFromFlags();this.modes=G&&lq(G)||void 0;let J=$.hasFlag("RESUMED"),N=$.hasFlag("HAS_PRESENCE"),Q=$.hasFlag("HAS_BACKLOG"),F=$.hasFlag("HAS_OBJECTS");if(this.state==="attached"){if(!J){if(this._presence)this._presence.onAttached(N);if(this._objects)this._objects.onAttached(F)}let B=new z$(this.state,this.state,J,Q,$.error);if(this._allChannelChanges.emit("update",B),!J||this.channelOptions.updateOnAttached)this.emit("update",B)}else if(this.state==="detaching")this.checkPendingState();else this.notifyState("attached",$.error,J,N,Q,F);break}case c.DETACHED:{let G=$.error?K.fromValues($.error):new K("Channel detached",90001,404);if(this.state==="detaching")this.notifyState("detached",G);else if(this.state==="attaching")this.notifyState("suspended",G);else if(this.state==="attached"||this.state==="suspended")this.requestState("attaching",G);break}case c.SYNC:if(X=!0,W=this.syncChannelSerial=$.channelSerial,!$.presence)break;case c.PRESENCE:{if(!$.presence)break;wq($);let G=this.channelOptions;if(this._presence){let J=await Promise.all($.presence.map((N)=>{return N.decode(G,this.logger)}));this._presence.setPresence(J,X,W)}break}case c.OBJECT:case c.OBJECT_SYNC:{if(!this._objects||!$.state)return;wq($);let G=this.client.connection.connectionManager.getActiveTransportFormat(),J=$.state.map((N)=>N.decode(this.client,G));if($.action===c.OBJECT)this._objects.handleObjectMessages(J);else this._objects.handleObjectSyncMessages(J,$.channelSerial);break}case c.MESSAGE:{if(this.state!=="attached"){H.logAction(this.logger,H.LOG_MAJOR,"RealtimeChannel.processMessage()",'Message "'+$.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');return}wq($);let G=$.messages,J=G[0],N=G[G.length-1];if(J.extras&&J.extras.delta&&J.extras.delta.from!==this._lastPayload.messageId){let F='Delta message decode failure - previous message not available for message "'+$.id+'" on this channel "'+this.name+'".';H.logAction(this.logger,H.LOG_ERROR,"RealtimeChannel.processMessage()",F),this._startDecodeFailureRecovery(new K(F,40018,400));break}let Q=[];for(let F=0;F<G.length;F++){let{decoded:B,err:Y}=await G[F].decodeWithErr(this._decodingContext,this.logger);if(Q[F]=B,Y)switch(Y.code){case 40018:this._startDecodeFailureRecovery(Y);return;case 40019:case 40021:this.notifyState("failed",Y);return;default:}}this._lastPayload.messageId=N.id,this._lastPayload.protocolMessageChannelSerial=$.channelSerial,this.onEvent(Q);break}case c.ANNOTATION:{wq($);let G=this.channelOptions;if(this._annotations){let J=await Promise.all(($.annotations||[]).map((N)=>{return N.decode(G,this.logger)}));this._annotations._processIncoming(J)}break}case c.ERROR:{let G=$.error;if(G&&G.code==80016)this.checkPendingState();else this.notifyState("failed",K.fromValues(G));break}default:H.logAction(this.logger,H.LOG_MAJOR,"RealtimeChannel.processMessage()","Protocol error: unrecognised message action ("+$.action+")")}}_startDecodeFailureRecovery($){if(!this._lastPayload.decodeFailureRecoveryInProgress)H.logAction(this.logger,H.LOG_MAJOR,"RealtimeChannel.processMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,$,()=>{this._lastPayload.decodeFailureRecoveryInProgress=!1})}onAttached(){H.logAction(this.logger,H.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)}notifyState($,W,X,G,J,N){if(H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+$),this.clearStateTimer(),["detached","suspended","failed"].includes($))this.properties.channelSerial=null;if($===this.state)return;if(this._presence)this._presence.actOnChannelState($,G,W);if(this._objects)this._objects.actOnChannelState($,N);if($==="suspended"&&this.connectionManager.state.sendEvents)this.startRetryTimer();else this.cancelRetryTimer();if(W)this.errorReason=W;let Q=new z$(this.state,$,X,J,W),F='Channel state for channel "'+this.name+'"',B=$+(W?"; reason: "+W:"");if($==="failed")H.logAction(this.logger,H.LOG_ERROR,F,B);else H.logAction(this.logger,H.LOG_MAJOR,F,B);if($!=="attaching"&&$!=="suspended")this.retryCount=0;if($==="attached")this.onAttached();if($==="attached")this._attachResume=!0;else if($==="detaching"||$==="failed")this._attachResume=!1;this.state=$,this._allChannelChanges.emit($,Q),this.emit($,Q)}requestState($,W){H.logAction(this.logger,H.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+$),this.notifyState($,W),this.checkPendingState()}checkPendingState(){if(!this.connectionManager.state.sendEvents){H.logAction(this.logger,H.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state);return}switch(H.logAction(this.logger,H.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync();break;default:break}}timeoutPendingState(){switch(this.state){case"attaching":{let $=new K("Channel attach timed out",90007,408);this.notifyState("suspended",$);break}case"detaching":{let $=new K("Channel detach timed out",90007,408);this.notifyState("attached",$);break}default:this.checkPendingState();break}}startStateTimerIfNotRunning(){if(!this.stateTimer)this.stateTimer=setTimeout(()=>{H.logAction(this.logger,H.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),this.stateTimer=null,this.timeoutPendingState()},this.client.options.timeouts.realtimeRequestTimeout)}clearStateTimer(){let $=this.stateTimer;if($)clearTimeout($),this.stateTimer=null}startRetryTimer(){if(this.retryTimer)return;this.retryCount++;let $=tq(this.client.options.timeouts.channelRetryTimeout,this.retryCount);this.retryTimer=setTimeout(()=>{if(this.state==="suspended"&&this.connectionManager.state.sendEvents)this.retryTimer=null,H.logAction(this.logger,H.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),this.requestState("attaching")},$)}cancelRetryTimer(){if(this.retryTimer)clearTimeout(this.retryTimer),this.retryTimer=null}getReleaseErr(){let $=this.state;if($==="initialized"||$==="detached"||$==="failed")return null;return new K("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+$,90001,400)}setChannelSerial($){if(H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.setChannelSerial()","Updating channel serial; serial = "+$+"; previous = "+this.properties.channelSerial),$)this.properties.channelSerial=$}async status(){return this.client.rest.channelMixin.status(this)}async getMessage($){return H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.getMessage()","channel = "+this.name),this.client.rest.channelMixin.getMessage(this,$)}async updateMessage($,W,X){return H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.updateMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!1},$,W,X)}async deleteMessage($,W,X){return H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.deleteMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!0},$,W,X)}async getMessageVersions($,W){return H.logAction(this.logger,H.LOG_MICRO,"RealtimeChannel.getMessageVersions()","channel = "+this.name),this.client.rest.channelMixin.getMessageVersions(this,$,W)}};function FW(q){let $=q||{},{agent:W}=$;return m($,["agent"])}var y1=DG,NG=class{constructor(q){this.channel=q,this.logger=q.logger,this.subscriptions=new B0(this.logger)}async publish(q,$){let W=this.channel.name,X=OW(q,$),G=await X.encode();this.channel.throwIfUnpublishableState(),H.logAction(this.logger,H.LOG_MICRO,"RealtimeAnnotations.publish()","channelName = "+W+", sending annotation with messageSerial = "+X.messageSerial+", type = "+X.type);let J=E0({action:c.ANNOTATION,channel:W,annotations:[G]});return this.channel.sendMessage(J)}async delete(q,$){return $.action="annotation.delete",this.publish(q,$)}async subscribe(...q){let $=y1.processListenerArgs(q),W=$[0],X=$[1],G=this.channel;if(G.state==="failed")throw K.fromValues(G.invalidStateError());if(this.subscriptions.on(W,X),this.channel.channelOptions.attachOnSubscribe!==!1)await G.attach();if((this.channel.state==="attached"&&this.channel._mode&A0.ANNOTATION_SUBSCRIBE)===0)throw new K("You are trying to add an annotation listener, but you haven't requested the annotation_subscribe channel mode in ChannelOptions, so this won't do anything (we only deliver annotations to clients who have explicitly requested them)",93001,400)}unsubscribe(...q){let $=y1.processListenerArgs(q),W=$[0],X=$[1];this.subscriptions.off(W,X)}_processIncoming(q){for(let $ of q)this.subscriptions.emit($.type||"",$)}async get(q,$){return Fq.prototype.get.call(this,q,$)}},D$=NG,Z1=class q extends $G{constructor($){var W,X;if(!q._MsgPack)throw Error("Expected DefaultRest._MsgPack to have been set");super(o.objectifyOptions($,!0,"Rest",H.defaultLogger,E(P({},GW),{Crypto:(W=q.Crypto)!=null?W:void 0,MsgPack:(X=q._MsgPack)!=null?X:void 0,Annotations:{Annotation:L1,WireAnnotation:j1,RealtimeAnnotations:D$,RestAnnotations:Fq}})))}static get Crypto(){if(this._Crypto===null)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto($){this._Crypto=$}};Z1._Crypto=null,Z1.Message=JW,Z1.PresenceMessage=HW,Z1.Annotation=DW,Z1._MsgPack=null,Z1._Http=$$;var N$=Z1,OG=class extends B0{constructor(q){super(q);this.messages=[]}count(){return this.messages.length}push(q){this.messages.push(q)}shift(){return this.messages.shift()}last(){return this.messages[this.messages.length-1]}copyAll(){return this.messages.slice()}append(q){this.messages.push.apply(this.messages,q)}prepend(q){this.messages.unshift.apply(this.messages,q)}completeMessages(q,$,W){H.logAction(this.logger,H.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+q+"; count = "+$),W=W||null;let X=this.messages;if(X.length===0)throw Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");let G=X[0];if(G){let J=G.message.msgSerial,N=q+$;if(N>J){let Q=X.splice(0,N-J);for(let F of Q)F.callback(W)}if(X.length==0)this.emit("idle")}}completeAllMessages(q){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,q)}resetSendAttempted(){for(let q of this.messages)q.sendAttempted=!1}clear(){H.logAction(this.logger,H.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")}},KW=OG,jW=class{constructor(q,$){this.message=q,this.callback=$,this.merged=!1;let W=q.action;this.sendAttempted=!1,this.ackRequired=typeof W==="number"&&[c.MESSAGE,c.PRESENCE,c.ANNOTATION,c.OBJECT].includes(W)}},QG=class extends B0{constructor(q){super(q.logger);this.transport=q,this.messageQueue=new KW(this.logger),q.on("ack",($,W)=>{this.onAck($,W)}),q.on("nack",($,W,X)=>{this.onNack($,W,X)})}onAck(q,$){H.logAction(this.logger,H.LOG_MICRO,"Protocol.onAck()","serial = "+q+"; count = "+$),this.messageQueue.completeMessages(q,$)}onNack(q,$,W){if(H.logAction(this.logger,H.LOG_ERROR,"Protocol.onNack()","serial = "+q+"; count = "+$+"; err = "+H0(W)),!W)W=new K("Unable to send message; channel not responding",50001,500);this.messageQueue.completeMessages(q,$,W)}onceIdle(q){let $=this.messageQueue;if($.count()===0){q();return}$.once("idle",q)}send(q){if(q.ackRequired)this.messageQueue.push(q);if(this.logger.shouldLog(H.LOG_MICRO))H.logActionNoStrip(this.logger,H.LOG_MICRO,"Protocol.send()","sending msg; "+U$(q.message,this.transport.connectionManager.realtime._RealtimePresence,this.transport.connectionManager.realtime._Annotations,this.transport.connectionManager.realtime._objectsPlugin));q.sendAttempted=!0,this.transport.send(q.message)}getTransport(){return this.transport}getPendingMessages(){return this.messageQueue.copyAll()}clearPendingMessages(){return this.messageQueue.clear()}finish(){let q=this.transport;this.onceIdle(function(){q.disconnect()})}},wG=QG,BG=class{constructor(q,$,W,X){if(this.previous=q,this.current=$,W)this.retryIn=W;if(X)this.reason=X}},jq=BG,q1={DISCONNECTED:80003,SUSPENDED:80002,FAILED:80000,CLOSING:80017,CLOSED:80017,UNKNOWN_CONNECTION_ERR:50002,UNKNOWN_CHANNEL_ERR:50001},FG={disconnected:()=>K.fromValues({statusCode:400,code:q1.DISCONNECTED,message:"Connection to server temporarily unavailable"}),suspended:()=>K.fromValues({statusCode:400,code:q1.SUSPENDED,message:"Connection to server unavailable"}),failed:()=>K.fromValues({statusCode:400,code:q1.FAILED,message:"Connection failed or disconnected by server"}),closing:()=>K.fromValues({statusCode:400,code:q1.CLOSING,message:"Connection closing"}),closed:()=>K.fromValues({statusCode:400,code:q1.CLOSED,message:"Connection closed"}),unknownConnectionErr:()=>K.fromValues({statusCode:500,code:q1.UNKNOWN_CONNECTION_ERR,message:"Internal connection error"}),unknownChannelErr:()=>K.fromValues({statusCode:500,code:q1.UNKNOWN_CONNECTION_ERR,message:"Internal channel error"})};function KG(q){if(!q.statusCode||!q.code||q.statusCode>=500)return!0;return Object.values(q1).includes(q.code)}var X1=FG,jG=E0({action:c.CLOSE}),LG=E0({action:c.DISCONNECT}),IG=class extends B0{constructor(q,$,W,X){super(q.logger);if(X)W.format=void 0,W.heartbeats=!0;this.connectionManager=q,this.auth=$,this.params=W,this.timeouts=W.options.timeouts,this.format=W.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}connect(){}close(){if(this.isConnected)this.requestClose();this.finish("closed",X1.closed())}disconnect(q){if(this.isConnected)this.requestDisconnect();this.finish("disconnected",q||X1.disconnected())}fail(q){if(this.isConnected)this.requestDisconnect();this.finish("failed",q||X1.failed())}finish(q,$){var W;if(this.isFinished)return;this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout((W=this.idleTimer)!=null?W:void 0),this.idleTimer=null,this.emit(q,$),this.dispose()}onProtocolMessage(q){if(this.logger.shouldLog(H.LOG_MICRO))H.logActionNoStrip(this.logger,H.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+U$(q,this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin)+"; connectionId = "+this.connectionManager.connectionId);switch(this.onActivity(),q.action){case c.HEARTBEAT:H.logActionNoStrip(this.logger,H.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",q.id);break;case c.CONNECTED:this.onConnect(q),this.emit("connected",q.error,q.connectionId,q.connectionDetails,q);break;case c.CLOSED:this.onClose(q);break;case c.DISCONNECTED:this.onDisconnect(q);break;case c.ACK:this.emit("ack",q.msgSerial,q.count);break;case c.NACK:this.emit("nack",q.msgSerial,q.count,q.error);break;case c.SYNC:this.connectionManager.onChannelMessage(q,this);break;case c.ACTIVATE:break;case c.AUTH:S0(this.auth.authorize(),($)=>{if($)H.logAction(this.logger,H.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+H0($))});break;case c.ERROR:if(H.logAction(this.logger,H.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+j.Config.inspect(q.error)+(q.channel?", channel: "+q.channel:"")),q.channel===void 0){this.onFatalError(q);break}this.connectionManager.onChannelMessage(q,this);break;default:this.connectionManager.onChannelMessage(q,this)}}onConnect(q){if(this.isConnected=!0,!q.connectionDetails)throw Error("Transport.onConnect(): Connect message recieved without connectionDetails");let $=q.connectionDetails.maxIdleInterval;if($)this.maxIdleInterval=$+this.timeouts.realtimeRequestTimeout,this.onActivity()}onDisconnect(q){let $=q&&q.error;H.logAction(this.logger,H.LOG_MINOR,"Transport.onDisconnect()","err = "+H0($)),this.finish("disconnected",$)}onFatalError(q){let $=q&&q.error;H.logAction(this.logger,H.LOG_MINOR,"Transport.onFatalError()","err = "+H0($)),this.finish("failed",$)}onClose(q){let $=q&&q.error;H.logAction(this.logger,H.LOG_MINOR,"Transport.onClose()","err = "+H0($)),this.finish("closed",$)}requestClose(){H.logAction(this.logger,H.LOG_MINOR,"Transport.requestClose()",""),this.send(jG)}requestDisconnect(){H.logAction(this.logger,H.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(LG)}ping(q){let $={action:c.HEARTBEAT};if(q)$.id=q;this.send(E0($))}dispose(){H.logAction(this.logger,H.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()}onActivity(){if(!this.maxIdleInterval)return;this.lastActivity=this.connectionManager.lastActivity=Date.now(),this.setIdleTimer(this.maxIdleInterval+100)}setIdleTimer(q){if(!this.idleTimer)this.idleTimer=setTimeout(()=>{this.onIdleTimerExpire()},q)}onIdleTimerExpire(){if(!this.lastActivity||!this.maxIdleInterval)throw Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;let q=Date.now()-this.lastActivity,$=this.maxIdleInterval-q;if($<=0){let W="No activity seen from realtime in "+q+"ms; assuming connection has dropped";H.logAction(this.logger,H.LOG_ERROR,"Transport.onIdleTimerExpire()",W),this.disconnect(new K(W,80003,408))}else this.setIdleTimer($+100)}static tryConnect(q,$,W,X,G){let J=new q($,W,X),N,Q=function(B){clearTimeout(N),G({event:this.event,error:B})},F=$.options.timeouts.realtimeRequestTimeout;return N=setTimeout(()=>{J.off(["preconnect","disconnected","failed"]),J.dispose(),Q.call({event:"disconnected"},new K("Timeout waiting for transport to indicate itself viable",50000,500))},F),J.on(["failed","disconnected"],Q),J.on("preconnect",function(){H.logAction($.logger,H.LOG_MINOR,"Transport.tryConnect()","viable transport "+J),clearTimeout(N),J.off(["failed","disconnected"],Q),G(null,J)}),J.connect(),J}static isAvailable(){throw new K("isAvailable not implemented for transport",50000,500)}},I1=IG,R0;((q)=>{q.WebSocket="web_socket",q.Comet="comet",q.XhrPolling="xhr_polling"})(R0||(R0={}));var YG=typeof global<"u"?global:typeof window<"u"?window:self,O$=()=>{var q;return typeof j.WebStorage<"u"&&((q=j.WebStorage)==null?void 0:q.localSupported)},g1=()=>{var q;return typeof j.WebStorage<"u"&&((q=j.WebStorage)==null?void 0:q.sessionSupported)},LW=function(){},Q$="ably-transport-preference";function MG(q,$,W){let X;if(q.channel!==$.channel)return!1;if((X=q.action)!==c.PRESENCE&&X!==c.MESSAGE)return!1;if(X!==$.action)return!1;let G=X===c.PRESENCE?"presence":"messages",J=q[G].concat($[G]);if(J$(J)>W)return!1;if(!J8(J,"clientId"))return!1;if(!J.every(function(Q){return!Q.id}))return!1;return q[G]=J,!0}function w$(q){try{return JSON.parse(q)}catch($){return null}}var SG=class{constructor(q,$,W,X){this.options=q,this.host=$,this.mode=W,this.connectionKey=X,this.format=q.useBinaryProtocol?"msgpack":"json"}getConnectParams(q){let $=q?v0(q):{},W=this.options;switch(this.mode){case"resume":$.resume=this.connectionKey;break;case"recover":{let X=w$(W.recover);if(X)$.recover=X.connectionKey;break}default:}if(W.clientId!==void 0)$.clientId=W.clientId;if(W.echoMessages===!1)$.echo="false";if(this.format!==void 0)$.format=this.format;if(this.stream!==void 0)$.stream=this.stream;if(this.heartbeats!==void 0)$.heartbeats=this.heartbeats;if($.v=o.protocolVersion,$.agent=sq(this.options),W.transportParams!==void 0)p($,W.transportParams);return $}toString(){let q="[mode="+this.mode;if(this.host)q+=",host="+this.host;if(this.connectionKey)q+=",connectionKey="+this.connectionKey;if(this.format)q+=",format="+this.format;return q+="]",q}},AG=class q extends B0{constructor($,W){super($.logger);this.supportedTransports={},this.disconnectedRetryCount=0,this.pendingChannelMessagesState={isProcessing:!1,queue:[]},this.realtime=$,this.initTransports(),this.options=W;let X=W.timeouts,G=X.webSocketConnectTimeout+X.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:G,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:X.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:X.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:X.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new KW(this.logger),this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionStateTtl=X.connectionStateTtl,this.maxIdleInterval=null,this.transports=q8(W.transports||o.defaultTransports,this.supportedTransports),this.transportPreference=null,this.transports.includes(R0.WebSocket))this.webSocketTransportAvailable=!0;if(this.transports.includes(R0.XhrPolling))this.baseTransport=R0.XhrPolling;else if(this.transports.includes(R0.Comet))this.baseTransport=R0.Comet;if(this.domains=o.getHosts(W),this.activeProtocol=null,this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.forceFallbackHost=!1,this.connectCounter=0,this.wsCheckResult=null,this.webSocketSlowTimer=null,this.webSocketGiveUpTimer=null,this.abandonedWebSocket=!1,H.logAction(this.logger,H.LOG_MINOR,"Realtime.ConnectionManager()","started"),H.logAction(this.logger,H.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(W.transports||o.defaultTransports)+"]"),H.logAction(this.logger,H.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),H.logAction(this.logger,H.LOG_MICRO,"Realtime.ConnectionManager()","http domains = ["+this.domains+"]"),!this.transports.length)throw H.logAction(this.logger,H.LOG_ERROR,"realtime.ConnectionManager()","no requested transports available"),Error("no requested transports available");let J=j.Config.addEventListener;if(J){if(g1()&&typeof W.recover==="function")J("beforeunload",this.persistConnection.bind(this));if(W.closeOnUnload===!0)J("beforeunload",()=>{H.logAction(this.logger,H.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),this.requestState({state:"closing"})});J("online",()=>{var N;if(this.state==this.states.disconnected||this.state==this.states.suspended)H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager caught browser ‘online’ event","reattempting connection"),this.requestState({state:"connecting"});else if(this.state==this.states.connecting)(N=this.pendingTransport)==null||N.off(),this.disconnectAllTransports(),this.startConnect()}),J("offline",()=>{if(this.state==this.states.connected)H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager caught browser ‘offline’ event","disconnecting active transport"),this.disconnectAllTransports()})}}static supportedTransports($){let W={supportedTransports:{}};return this.initTransports($,W),W.supportedTransports}static initTransports($,W){let X=P(P({},j.Transports.bundledImplementations),$);[R0.WebSocket,...j.Transports.order].forEach((G)=>{let J=X[G];if(J&&J.isAvailable())W.supportedTransports[G]=J})}initTransports(){q.initTransports(this.realtime._additionalTransportImplementations,this)}createTransportParams($,W){return new SG(this.options,$,W,this.connectionKey)}getTransportParams($){((X)=>{if(this.connectionKey){X("resume");return}if(typeof this.options.recover==="string"){X("recover");return}let G=this.options.recover,J=this.getSessionRecoverData(),N=this.sessionRecoveryName();if(J&&typeof G==="function"){H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data (recovery scope: "+N+")"),G(J,(Q)=>{if(Q)this.options.recover=J.recoveryKey,X("recover");else X("clean")});return}X("clean")})((X)=>{let G=this.createTransportParams(null,X);if(X==="recover"){H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+this.options.recover);let J=w$(this.options.recover);if(J)this.msgSerial=J.msgSerial}else H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+G.toString());$(G)})}tryATransport($,W,X){H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+W),this.proposedTransport=I1.tryConnect(this.supportedTransports[W],this,this.realtime.auth,$,(G,J)=>{let N=this.state;if(N==this.states.closing||N==this.states.closed||N==this.states.failed){if(J)H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+N.state+" while we were attempting the transport; closing "+J),J.close();X(!0);return}if(G){if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+W+" "+G.event+", err: "+G.error.toString()),t0.isTokenErr(G.error)&&!(this.errorReason&&t0.isTokenErr(this.errorReason)))this.errorReason=G.error,S0(this.realtime.auth._forceNewToken(null,null),(Q)=>{if(Q){this.actOnErrorFromAuthorize(Q);return}this.tryATransport($,W,X)});else if(G.event==="failed")this.notifyState({state:"failed",error:G.error}),X(!0);else if(G.event==="disconnected")if(!KG(G.error))this.notifyState({state:this.states.connecting.failState,error:G.error}),X(!0);else X(!1);return}H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+W+"; setting pending"),this.setTransportPending(J,$),X(null,J)})}setTransportPending($,W){let X=W.mode;H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+$+"; mode = "+X),this.pendingTransport=$,this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),$.once("connected",(J,N,Q)=>{if(this.activateTransport(J,$,N,Q),X==="recover"&&this.options.recover)delete this.options.recover,this.unpersistConnection()});let G=this;$.on(["disconnected","closed","failed"],function(J){G.deactivateTransport($,this.event,J)}),this.emit("transport.pending",$)}activateTransport($,W,X,G){if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+W),$)H.logAction(this.logger,H.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+$);if(X)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+X);if(G)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(G));this.persistTransportPreference(W);let J=this.state,N=this.states.connected.state;if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+J.state),J.state==this.states.closing.state||J.state==this.states.closed.state||J.state==this.states.failed.state)return H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),W.disconnect(),!1;if(delete this.pendingTransport,!W.isConnected)return H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+W+" since it appears to no longer be connected"),!1;let Q=this.activeProtocol;this.activeProtocol=new wG(W),this.host=W.params.host;let F=G.connectionKey;if(F&&this.connectionKey!=F)this.setConnection(X,G,!!$);if(this.onConnectionDetailsUpdate(G,W),j.Config.nextTick(()=>{W.on("connected",(B,Y,M)=>{this.onConnectionDetailsUpdate(M,W),this.emit("update",new jq(N,N,null,B))})}),J.state===this.states.connected.state){if($)this.errorReason=this.realtime.connection.errorReason=$,this.emit("update",new jq(N,N,null,$))}else this.notifyState({state:"connected",error:$}),this.errorReason=this.realtime.connection.errorReason=$||null;if(this.emit("transport.active",W),Q){if(Q.messageQueue.count()>0)H.logAction(this.logger,H.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+Q.transport.shortName+", new one is "+W.shortName+") finishing with "+Q.messageQueue.count()+" messages still pending");if(Q.transport===W){let B="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+W.shortName+"; stack = "+Error().stack;H.logAction(this.logger,H.LOG_ERROR,"ConnectionManager.activateTransport()",B)}else Q.finish()}return!0}deactivateTransport($,W,X){let G=this.activeProtocol,J=G&&G.getTransport()===$,N=$===this.pendingTransport,Q=this.noTransportsScheduledForActivation();if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+$),H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+W+(J?"; was active":N?"; was pending":"")+(Q?"":"; another transport is scheduled for activation")),X&&X.message)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+X.message);if(J)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(G.getPendingMessages()),G.clearPendingMessages(),this.activeProtocol=this.host=null;if(this.emit("transport.inactive",$),J&&Q||J&&W==="failed"||W==="closed"||G===null&&N){if(W==="disconnected"&&X&&X.statusCode>500&&this.domains.length>1){this.unpersistTransportPreference(),this.forceFallbackHost=!0,this.notifyState({state:W,error:X,retryImmediately:!0});return}let F=W==="failed"&&t0.isTokenErr(X)?"disconnected":W;this.notifyState({state:F,error:X});return}}noTransportsScheduledForActivation(){return!this.pendingTransport||!this.pendingTransport.isConnected}setConnection($,W,X){let G=this.connectionId;if(G&&G!==$||!G&&X)H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0,this.queuedMessages.resetSendAttempted();if(this.connectionId!==$)H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels");this.realtime.connection.id=this.connectionId=$,this.realtime.connection.key=this.connectionKey=W.connectionKey}clearConnection(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.msgSerial=0,this.unpersistConnection()}createRecoveryKey(){if(!this.connectionKey)return null;return JSON.stringify({connectionKey:this.connectionKey,msgSerial:this.msgSerial,channelSerials:this.realtime.channels.channelSerials()})}checkConnectionStateFreshness(){if(!this.lastActivity||!this.connectionId)return;let $=Date.now()-this.lastActivity;if($>this.connectionStateTtl+this.maxIdleInterval)H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+$+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended"}persistConnection(){if(g1()){let $=this.createRecoveryKey();if($)this.setSessionRecoverData({recoveryKey:$,disconnectedAt:Date.now(),location:YG.location,clientId:this.realtime.auth.clientId})}}unpersistConnection(){this.clearSessionRecoverData()}getActiveTransportFormat(){var $;return($=this.activeProtocol)==null?void 0:$.getTransport().format}getError(){if(this.errorReason){let $=s.fromValues(this.errorReason);return $.cause=this.errorReason,$}return this.getStateError()}getStateError(){var $,W;return(W=($=X1)[this.state.state])==null?void 0:W.call($)}activeState(){return this.state.queueEvents||this.state.sendEvents}enactStateChange($){let X=$.current+($.reason?"; reason: "+$.reason:"");if($.current==="failed")H.logAction(this.logger,H.LOG_ERROR,"Connection state",X);else H.logAction(this.logger,H.LOG_MAJOR,"Connection state",X);H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+$.current+"; reason = "+($.reason&&$.reason.message));let G=this.state=this.states[$.current];if($.reason)this.errorReason=$.reason,this.realtime.connection.errorReason=$.reason;if(G.terminal||G.state==="suspended")this.clearConnection();this.emit("connectionstate",$)}startTransitionTimer($){if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+$.state),this.transitionTimer)H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer);this.transitionTimer=setTimeout(()=>{if(this.transitionTimer)this.transitionTimer=null,H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager "+$.state+" timer expired","requesting new state: "+$.failState),this.notifyState({state:$.failState})},$.retryDelay)}cancelTransitionTimer(){if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer)clearTimeout(this.transitionTimer),this.transitionTimer=null}startSuspendTimer(){if(this.suspendTimer)return;this.suspendTimer=setTimeout(()=>{if(this.suspendTimer)this.suspendTimer=null,H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),this.states.connecting.failState="suspended",this.notifyState({state:"suspended"})},this.connectionStateTtl)}checkSuspendTimer($){if($!=="disconnected"&&$!=="suspended"&&$!=="connecting")this.cancelSuspendTimer()}cancelSuspendTimer(){if(this.states.connecting.failState="disconnected",this.suspendTimer)clearTimeout(this.suspendTimer),this.suspendTimer=null}startRetryTimer($){this.retryTimer=setTimeout(()=>{H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),this.retryTimer=null,this.requestState({state:"connecting"})},$)}cancelRetryTimer(){if(this.retryTimer)clearTimeout(this.retryTimer),this.retryTimer=null}startWebSocketSlowTimer(){this.webSocketSlowTimer=setTimeout(()=>{if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager WebSocket slow timer","checking connectivity"),this.checkWsConnectivity().then(()=>{H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager WebSocket slow timer","ws connectivity check succeeded"),this.wsCheckResult=!0}).catch(()=>{H.logAction(this.logger,H.LOG_MAJOR,"ConnectionManager WebSocket slow timer","ws connectivity check failed"),this.wsCheckResult=!1}),this.realtime.http.checkConnectivity)S0(this.realtime.http.checkConnectivity(),($,W)=>{if($||!W)H.logAction(this.logger,H.LOG_MAJOR,"ConnectionManager WebSocket slow timer","http connectivity check failed"),this.cancelWebSocketGiveUpTimer(),this.notifyState({state:"disconnected",error:new K("Unable to connect (network unreachable)",80003,404)});else H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager WebSocket slow timer","http connectivity check succeeded")})},this.options.timeouts.webSocketSlowTimeout)}cancelWebSocketSlowTimer(){if(this.webSocketSlowTimer)clearTimeout(this.webSocketSlowTimer),this.webSocketSlowTimer=null}startWebSocketGiveUpTimer($){this.webSocketGiveUpTimer=setTimeout(()=>{var W,X;if(!this.wsCheckResult)if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager WebSocket give up timer","websocket connection took more than 10s; "+(this.baseTransport?"trying base transport":"")),this.baseTransport)this.abandonedWebSocket=!0,(W=this.proposedTransport)==null||W.dispose(),(X=this.pendingTransport)==null||X.dispose(),this.connectBase($,++this.connectCounter);else H.logAction(this.logger,H.LOG_MAJOR,"ConnectionManager WebSocket give up timer","websocket connectivity appears to be unavailable but no other transports to try")},this.options.timeouts.webSocketConnectTimeout)}cancelWebSocketGiveUpTimer(){if(this.webSocketGiveUpTimer)clearTimeout(this.webSocketGiveUpTimer),this.webSocketGiveUpTimer=null}notifyState($){var W,X;let G=$.state,J=G==="disconnected"&&(this.state===this.states.connected||$.retryImmediately||this.state===this.states.connecting&&$.error&&t0.isTokenErr($.error)&&!(this.errorReason&&t0.isTokenErr(this.errorReason)));if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+G+(J?"; will retry connection immediately":"")),G==this.state.state)return;if(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.checkSuspendTimer($.state),G==="suspended"||G==="connected")this.disconnectedRetryCount=0;if(this.state.terminal)return;let N=this.states[$.state],Q=N.retryDelay;if(N.state==="disconnected")this.disconnectedRetryCount++,Q=tq(N.retryDelay,this.disconnectedRetryCount);let F=new jq(this.state.state,N.state,Q,$.error||((X=(W=X1)[N.state])==null?void 0:X.call(W)));if(J){let B=()=>{if(this.state===this.states.disconnected)this.lastAutoReconnectAttempt=Date.now(),this.requestState({state:"connecting"})},Y=this.lastAutoReconnectAttempt&&Date.now()-this.lastAutoReconnectAttempt+1;if(Y&&Y<1000)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+Y+"ms ago, waiting another "+(1000-Y)+"ms before trying again"),setTimeout(B,1000-Y);else j.Config.nextTick(B)}else if(G==="disconnected"||G==="suspended")this.startRetryTimer(Q);if(G==="disconnected"&&!J||G==="suspended"||N.terminal)j.Config.nextTick(()=>{this.disconnectAllTransports()});if(G=="connected"&&!this.activeProtocol)H.logAction(this.logger,H.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol");if(this.enactStateChange(F),this.state.sendEvents)this.sendQueuedMessages();else if(!this.state.queueEvents)this.realtime.channels.propogateConnectionInterruption(G,F.reason),this.failQueuedMessages(F.reason)}requestState($){var W,X;let G=$.state;if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+G+"; current state: "+this.state.state),G==this.state.state)return;if(this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(G),G=="connecting"&&this.state.state=="connected")return;if(G=="closing"&&this.state.state=="closed")return;let J=this.states[G],N=new jq(this.state.state,J.state,null,$.error||((X=(W=X1)[J.state])==null?void 0:X.call(W)));if(this.enactStateChange(N),G=="connecting")j.Config.nextTick(()=>{this.startConnect()});if(G=="closing")this.closeImpl()}startConnect(){if(this.state!==this.states.connecting){H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);return}let $=this.realtime.auth,W=++this.connectCounter,X=()=>{this.checkConnectionStateFreshness(),this.getTransportParams((G)=>{if(G.mode==="recover"&&G.options.recover){let J=w$(G.options.recover);if(J)this.realtime.channels.recoverChannels(J.channelSerials)}if(W!==this.connectCounter)return;this.connectImpl(G,W)})};if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),$.method==="basic")X();else{let G=(J)=>{if(W!==this.connectCounter)return;if(J)this.actOnErrorFromAuthorize(J);else X()};if(this.errorReason&&t0.isTokenErr(this.errorReason))S0($._forceNewToken(null,null),G);else S0($._ensureValidAuthCredentials(!1),G)}}connectImpl($,W){let X=this.state.state;if(X!==this.states.connecting.state){H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect, but was "+X);return}let G=this.getTransportPreference();if(G&&G===this.baseTransport&&this.webSocketTransportAvailable)this.checkWsConnectivity().then(()=>{if(this.unpersistTransportPreference(),this.state===this.states.connecting)H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.connectImpl():","web socket connectivity available, cancelling connection attempt with "+this.baseTransport),this.disconnectAllTransports(),this.connectWs($,++this.connectCounter)}).catch(LW);if(G&&G===this.baseTransport||this.baseTransport&&!this.webSocketTransportAvailable)this.connectBase($,W);else this.connectWs($,W)}connectWs($,W){H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.connectWs()"),this.wsCheckResult=null,this.abandonedWebSocket=!1,this.startWebSocketSlowTimer(),this.startWebSocketGiveUpTimer($),this.tryTransportWithFallbacks("web_socket",$,!0,W,()=>{return this.wsCheckResult!==!1&&!this.abandonedWebSocket})}connectBase($,W){if(H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.connectBase()"),this.baseTransport)this.tryTransportWithFallbacks(this.baseTransport,$,!1,W,()=>!0);else this.notifyState({state:"disconnected",error:new K("No transports left to try",80000,404)})}tryTransportWithFallbacks($,W,X,G,J){H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.tryTransportWithFallbacks()",$);let N=(M)=>{this.notifyState({state:this.states.connecting.failState,error:M})},Q=this.domains.slice(),F=(M,S)=>{if(G!==this.connectCounter)return;if(!J()){if(S)S.dispose();return}if(!S&&!M)Y()},B=Q.shift();if(!B){N(new K("Unable to connect (no available host)",80003,404));return}W.host=B;let Y=()=>{if(!Q.length){N(new K("Unable to connect (and no more fallback hosts to try)",80003,404));return}if(!this.realtime.http.checkConnectivity){N(new s("Internal error: Http.checkConnectivity not set",null,500));return}S0(this.realtime.http.checkConnectivity(),(M,S)=>{if(G!==this.connectCounter)return;if(!J())return;if(M){N(M);return}if(!S){N(new K("Unable to connect (network unreachable)",80003,404));return}W.host=nq(Q),this.tryATransport(W,$,F)})};if(this.forceFallbackHost&&Q.length){this.forceFallbackHost=!1,Y();return}this.tryATransport(W,$,F)}closeImpl(){if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),this.pendingTransport)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+this.pendingTransport),this.pendingTransport.close();if(this.activeProtocol)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close();this.notifyState({state:"closed"})}onAuthUpdated($,W){var X;switch(this.state.state){case"connected":{H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport");let G=(X=this.activeProtocol)==null?void 0:X.getTransport();if(G&&G.onAuthUpdated)G.onAuthUpdated($);let J=E0({action:c.AUTH,auth:{accessToken:$.token}});this.send(J);let N=()=>{this.off(Q),W(null,$)},Q=(F)=>{if(F.current==="failed")this.off(N),this.off(Q),W(F.reason||this.getStateError())};this.once("connectiondetails",N),this.on("connectionstate",Q);break}case"connecting":H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");let G=(J)=>{switch(J.current){case"connected":this.off(G),W(null,$);break;case"failed":case"closed":case"suspended":this.off(G),W(J.reason||this.getStateError());break;default:break}};if(this.on("connectionstate",G),this.state.state==="connecting")this.startConnect();else this.requestState({state:"connecting"})}}}disconnectAllTransports(){if(H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"),this.connectCounter++,this.pendingTransport)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+this.pendingTransport),this.pendingTransport.disconnect();if(delete this.pendingTransport,this.proposedTransport)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting proposed transport: "+this.pendingTransport),this.proposedTransport.disconnect();if(delete this.pendingTransport,this.activeProtocol)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect()}send($,W,X){X=X||LW;let G=this.state;if(G.sendEvents){H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new jW($,X));return}if(!(W&&G.queueEvents)){let N="rejecting event, queueEvent was "+W+", state was "+G.state;H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.send()",N),X(this.errorReason||new K(N,90000,400));return}if(this.logger.shouldLog(H.LOG_MICRO))H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+U$($,this.realtime._RealtimePresence,this.realtime._Annotations,this.realtime._objectsPlugin));this.queue($,X)}sendImpl($){let W=$.message;if($.ackRequired&&!$.sendAttempted)W.msgSerial=this.msgSerial++;try{this.activeProtocol.send($)}catch(X){H.logAction(this.logger,H.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+X.stack)}}queue($,W){H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.queue()","queueing event");let X=this.queuedMessages.last(),G=this.options.maxMessageSize;if(X&&!X.sendAttempted&&MG(X.message,$,G)){if(!X.merged)X.callback=aq.create(this.logger,[X.callback]),X.merged=!0;X.callback.push(W)}else this.queuedMessages.push(new jW($,W))}sendQueuedMessages(){H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");let $;while($=this.queuedMessages.shift())this.sendImpl($)}queuePendingMessages($){if($&&$.length)H.logAction(this.logger,H.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+$.length+" pending messages"),this.queuedMessages.prepend($)}failQueuedMessages($){let W=this.queuedMessages.count();if(W>0)H.logAction(this.logger,H.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+W+" queued messages, err = "+H0($)),this.queuedMessages.completeAllMessages($)}onChannelMessage($,W){if(this.pendingChannelMessagesState.queue.push({message:$,transport:W}),!this.pendingChannelMessagesState.isProcessing)this.processNextPendingChannelMessage()}processNextPendingChannelMessage(){if(this.pendingChannelMessagesState.queue.length>0){this.pendingChannelMessagesState.isProcessing=!0;let $=this.pendingChannelMessagesState.queue.shift();this.processChannelMessage($.message).catch((W)=>{H.logAction(this.logger,H.LOG_ERROR,"ConnectionManager.processNextPendingChannelMessage() received error ",W)}).finally(()=>{this.pendingChannelMessagesState.isProcessing=!1,this.processNextPendingChannelMessage()})}}async processChannelMessage($){await this.realtime.channels.processChannelMessage($)}async ping(){var $;if(this.state.state!=="connected")throw new K("Unable to ping service; not connected",40000,400);let W=($=this.activeProtocol)==null?void 0:$.getTransport();if(!W)throw this.getStateError();H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.ping()","transport = "+W);let X=Date.now(),G=Vq();return K8(new Promise((J)=>{let N=(Q)=>{if(Q===G)W.off("heartbeat",N),J(Date.now()-X)};W.on("heartbeat",N),W.ping(G)}),this.options.timeouts.realtimeRequestTimeout,"Timeout waiting for heartbeat response")}abort($){this.activeProtocol.getTransport().fail($)}getTransportPreference(){var $,W;return this.transportPreference||O$()&&((W=($=j.WebStorage)==null?void 0:$.get)==null?void 0:W.call($,Q$))}persistTransportPreference($){var W,X;if(this.transportPreference=$.shortName,O$())(X=(W=j.WebStorage)==null?void 0:W.set)==null||X.call(W,Q$,$.shortName)}unpersistTransportPreference(){var $,W;if(this.transportPreference=null,O$())(W=($=j.WebStorage)==null?void 0:$.remove)==null||W.call($,Q$)}actOnErrorFromAuthorize($){if($.code===40171)this.notifyState({state:"failed",error:$});else if($.code===40102)this.notifyState({state:"failed",error:$});else if($.statusCode===Oq.Forbidden)H.logAction(this.logger,H.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()","Client configured authentication provider returned 403; failing the connection"),this.notifyState({state:"failed",error:new K("Client configured authentication provider returned 403; failing the connection",80019,403,$)});else H.logAction(this.logger,H.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize","Client configured authentication provider request failed"),this.notifyState({state:this.state.failState,error:new K("Client configured authentication provider request failed",80019,401,$)})}onConnectionDetailsUpdate($,W){if(!$)return;if(this.connectionDetails=$,$.maxMessageSize)this.options.maxMessageSize=$.maxMessageSize;let X=$.clientId;if(X){let J=this.realtime.auth._uncheckedSetClientId(X);if(J){H.logAction(this.logger,H.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",J.message),W.fail(J);return}}let G=$.connectionStateTtl;if(G)this.connectionStateTtl=G;this.maxIdleInterval=$.maxIdleInterval,this.emit("connectiondetails",$)}checkWsConnectivity(){let $=this.options.wsConnectivityCheckUrl||o.wsConnectivityCheckUrl,W=new j.Config.WebSocket($);return new Promise((X,G)=>{let J=!1;W.onopen=()=>{if(!J)J=!0,X(),W.close()},W.onclose=W.onerror=()=>{if(!J)J=!0,G()}})}sessionRecoveryName(){return this.options.recoveryKeyStorageName||"ably-connection-recovery"}getSessionRecoverData(){var $,W;return g1()&&((W=($=j.WebStorage)==null?void 0:$.getSession)==null?void 0:W.call($,this.sessionRecoveryName()))}setSessionRecoverData($){var W,X;return g1()&&((X=(W=j.WebStorage)==null?void 0:W.setSession)==null?void 0:X.call(W,this.sessionRecoveryName(),$))}clearSessionRecoverData(){var $,W;return g1()&&((W=($=j.WebStorage)==null?void 0:$.removeSession)==null?void 0:W.call($,this.sessionRecoveryName()))}},IW=AG,RG=class extends B0{constructor(q,$){super(q.logger);this.whenState=(W)=>{return B0.prototype.whenState.call(this,W,this.state)},this.ably=q,this.connectionManager=new IW(q,$),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.errorReason=null,this.connectionManager.on("connectionstate",(W)=>{let X=this.state=W.current;j.Config.nextTick(()=>{this.emit(X,W)})}),this.connectionManager.on("update",(W)=>{j.Config.nextTick(()=>{this.emit("update",W)})})}connect(){H.logAction(this.logger,H.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})}async ping(){return H.logAction(this.logger,H.LOG_MINOR,"Connection.ping()",""),this.connectionManager.ping()}close(){H.logAction(this.logger,H.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})}get recoveryKey(){return this.logger.deprecationWarning("The `Connection.recoveryKey` attribute has been replaced by the `Connection.createRecoveryKey()` method. Replace your usage of `recoveryKey` with the return value of `createRecoveryKey()`. `recoveryKey` will be removed in a future version."),this.createRecoveryKey()}createRecoveryKey(){return this.connectionManager.createRecoveryKey()}},CG=RG,YW=class q extends c8{constructor($){var W,X,G,J;super(o.objectifyOptions($,!1,"BaseRealtime",H.defaultLogger));if(H.logAction(this.logger,H.LOG_MINOR,"Realtime()",""),typeof EdgeRuntime==="string")throw new K(`Ably.Realtime instance cannot be used in Vercel Edge runtime. If you are running Vercel Edge functions, please replace your "new Ably.Realtime()" with "new Ably.Rest()" and use Ably Rest API instead of the Realtime API. If you are server-rendering your application in the Vercel Edge runtime, please use the condition "if (typeof EdgeRuntime === 'string')" to prevent instantiating Ably.Realtime instance during SSR in the Vercel Edge runtime.`,40000,400);if(this._additionalTransportImplementations=q.transportImplementationsFromPlugins(this.options.plugins),this._RealtimePresence=(X=(W=this.options.plugins)==null?void 0:W.RealtimePresence)!=null?X:null,this._objectsPlugin=(J=(G=this.options.plugins)==null?void 0:G.Objects)!=null?J:null,this.connection=new CG(this,this.options),this._channels=new PG(this),this.options.autoConnect!==!1)this.connect()}static transportImplementationsFromPlugins($){let W={};if($==null?void 0:$.WebSocketTransport)W[R0.WebSocket]=$.WebSocketTransport;if($==null?void 0:$.XHRPolling)W[R0.XhrPolling]=$.XHRPolling;return W}get channels(){return this._channels}get clientId(){return this.auth.clientId}connect(){H.logAction(this.logger,H.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()}close(){H.logAction(this.logger,H.LOG_MINOR,"Realtime.close()",""),this.connection.close()}};YW.EventEmitter=B0;var TG=YW,PG=class extends B0{constructor(q){super(q.logger);this.realtime=q,this.all=Object.create(null),q.connection.connectionManager.on("transport.active",()=>{this.onTransportActive()})}channelSerials(){let q={};for(let $ of E1(this.all,!0)){let W=this.all[$];if(W.properties.channelSerial)q[$]=W.properties.channelSerial}return q}recoverChannels(q){for(let $ of E1(q,!0)){let W=this.get($);W.properties.channelSerial=q[$]}}async processChannelMessage(q){let $=q.channel;if($===void 0){H.logAction(this.logger,H.LOG_ERROR,"Channels.processChannelMessage()","received event unspecified channel, action = "+q.action);return}let W=this.all[$];if(!W){H.logAction(this.logger,H.LOG_ERROR,"Channels.processChannelMessage()","received event for non-existent channel: "+$);return}await W.processMessage(q)}onTransportActive(){for(let q in this.all){let $=this.all[q];if($.state==="attaching"||$.state==="detaching")$.checkPendingState();else if($.state==="suspended")$._attach(!1,null);else if($.state==="attached")$.requestState("attaching")}}propogateConnectionInterruption(q,$){let W={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"},X=["attaching","attached","detaching","suspended"],G=W[q];for(let J in this.all){let N=this.all[J];if(X.includes(N.state))N.notifyState(G,$)}}get(q,$){q=String(q);let W=this.all[q];if(!W)W=this.all[q]=new y1(this.realtime,q,$);else if($){if(W._shouldReattachToSetOptions($,W.channelOptions))throw new K("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",40000,400);W.setOptions($)}return W}getDerived(q,$,W){if($.filter){let X=zq($.filter),G=B8(q);q=`[filter=${X}${G.qualifierParam}]${G.channelName}`}return this.get(q,W)}release(q){q=String(q);let $=this.all[q];if(!$)return;let W=$.getReleaseErr();if(W)throw W;delete this.all[q]}},hG=TG;function EG(q,$){if(q.isSynthesized()||$.isSynthesized())return q.timestamp>=$.timestamp;let W=q.parseId(),X=$.parseId();if(W.msgSerial===X.msgSerial)return W.index>X.index;else return W.msgSerial>X.msgSerial}var B$=class extends B0{constructor(q,$,W=EG){super(q.logger);this.presence=q,this.map=Object.create(null),this.syncInProgress=!1,this.residualMembers=null,this.memberKey=$,this.newerThan=W}get(q){return this.map[q]}getClient(q){let $=this.map,W=[];for(let X in $){let G=$[X];if(G.clientId==q&&G.action!="absent")W.push(G)}return W}list(q){let $=this.map,W=q&&q.clientId,X=q&&q.connectionId,G=[];for(let J in $){let N=$[J];if(N.action==="absent")continue;if(W&&W!=N.clientId)continue;if(X&&X!=N.connectionId)continue;G.push(N)}return G}put(q){if(q.action==="enter"||q.action==="update")q=r0.fromValues(q),q.action="present";let $=this.map,W=this.memberKey(q);if(this.residualMembers)delete this.residualMembers[W];let X=$[W];if(X&&!this.newerThan(q,X))return!1;return $[W]=q,!0}values(){let q=this.map,$=[];for(let W in q){let X=q[W];if(X.action!="absent")$.push(X)}return $}remove(q){let $=this.map,W=this.memberKey(q),X=$[W];if(X&&!this.newerThan(q,X))return!1;if(this.syncInProgress)q=r0.fromValues(q),q.action="absent",$[W]=q;else delete $[W];return!!X}startSync(){let q=this.map,$=this.syncInProgress;if(H.logAction(this.logger,H.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+$),!this.syncInProgress)this.residualMembers=v0(q),this.setInProgress(!0)}endSync(){let q=this.map,$=this.syncInProgress;if(H.logAction(this.logger,H.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+$),$){for(let W in q)if(q[W].action==="absent")delete q[W];this.presence._synthesizeLeaves(X8(this.residualMembers));for(let W in this.residualMembers)delete q[W];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")}waitSync(q){let $=this.syncInProgress;if(H.logAction(this.logger,H.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+$),!$){q();return}this.once("sync",q)}clear(){this.map={},this.setInProgress(!1),this.residualMembers=null}setInProgress(q){H.logAction(this.logger,H.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+q),this.syncInProgress=q,this.presence.syncComplete=!q}};function bG(q){return q.channel.client.auth.clientId}function F$(q){let $=q.channel.client,W=$.auth.clientId;return(!W||W==="*")&&$.connection.state==="connected"}function kG(q,$,W){switch(q.state){case"attached":case"suspended":W();break;case"initialized":case"detached":case"detaching":case"attaching":S0(q.attach(),function(X){if(X)$(X);else W()});break;default:$(K.fromValues(q.invalidStateError()))}}var uG=class extends B0{constructor(q){super(q.logger);this.channel=q,this.syncComplete=!1,this.members=new B$(this,($)=>$.clientId+":"+$.connectionId),this._myMembers=new B$(this,($)=>$.clientId),this.subscriptions=new B0(this.logger),this.pendingPresence=[]}async enter(q){if(F$(this))throw new K("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,void 0,q,"enter")}async update(q){if(F$(this))throw new K("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,void 0,q,"update")}async enterClient(q,$){return this._enterOrUpdateClient(void 0,q,$,"enter")}async updateClient(q,$){return this._enterOrUpdateClient(void 0,q,$,"update")}async _enterOrUpdateClient(q,$,W,X){let G=this.channel;if(!G.connectionManager.activeState())throw G.connectionManager.getError();H.logAction(this.logger,H.LOG_MICRO,"RealtimePresence."+X+"Client()","channel = "+G.name+", id = "+q+", client = "+($||"(implicit) "+bG(this)));let J=r0.fromData(W);if(J.action=X,q)J.id=q;if($)J.clientId=$;let N=await J.encode(G.channelOptions);switch(G.state){case"attached":return G.sendPresence([N]);case"initialized":case"detached":G.attach();case"attaching":return new Promise((Q,F)=>{this.pendingPresence.push({presence:N,callback:(B)=>B?F(B):Q()})});default:{let Q=new s("Unable to "+X+" presence channel while in "+G.state+" state",90001);throw Q.code=90001,Q}}}async leave(q){if(F$(this))throw new K("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,q)}async leaveClient(q,$){let W=this.channel;if(!W.connectionManager.activeState())throw W.connectionManager.getError();H.logAction(this.logger,H.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+q);let X=r0.fromData($);if(X.action="leave",q)X.clientId=q;let G=await X.encode(W.channelOptions);switch(W.state){case"attached":return W.sendPresence([G]);case"attaching":return new Promise((J,N)=>{this.pendingPresence.push({presence:G,callback:(Q)=>Q?N(Q):J()})});case"initialized":case"failed":throw new s("Unable to leave presence channel (incompatible state)",90001);default:throw W.invalidStateError()}}async get(q){let $=!q||("waitForSync"in q?q.waitForSync:!0);return new Promise((W,X)=>{function G(J){W(q?J.list(q):J.values())}if(this.channel.state==="suspended"){if($)X(K.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"}));else G(this.members);return}kG(this.channel,(J)=>X(J),()=>{let J=this.members;if($)J.waitSync(function(){G(J)});else G(J)})})}async history(q){H.logAction(this.logger,H.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name);let $=this.channel.client.rest.presenceMixin;if(q&&q.untilAttach)if(this.channel.state==="attached")delete q.untilAttach,q.from_serial=this.channel.properties.attachSerial;else throw new K("option untilAttach requires the channel to be attached, was: "+this.channel.state,40000,400);return $.history(this,q)}setPresence(q,$,W){H.logAction(this.logger,H.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+q.length+" participants; syncChannelSerial = "+W);let X,G,J=this.members,N=this._myMembers,Q=[],F=this.channel.connectionManager.connectionId;if($){if(this.members.startSync(),W&&(G=W.match(/^[\w-]+:(.*)$/)))X=G[1]}for(let B of q)switch(B.action){case"leave":if(J.remove(B))Q.push(B);if(B.connectionId===F&&!B.isSynthesized())N.remove(B);break;case"enter":case"present":case"update":if(J.put(B))Q.push(B);if(B.connectionId===F)N.put(B);break}if($&&!X)J.endSync(),this.channel.syncChannelSerial=null;for(let B=0;B<Q.length;B++){let Y=Q[B];this.subscriptions.emit(Y.action,Y)}}onAttached(q){if(H.logAction(this.logger,H.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+q),q)this.members.startSync();else this._synthesizeLeaves(this.members.values()),this.members.clear();this._ensureMyMembersPresent();let $=this.pendingPresence,W=$.length;if(W){this.pendingPresence=[];let X=[],G=aq.create(this.logger);H.logAction(this.logger,H.LOG_MICRO,"RealtimePresence.onAttached","sending "+W+" queued presence messages");for(let J=0;J<W;J++){let N=$[J];X.push(N.presence),G.push(N.callback)}this.channel.sendPresence(X).then(()=>G()).catch((J)=>G(J))}}actOnChannelState(q,$,W){switch(q){case"attached":this.onAttached($);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(W);break}}failPendingPresence(q){if(this.pendingPresence.length){H.logAction(this.logger,H.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+H0(q));for(let $=0;$<this.pendingPresence.length;$++)try{this.pendingPresence[$].callback(q)}catch(W){}this.pendingPresence=[]}}_clearMyMembers(){this._myMembers.clear()}_ensureMyMembersPresent(){let q=this._myMembers,$=this.channel.connectionManager.connectionId;for(let W in q.map){let X=q.map[W];H.logAction(this.logger,H.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+X.clientId+'" into the presence set');let G=X.connectionId===$?X.id:void 0;this._enterOrUpdateClient(G,X.clientId,X.data,"enter").catch((J)=>{let N=new K("Presence auto re-enter failed",91004,400,J);H.logAction(this.logger,H.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()","Presence auto re-enter failed; reason = "+H0(J));let Q=new z$(this.channel.state,this.channel.state,!0,!1,N);this.channel.emit("update",Q)})}}_synthesizeLeaves(q){let $=this.subscriptions;q.forEach(function(W){let X=r0.fromValues({action:"leave",connectionId:W.connectionId,clientId:W.clientId,data:W.data,encoding:W.encoding,timestamp:Date.now()});$.emit("leave",X)})}async subscribe(...q){let $=y1.processListenerArgs(q),W=$[0],X=$[1],G=this.channel;if(G.state==="failed")throw K.fromValues(G.invalidStateError());if(this.subscriptions.on(W,X),G.channelOptions.attachOnSubscribe!==!1)await G.attach()}unsubscribe(...q){let $=y1.processListenerArgs(q),W=$[0],X=$[1];this.subscriptions.off(W,X)}},yG=uG,gG=R0.WebSocket;function vG(q){return!!q.on}var iG=class extends I1{constructor(q,$,W){super(q,$,W);this.shortName=gG,W.heartbeats=j.Config.useProtocolHeartbeats,this.wsHost=W.host}static isAvailable(){return!!j.Config.WebSocket}createWebSocket(q,$){return this.uri=q+b1($),new j.Config.WebSocket(this.uri)}toString(){return"WebSocketTransport; uri="+this.uri}connect(){H.logAction(this.logger,H.LOG_MINOR,"WebSocketTransport.connect()","starting"),I1.prototype.connect.call(this);let q=this,$=this.params,W=$.options,G=(W.tls?"wss://":"ws://")+this.wsHost+":"+o.getPort(W)+"/";H.logAction(this.logger,H.LOG_MINOR,"WebSocketTransport.connect()","uri: "+G),S0(this.auth.getAuthParams(),function(J,N){if(q.isDisposed)return;let Q="";for(let B in N)Q+=" "+B+": "+N[B]+";";if(H.logAction(q.logger,H.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+Q+" err: "+J),J){q.disconnect(J);return}let F=$.getConnectParams(N);try{let B=q.wsConnection=q.createWebSocket(G,F);if(B.binaryType=j.Config.binaryType,B.onopen=function(){q.onWsOpen()},B.onclose=function(Y){q.onWsClose(Y)},B.onmessage=function(Y){q.onWsData(Y.data)},B.onerror=function(Y){q.onWsError(Y)},vG(B))B.on("ping",function(){q.onActivity()})}catch(B){H.logAction(q.logger,H.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(B.stack||B.message)),q.disconnect(B)}})}send(q){let $=this.wsConnection;if(!$){H.logAction(this.logger,H.LOG_ERROR,"WebSocketTransport.send()","No socket connection");return}try{$.send(JG(q,this.connectionManager.realtime._MsgPack,this.params.format))}catch(W){let X="Exception from ws connection when trying to send: "+H0(W);H.logAction(this.logger,H.LOG_ERROR,"WebSocketTransport.send()",X),this.finish("disconnected",new K(X,50000,500))}}onWsData(q){H.logAction(this.logger,H.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+q.length+"; type = "+typeof q);try{this.onProtocolMessage(HG(q,this.connectionManager.realtime._MsgPack,this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin,this.format))}catch($){H.logAction(this.logger,H.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+$.stack)}}onWsOpen(){H.logAction(this.logger,H.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")}onWsClose(q){let $,W;if(typeof q=="object")W=q.code,$=q.wasClean||W===1000;else W=q,$=W==1000;if(delete this.wsConnection,$){H.logAction(this.logger,H.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");let X=new K("Websocket closed",80003,400);this.finish("disconnected",X)}else{let X="Unclean disconnection of WebSocket ; code = "+W,G=new K(X,80003,400);H.logAction(this.logger,H.LOG_MINOR,"WebSocketTransport.onWsClose()",X),this.finish("disconnected",G)}this.emit("disposed")}onWsError(q){H.logAction(this.logger,H.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+q.message),j.Config.nextTick(()=>{this.disconnect(Error(q.message))})}dispose(){H.logAction(this.logger,H.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;let q=this.wsConnection;if(q)q.onmessage=function(){},delete this.wsConnection,j.Config.nextTick(()=>{if(H.logAction(this.logger,H.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!q)throw Error("WebSocketTransport.dispose(): wsConnection is not defined");q.close()})}},MW=iG,mG=class{static subscribeFilter(q,$,W){let X=(G)=>{var J,N,Q,F,B,Y;let M={name:G.name,refTimeserial:(N=(J=G.extras)==null?void 0:J.ref)==null?void 0:N.timeserial,refType:(F=(Q=G.extras)==null?void 0:Q.ref)==null?void 0:F.type,isRef:!!((Y=(B=G.extras)==null?void 0:B.ref)==null?void 0:Y.timeserial),clientId:G.clientId};if(Object.entries($).find(([S,R])=>R!==void 0?M[S]!==R:!1))return;W(G)};this.addFilteredSubscription(q,$,W,X),q.subscriptions.on(X)}static addFilteredSubscription(q,$,W,X){var G;if(!q.filteredSubscriptions)q.filteredSubscriptions=new Map;if(q.filteredSubscriptions.has(W)){let J=q.filteredSubscriptions.get(W);J.set($,((G=J==null?void 0:J.get($))==null?void 0:G.concat(X))||[X])}else q.filteredSubscriptions.set(W,new Map([[$,[X]]]))}static getAndDeleteFilteredSubscriptions(q,$,W){if(!q.filteredSubscriptions)return[];if(!W&&$)return Array.from(q.filteredSubscriptions.entries()).map(([J,N])=>{var Q;let F=N.get($);if(N.delete($),N.size===0)(Q=q.filteredSubscriptions)==null||Q.delete(J);return F}).reduce((J,N)=>N?J.concat(...N):J,[]);if(!W||!q.filteredSubscriptions.has(W))return[];let X=q.filteredSubscriptions.get(W);if(!$){let J=Array.from(X.values()).reduce((N,Q)=>N.concat(...Q),[]);return q.filteredSubscriptions.delete(W),J}let G=X.get($);return X.delete($),G||[]}},g0=class q extends hG{constructor($){var W;let X=q._MsgPack;if(!X)throw Error("Expected DefaultRealtime._MsgPack to have been set");super(o.objectifyOptions($,!0,"Realtime",H.defaultLogger,E(P({},GW),{Crypto:(W=q.Crypto)!=null?W:void 0,MsgPack:X,RealtimePresence:{RealtimePresence:yG,PresenceMessage:r0,WirePresenceMessage:k1},Annotations:{Annotation:L1,WireAnnotation:j1,RealtimeAnnotations:D$,RestAnnotations:Fq},WebSocketTransport:MW,MessageInteractions:mG})))}static get Crypto(){if(this._Crypto===null)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto($){this._Crypto=$}};g0.Utils=G0,g0.ConnectionManager=IW,g0.ProtocolMessage=UG,g0._Crypto=null,g0.Message=JW,g0.PresenceMessage=HW,g0.Annotation=DW,g0._MsgPack=null,g0._Http=$$,g0._PresenceMap=B$,g0._MessageEncoding=Qq;var K$=g0,j$=Uint8Array,v1=Uint32Array,L$=Math.pow,SW=new v1(8),AW=[],i1=new v1(64);function RW(q){return(q-(q|0))*L$(2,32)|0}var m1=2,p1=0;while(p1<64){I$=!0;for(Lq=2;Lq<=m1/2;Lq++)if(m1%Lq===0)I$=!1;if(I$){if(p1<8)SW[p1]=RW(L$(m1,0.5));AW[p1]=RW(L$(m1,0.3333333333333333)),p1++}m1++}var I$,Lq,pG=!!new j$(new v1([1]).buffer)[0];function Y$(q){if(pG)return q>>>24|(q>>>16&255)<<8|(q&65280)<<8|q<<24;else return q}function x0(q,$){return q>>>$|q<<32-$}function Iq(q){var $=SW.slice(),W=q.length,X=W*8,G=512-(X+64)%512-1+X+65,J=new j$(G/8),N=new v1(J.buffer);J.set(q,0),J[W]=128,N[N.length-1]=Y$(X);var Q;for(var F=0;F<G/32;F+=16){var B=$.slice();for(Q=0;Q<64;Q++){var Y;if(Q<16)Y=Y$(N[F+Q]);else{var M=i1[Q-15],S=i1[Q-2];Y=i1[Q-7]+i1[Q-16]+(x0(M,7)^x0(M,18)^M>>>3)+(x0(S,17)^x0(S,19)^S>>>10)}i1[Q]=Y|=0;var R=(x0(B[4],6)^x0(B[4],11)^x0(B[4],25))+(B[4]&B[5]^~B[4]&B[6])+B[7]+Y+AW[Q],d=(x0(B[0],2)^x0(B[0],13)^x0(B[0],22))+(B[0]&B[1]^B[2]&(B[0]^B[1]));for(var g=7;g>0;g--)B[g]=B[g-1];B[0]=R+d|0,B[4]=B[4]+R|0}for(Q=0;Q<8;Q++)$[Q]=$[Q]+B[Q]|0}return new j$(new v1($.map(function(t){return Y$(t)})).buffer)}function dG(q,$){if(q.length>64)q=Iq(q);if(q.length<64){let Q=new Uint8Array(64);Q.set(q,0),q=Q}var W=new Uint8Array(64),X=new Uint8Array(64);for(var G=0;G<64;G++)W[G]=54^q[G],X[G]=92^q[G];var J=new Uint8Array($.length+64);J.set(W,0),J.set($,64);var N=new Uint8Array(96);return N.set(X,0),N.set(Iq(J),64),Iq(N)}var cG=class{constructor(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this.hexCharSet="0123456789abcdef"}uint8ViewToBase64(q){let $="",W=this.base64CharSet,X=q.byteLength,G=X%3,J=X-G,N,Q,F,B,Y;for(let M=0;M<J;M=M+3)Y=q[M]<<16|q[M+1]<<8|q[M+2],N=(Y&16515072)>>18,Q=(Y&258048)>>12,F=(Y&4032)>>6,B=Y&63,$+=W[N]+W[Q]+W[F]+W[B];if(G==1)Y=q[J],N=(Y&252)>>2,Q=(Y&3)<<4,$+=W[N]+W[Q]+"==";else if(G==2)Y=q[J]<<8|q[J+1],N=(Y&64512)>>10,Q=(Y&1008)>>4,F=(Y&15)<<2,$+=W[N]+W[Q]+W[F]+"=";return $}base64ToArrayBuffer(q){let $=atob==null?void 0:atob(q),W=$.length,X=new Uint8Array(W);for(let G=0;G<W;G++){let J=$.charCodeAt(G);X[G]=J}return this.toArrayBuffer(X)}isBuffer(q){return q instanceof ArrayBuffer||ArrayBuffer.isView(q)}toBuffer(q){if(!ArrayBuffer)throw Error("Can't convert to Buffer: browser does not support the necessary types");if(q instanceof ArrayBuffer)return new Uint8Array(q);if(ArrayBuffer.isView(q))return new Uint8Array(this.toArrayBuffer(q));throw Error("BufferUtils.toBuffer expected an ArrayBuffer or a view onto one")}toArrayBuffer(q){if(!ArrayBuffer)throw Error("Can't convert to ArrayBuffer: browser does not support the necessary types");if(q instanceof ArrayBuffer)return q;if(ArrayBuffer.isView(q))return q.buffer.slice(q.byteOffset,q.byteOffset+q.byteLength);throw Error("BufferUtils.toArrayBuffer expected an ArrayBuffer or a view onto one")}base64Encode(q){return this.uint8ViewToBase64(this.toBuffer(q))}base64UrlEncode(q){return this.base64Encode(q).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}base64Decode(q){if(ArrayBuffer&&j.Config.atob)return this.base64ToArrayBuffer(q);else throw Error("Expected ArrayBuffer to exist and Platform.Config.atob to be configured")}hexEncode(q){return this.toBuffer(q).reduce((W,X)=>W+X.toString(16).padStart(2,"0"),"")}hexDecode(q){if(q.length%2!==0)throw Error("Can't create a byte array from a hex string of odd length");let $=new Uint8Array(q.length/2);for(let W=0;W<$.length;W++)$[W]=parseInt(q.slice(2*W,2*(W+1)),16);return this.toArrayBuffer($)}utf8Encode(q){if(j.Config.TextEncoder){let $=new j.Config.TextEncoder().encode(q);return this.toArrayBuffer($)}else throw Error("Expected TextEncoder to be configured")}utf8Decode(q){if(!this.isBuffer(q))throw Error("Expected input of utf8decode to be an arraybuffer or typed array");if(TextDecoder)return new TextDecoder().decode(q);else throw Error("Expected TextDecoder to be configured")}areBuffersEqual(q,$){if(!q||!$)return!1;let W=this.toArrayBuffer(q),X=this.toArrayBuffer($);if(W.byteLength!=X.byteLength)return!1;let G=new Uint8Array(W),J=new Uint8Array(X);for(var N=0;N<G.length;N++)if(G[N]!=J[N])return!1;return!0}byteLength(q){if(q instanceof ArrayBuffer||ArrayBuffer.isView(q))return q.byteLength;return-1}arrayBufferViewToBuffer(q){return this.toArrayBuffer(q)}concat(q){let $=q.reduce((G,J)=>G+J.byteLength,0),W=new Uint8Array($),X=0;for(let G of q){let J=this.toBuffer(G);W.set(J,X),X+=J.byteLength}return W.buffer}sha256(q){let $=Iq(this.toBuffer(q));return this.toArrayBuffer($)}hmacSha256(q,$){let W=dG(this.toBuffer($),this.toBuffer(q));return this.toArrayBuffer(W)}},CW=new cG,xG=function(q,$){var W="aes",X=256,G="cbc",J=16;function N(S){if(S.algorithm==="aes"&&S.mode==="cbc"){if(S.keyLength===128||S.keyLength===256)return;throw Error("Unsupported key length "+S.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}}function Q(S){return S.replace("_","/").replace("-","+")}function F(S){return S instanceof B}class B{constructor(S,R,d,g){this.algorithm=S,this.keyLength=R,this.mode=d,this.key=g}}class Y{static getDefaultParams(S){var R;if(!S.key)throw Error("Crypto.getDefaultParams: a key is required");if(typeof S.key==="string")R=$.toArrayBuffer($.base64Decode(Q(S.key)));else if(S.key instanceof ArrayBuffer)R=S.key;else R=$.toArrayBuffer(S.key);var d=S.algorithm||W,g=R.byteLength*8,t=S.mode||G,W0=new B(d,g,t,R);if(S.keyLength&&S.keyLength!==W0.keyLength)throw Error("Crypto.getDefaultParams: a keyLength of "+S.keyLength+" was specified, but the key actually has length "+W0.keyLength);return N(W0),W0}static async generateRandomKey(S){try{return q.getRandomArrayBuffer((S||X)/8)}catch(R){throw new K("Failed to generate random key: "+R.message,400,50000,R)}}static getCipher(S,R){var d,g=F(S)?S:this.getDefaultParams(S);return{cipherParams:g,cipher:new M(g,(d=S.iv)!=null?d:null,R)}}}Y.CipherParams=B;class M{constructor(S,R,d){if(this.logger=d,!crypto.subtle)if(isSecureContext)throw Error("Crypto operations are not possible since the browser’s SubtleCrypto class is unavailable (reason unknown).");else throw Error("Crypto operations are is not possible since the current environment is a non-secure context and hence the browser’s SubtleCrypto class is not available.");this.algorithm=S.algorithm+"-"+String(S.keyLength)+"-"+S.mode,this.webCryptoAlgorithm=S.algorithm+"-"+S.mode,this.key=$.toArrayBuffer(S.key),this.iv=R?$.toArrayBuffer(R):null}concat(S,R){let d=new ArrayBuffer(S.byteLength+R.byteLength),g=new DataView(d),t=new DataView($.toArrayBuffer(S));for(let Z0=0;Z0<t.byteLength;Z0++)g.setInt8(Z0,t.getInt8(Z0));let W0=new DataView($.toArrayBuffer(R));for(let Z0=0;Z0<W0.byteLength;Z0++)g.setInt8(t.byteLength+Z0,W0.getInt8(Z0));return d}async encrypt(S){H.logAction(this.logger,H.LOG_MICRO,"CBCCipher.encrypt()","");let R=await this.getIv(),d=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["encrypt"]),g=await crypto.subtle.encrypt({name:this.webCryptoAlgorithm,iv:R},d,S);return this.concat(R,g)}async decrypt(S){H.logAction(this.logger,H.LOG_MICRO,"CBCCipher.decrypt()","");let R=$.toArrayBuffer(S),d=R.slice(0,J),g=R.slice(J),t=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["decrypt"]);return crypto.subtle.decrypt({name:this.webCryptoAlgorithm,iv:d},t,g)}async getIv(){if(this.iv){var S=this.iv;return this.iv=null,S}let R=await q.getRandomArrayBuffer(J);return $.toArrayBuffer(R)}}return Y},TW=((q)=>{return q[q.REQ_SEND=0]="REQ_SEND",q[q.REQ_RECV=1]="REQ_RECV",q[q.REQ_RECV_POLL=2]="REQ_RECV_POLL",q[q.REQ_RECV_STREAM=3]="REQ_RECV_STREAM",q})(TW||{}),a0=TW;function PW(){return new K("No HTTP request plugin provided. Provide at least one of the FetchRequest or XHRRequest plugins.",400,40000)}var d1,hW=(d1=class{constructor(q){this.checksInProgress=null,this.checkConnectivity=void 0,this.supportsAuthHeaders=!1,this.supportsLinkHeaders=!1;var $;this.client=q!=null?q:null;let W=(q==null?void 0:q.options.connectivityCheckUrl)||o.connectivityCheckUrl,X=($=q==null?void 0:q.options.connectivityCheckParams)!=null?$:null,G=!(q==null?void 0:q.options.connectivityCheckUrl),J=P(P({},hW.bundledRequestImplementations),q==null?void 0:q._additionalHTTPRequestImplementations),N=J.XHRRequest,Q=J.FetchRequest,F=!!(N||Q);if(!F)throw PW();if(j.Config.xhrSupported&&N)if(this.supportsAuthHeaders=!0,this.Request=async function(B,Y,M,S,R){return new Promise((d)=>{var g;let t=N.createRequest(Y,M,S,R,a0.REQ_SEND,(g=q&&q.options.timeouts)!=null?g:null,this.logger,B);t.once("complete",(W0,Z0,I0,n,b0)=>d({error:W0,body:Z0,headers:I0,unpacked:n,statusCode:b0})),t.exec()})},q==null?void 0:q.options.disableConnectivityCheck)this.checkConnectivity=async function(){return!0};else this.checkConnectivity=async function(){var B;H.logAction(this.logger,H.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+W);let Y=await this.doUri(N0.Get,W,null,null,X),M=!1;if(!G)M=!Y.error&&VX(Y.statusCode);else M=!Y.error&&((B=Y.body)==null?void 0:B.replace(/\n/,""))=="yes";return H.logAction(this.logger,H.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+M),M};else if(j.Config.fetchSupported&&Q)if(this.supportsAuthHeaders=!0,this.Request=async(B,Y,M,S,R)=>{return Q(B,q!=null?q:null,Y,M,S,R)},q==null?void 0:q.options.disableConnectivityCheck)this.checkConnectivity=async function(){return!0};else this.checkConnectivity=async function(){var B;H.logAction(this.logger,H.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Sending; "+W);let Y=await this.doUri(N0.Get,W,null,null,null),M=!Y.error&&((B=Y.body)==null?void 0:B.replace(/\n/,""))=="yes";return H.logAction(this.logger,H.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Result: "+M),M};else this.Request=async()=>{return{error:F?new s("no supported HTTP transports available",null,400):PW()}}}get logger(){var q,$;return($=(q=this.client)==null?void 0:q.logger)!=null?$:H.defaultLogger}async doUri(q,$,W,X,G){if(!this.Request)return{error:new s("Request invoked before assigned to",null,500)};return this.Request(q,$,W,G,X)}shouldFallback(q){let $=q.statusCode;return $===408&&!q.code||$===400&&!q.code||$>=500&&$<=504}},d1.methods=[N0.Get,N0.Delete,N0.Post,N0.Put,N0.Patch],d1.methodsWithoutBody=[N0.Get,N0.Delete],d1.methodsWithBody=[N0.Post,N0.Put,N0.Patch],d1),EW=hW,Y1="ablyjs-storage-test",M1=typeof global<"u"?global:typeof window<"u"?window:self,fG=class{constructor(){try{M1.sessionStorage.setItem(Y1,Y1),M1.sessionStorage.removeItem(Y1),this.sessionSupported=!0}catch(q){this.sessionSupported=!1}try{M1.localStorage.setItem(Y1,Y1),M1.localStorage.removeItem(Y1),this.localSupported=!0}catch(q){this.localSupported=!1}}get(q){return this._get(q,!1)}getSession(q){return this._get(q,!0)}remove(q){return this._remove(q,!1)}removeSession(q){return this._remove(q,!0)}set(q,$,W){return this._set(q,$,W,!1)}setSession(q,$,W){return this._set(q,$,W,!0)}_set(q,$,W,X){let G={value:$};if(W)G.expires=Date.now()+W;return this.storageInterface(X).setItem(q,JSON.stringify(G))}_get(q,$){if($&&!this.sessionSupported)throw Error("Session Storage not supported");if(!$&&!this.localSupported)throw Error("Local Storage not supported");let W=this.storageInterface($).getItem(q);if(!W)return null;let X=JSON.parse(W);if(X.expires&&X.expires<Date.now())return this.storageInterface($).removeItem(q),null;return X.value}_remove(q,$){return this.storageInterface($).removeItem(q)}storageInterface(q){return q?M1.sessionStorage:M1.localStorage}},bW=new fG,Q0=rq(),oG=typeof EdgeRuntime==="string";if(typeof Window>"u"&&typeof WorkerGlobalScope>"u"&&!oG)console.log("Warning: this distribution of Ably is intended for browsers. On nodejs, please use the 'ably' package on npm");function nG(){let q=Q0.location;return!Q0.WebSocket||!q||!q.origin||q.origin.indexOf("http")>-1}function _G(){if(typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope)return!0;else return!1}var lG=Q0.navigator&&Q0.navigator.userAgent.toString(),tG=Q0.location&&Q0.location.href,rG={agent:"browser",logTimestamps:!0,userAgent:lG,currentUrl:tG,binaryType:"arraybuffer",WebSocket:Q0.WebSocket,fetchSupported:!!Q0.fetch,xhrSupported:Q0.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,allowComet:nG(),useProtocolHeartbeats:!0,supportsBinary:!!Q0.TextDecoder,preferBinary:!1,ArrayBuffer:Q0.ArrayBuffer,atob:Q0.atob,nextTick:typeof Q0.queueMicrotask==="function"?(q)=>Q0.queueMicrotask(q):(q)=>Promise.resolve().then(q),addEventListener:Q0.addEventListener,inspect:JSON.stringify,stringByteSize:function(q){return Q0.TextDecoder&&new Q0.TextEncoder().encode(q).length||q.length},TextEncoder:Q0.TextEncoder,TextDecoder:Q0.TextDecoder,getRandomArrayBuffer:async function(q){let $=new Uint8Array(q);return Q0.crypto.getRandomValues($),$.buffer},isWebworker:_G(),push:{platform:"browser",formFactor:"desktop",storage:bW}},kW=rG;function sG(q){let $=[80015,80017,80030];if(q.code){if(t0.isTokenErr(q))return!1;if($.includes(q.code))return!0;return q.code>=40000&&q.code<50000}else return!1}function M$(q){if(sG(q))return[E0({action:c.ERROR,error:q})];else return[E0({action:c.DISCONNECTED,error:q})]}var aG=class extends I1{constructor(q,$,W){super(q,$,W,!0);this.onAuthUpdated=(X)=>{this.authParams={access_token:X.token}},this.stream="stream"in W?W.stream:!0,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}connect(){H.logAction(this.logger,H.LOG_MINOR,"CometTransport.connect()","starting"),I1.prototype.connect.call(this);let q=this.params,$=q.options,W=q.host||$.primaryDomain,X=o.getPort($),G=$.tls?"https://":"http://";this.baseUri=G+W+":"+X+"/comet/";let J=this.baseUri+"connect";H.logAction(this.logger,H.LOG_MINOR,"CometTransport.connect()","uri: "+J),S0(this.auth.getAuthParams(),(N,Q)=>{if(N){this.disconnect(N);return}if(this.isDisposed)return;this.authParams=Q;let F=this.params.getConnectParams(Q);if("stream"in F)this.stream=F.stream;H.logAction(this.logger,H.LOG_MINOR,"CometTransport.connect()","connectParams:"+b1(F));let B=!1,Y=this.recvRequest=this.createRequest(J,null,F,null,this.stream?a0.REQ_RECV_STREAM:a0.REQ_RECV);Y.on("data",(M)=>{if(!this.recvRequest)return;if(!B)B=!0,this.emit("preconnect");this.onData(M)}),Y.on("complete",(M)=>{if(!this.recvRequest)M=M||new K("Request cancelled",80003,400);if(this.recvRequest=null,!B&&!M)B=!0,this.emit("preconnect");if(this.onActivity(),M){if(M.code)this.onData(M$(M));else this.disconnect(M);return}j.Config.nextTick(()=>{this.recv()})}),Y.exec()})}requestClose(){H.logAction(this.logger,H.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)}requestDisconnect(){H.logAction(this.logger,H.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)}_requestCloseOrDisconnect(q){let $=q?this.closeUri:this.disconnectUri;if($){let W=this.createRequest($,null,this.authParams,null,a0.REQ_SEND);W.on("complete",(X)=>{if(X)H.logAction(this.logger,H.LOG_ERROR,"CometTransport.request"+(q?"Close()":"Disconnect()"),"request returned err = "+H0(X)),this.finish("disconnected",X)}),W.exec()}}dispose(){if(H.logAction(this.logger,H.LOG_MINOR,"CometTransport.dispose()",""),!this.isDisposed){if(this.isDisposed=!0,this.recvRequest)H.logAction(this.logger,H.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null;this.finish("disconnected",X1.disconnected()),j.Config.nextTick(()=>{this.emit("disposed")})}}onConnect(q){var $;if(this.isDisposed)return;let W=($=q.connectionDetails)==null?void 0:$.connectionKey;I1.prototype.onConnect.call(this,q);let X=this.baseUri+W;H.logAction(this.logger,H.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+X),this.sendUri=X+"/send",this.recvUri=X+"/recv",this.closeUri=X+"/close",this.disconnectUri=X+"/disconnect"}send(q){if(this.sendRequest){this.pendingItems=this.pendingItems||[],this.pendingItems.push(q);return}let $=this.pendingItems||[];$.push(q),this.pendingItems=null,this.sendItems($)}sendAnyPending(){let q=this.pendingItems;if(!q)return;this.pendingItems=null,this.sendItems(q)}sendItems(q){let $=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(q),a0.REQ_SEND);$.on("complete",(W,X)=>{if(W)H.logAction(this.logger,H.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+H0(W));if(this.sendRequest=null,W){if(W.code)this.onData(M$(W));else this.disconnect(W);return}if(X)this.onData(X);if(this.pendingItems)j.Config.nextTick(()=>{if(!this.sendRequest)this.sendAnyPending()})}),$.exec()}recv(){if(this.recvRequest)return;if(!this.isConnected)return;let q=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?a0.REQ_RECV_STREAM:a0.REQ_RECV_POLL);q.on("data",($)=>{this.onData($)}),q.on("complete",($)=>{if(this.recvRequest=null,this.onActivity(),$){if($.code)this.onData(M$($));else this.disconnect($);return}j.Config.nextTick(()=>{this.recv()})}),q.exec()}onData(q){try{let $=this.decodeResponse(q);if($&&$.length)for(let W=0;W<$.length;W++)this.onProtocolMessage(H$($[W],this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin))}catch($){H.logAction(this.logger,H.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+$.stack)}}encodeRequest(q){return JSON.stringify(q)}decodeResponse(q){if(typeof q=="string")return JSON.parse(q);return q}},eG=aG;function qJ(q,$){return lq(E1($)).includes("x-ably-errorcode")}function $J(q,$){if(qJ(q,$))return q.error&&K.fromValues(q.error)}var WJ=function(){},ZJ=0,uW={};function XJ(q,$){return q.getResponseHeader&&q.getResponseHeader($)}function GJ(q){return q.getResponseHeader&&(q.getResponseHeader("transfer-encoding")||!q.getResponseHeader("content-length"))}function JJ(q){let $=q.getAllResponseHeaders().trim().split(`\r
`),W={};for(let X=0;X<$.length;X++){let G=$[X].split(":").map((J)=>J.trim());W[G[0].toLowerCase()]=G[1]}return W}var HJ=class q extends B0{constructor($,W,X,G,J,N,Q,F){super(Q);X=X||{},X.rnd=Vq(),this.uri=$+b1(X),this.headers=W||{},this.body=G,this.method=F?F.toUpperCase():h0(G)?"GET":"POST",this.requestMode=J,this.timeouts=N,this.timedOut=!1,this.requestComplete=!1,this.id=String(++ZJ),uW[this.id]=this}static createRequest($,W,X,G,J,N,Q,F){let B=N||o.TIMEOUTS;return new q($,W,v0(X),G,J,B,Q,F)}complete($,W,X,G,J){if(!this.requestComplete){if(this.requestComplete=!0,!$&&W)this.emit("data",W);this.emit("complete",$,W,X,G,J),this.dispose()}}abort(){this.dispose()}exec(){let $=this.headers,W=this.requestMode==a0.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,X=this.timer=setTimeout(()=>{this.timedOut=!0,J.abort()},W),G=this.method,J=this.xhr=new XMLHttpRequest,N=$.accept,Q=this.body,F="text";if(!N)$.accept="application/json";else if(N.indexOf("application/x-msgpack")===0)F="arraybuffer";if(Q){if(($["content-type"]||($["content-type"]="application/json")).indexOf("application/json")>-1&&typeof Q!="string")Q=JSON.stringify(Q)}if(J.open(G,this.uri,!0),J.responseType=F,"authorization"in $)J.withCredentials=!0;for(let n in $)J.setRequestHeader(n,$[n]);let B=(n,b0,Y0,o1)=>{var S1;let C$=b0+" (event type: "+n.type+")";if((S1=this==null?void 0:this.xhr)==null?void 0:S1.statusText)C$+=", current statusText is "+this.xhr.statusText;H.logAction(this.logger,H.LOG_ERROR,"Request.on"+n.type+"()",C$),this.complete(new s(C$,Y0,o1))};J.onerror=(n)=>{B(n,"XHR error occurred",null,400)},J.onabort=(n)=>{if(this.timedOut)B(n,"Request aborted due to request timeout expiring",null,408);else B(n,"Request cancelled",null,400)},J.ontimeout=(n)=>{B(n,"Request timed out",null,408)};let Y,M,S,R=0,d=!1,g=()=>{if(clearTimeout(X),S=M<400,M==204){this.complete(null,null,null,null,M);return}Y=this.requestMode==a0.REQ_RECV_STREAM&&S&&GJ(J)},t=()=>{let n;try{let Y0=XJ(J,"content-type");if(Y0?Y0.indexOf("application/json")>=0:J.responseType=="text"){let S1=J.responseType==="arraybuffer"?j.BufferUtils.utf8Decode(J.response):String(J.responseText);if(S1.length)n=JSON.parse(S1);else n=S1;d=!0}else n=J.response;if(n.response!==void 0)M=n.statusCode,S=M<400,$=n.headers,n=n.response;else $=JJ(J)}catch(Y0){this.complete(new s("Malformed response body from server: "+Y0.message,null,400));return}if(S||Array.isArray(n)){this.complete(null,n,$,d,M);return}let b0=$J(n,$);if(!b0)b0=new s("Error response received from server: "+M+" body was: "+j.Config.inspect(n),null,M);this.complete(b0,n,$,d,M)};function W0(){let n=J.responseText,b0=n.length-1,Y0,o1;while(R<b0&&(Y0=n.indexOf(`
`,R))>-1)o1=n.slice(R,Y0),R=Y0+1,Z0(o1)}let Z0=(n)=>{try{n=JSON.parse(n)}catch(b0){this.complete(new s("Malformed response body from server: "+b0.message,null,400));return}this.emit("data",n)},I0=()=>{W0(),this.streamComplete=!0,j.Config.nextTick(()=>{this.complete()})};J.onreadystatechange=()=>{let n=J.readyState;if(n<3)return;if(J.status!==0){if(M===void 0)M=J.status,g();if(n==3&&Y)W0();else if(n==4)if(Y)I0();else t()}},J.send(Q)}dispose(){let $=this.xhr;if($){$.onreadystatechange=$.onerror=$.onabort=$.ontimeout=WJ,this.xhr=null;let W=this.timer;if(W)clearTimeout(W),this.timer=null;if(!this.requestComplete)$.abort()}delete uW[this.id]}},yW=HJ,gW=R0.XhrPolling,UJ=class extends eG{constructor(q,$,W){super(q,$,W);this.shortName=gW,W.stream=!1,this.shortName=gW}static isAvailable(){return!!(j.Config.xhrSupported&&j.Config.allowComet)}toString(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected}createRequest(q,$,W,X,G){return yW.createRequest(q,$,W,X,G,this.timeouts,this.logger)}},VJ=UJ,zJ=["xhr_polling"],DJ={order:zJ,bundledImplementations:{web_socket:MW,xhr_polling:VJ}},NJ=DJ,OJ={connectivityCheckUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",wsConnectivityCheckUrl:"wss://ws-up.ably-realtime.com",defaultTransports:[R0.XhrPolling,R0.WebSocket]},QJ=OJ;function wJ(q){if(q===void 0)return"undefined";let $,W;if(q instanceof ArrayBuffer)W="ArrayBuffer",$=new DataView(q);else if(q instanceof DataView)W="DataView",$=q;if(!$)return JSON.stringify(q);let X=[];for(let G=0;G<q.byteLength;G++){if(G>20){X.push("...");break}let J=$.getUint8(G).toString(16);if(J.length===1)J="0"+J;X.push(J)}return"<"+W+" "+X.join(" ")+">"}function c1(q,$,W){for(let X=0,G=W.length;X<G;X++){let J=W.charCodeAt(X);if(J<128){q.setUint8($++,J>>>0&127|0);continue}if(J<2048){q.setUint8($++,J>>>6&31|192),q.setUint8($++,J>>>0&63|128);continue}if(J<65536){q.setUint8($++,J>>>12&15|224),q.setUint8($++,J>>>6&63|128),q.setUint8($++,J>>>0&63|128);continue}if(J<1114112){q.setUint8($++,J>>>18&7|240),q.setUint8($++,J>>>12&63|128),q.setUint8($++,J>>>6&63|128),q.setUint8($++,J>>>0&63|128);continue}throw Error("bad codepoint "+J)}}function vW(q,$,W){let X="";for(let G=$,J=$+W;G<J;G++){let N=q.getUint8(G);if((N&128)===0){X+=String.fromCharCode(N);continue}if((N&224)===192){X+=String.fromCharCode((N&15)<<6|q.getUint8(++G)&63);continue}if((N&240)===224){X+=String.fromCharCode((N&15)<<12|(q.getUint8(++G)&63)<<6|(q.getUint8(++G)&63)<<0);continue}if((N&248)===240){X+=String.fromCharCode((N&7)<<18|(q.getUint8(++G)&63)<<12|(q.getUint8(++G)&63)<<6|(q.getUint8(++G)&63)<<0);continue}throw Error("Invalid byte "+N.toString(16))}return X}function S$(q){let $=0;for(let W=0,X=q.length;W<X;W++){let G=q.charCodeAt(W);if(G<128){$+=1;continue}if(G<2048){$+=2;continue}if(G<65536){$+=3;continue}if(G<1114112){$+=4;continue}throw Error("bad codepoint "+G)}return $}function BJ(q,$){let W=f1(q,$);if(W===0)return;let X=new ArrayBuffer(W),G=new DataView(X);return x1(q,G,0,$),X}var A$=4294967296,iW=1/A$;function FJ(q,$){return $=$||0,q.getInt32($)*A$+q.getUint32($+4)}function KJ(q,$){return $=$||0,q.getUint32($)*A$+q.getUint32($+4)}function jJ(q,$,W){if(W<9223372036854776000)q.setInt32($,Math.floor(W*iW)),q.setInt32($+4,W&-1);else q.setUint32($,2147483647),q.setUint32($+4,2147483647)}function LJ(q,$,W){if(W<18446744073709552000)q.setUint32($,Math.floor(W*iW)),q.setInt32($+4,W&-1);else q.setUint32($,4294967295),q.setUint32($+4,4294967295)}var IJ=class{constructor(q,$){this.map=(W)=>{let X={};for(let G=0;G<W;G++){let J=this.parse();X[J]=this.parse()}return X},this.bin=(W)=>{let X=new ArrayBuffer(W);return new Uint8Array(X).set(new Uint8Array(this.view.buffer,this.offset,W),0),this.offset+=W,X},this.buf=this.bin,this.str=(W)=>{let X=vW(this.view,this.offset,W);return this.offset+=W,X},this.array=(W)=>{let X=Array(W);for(let G=0;G<W;G++)X[G]=this.parse();return X},this.ext=(W)=>{return this.offset+=W,{type:this.view.getInt8(this.offset),data:this.buf(W)}},this.parse=()=>{let W=this.view.getUint8(this.offset),X,G;if((W&128)===0)return this.offset++,W;if((W&240)===128)return G=W&15,this.offset++,this.map(G);if((W&240)===144)return G=W&15,this.offset++,this.array(G);if((W&224)===160)return G=W&31,this.offset++,this.str(G);if((W&224)===224)return X=this.view.getInt8(this.offset),this.offset++,X;switch(W){case 192:return this.offset++,null;case 193:this.offset++;return;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return G=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(G);case 197:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(G);case 198:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(G);case 199:return G=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(G);case 200:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(G);case 201:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(G);case 202:return X=this.view.getFloat32(this.offset+1),this.offset+=5,X;case 203:return X=this.view.getFloat64(this.offset+1),this.offset+=9,X;case 204:return X=this.view.getUint8(this.offset+1),this.offset+=2,X;case 205:return X=this.view.getUint16(this.offset+1),this.offset+=3,X;case 206:return X=this.view.getUint32(this.offset+1),this.offset+=5,X;case 207:return X=KJ(this.view,this.offset+1),this.offset+=9,X;case 208:return X=this.view.getInt8(this.offset+1),this.offset+=2,X;case 209:return X=this.view.getInt16(this.offset+1),this.offset+=3,X;case 210:return X=this.view.getInt32(this.offset+1),this.offset+=5,X;case 211:return X=FJ(this.view,this.offset+1),this.offset+=9,X;case 212:return G=1,this.offset++,this.ext(G);case 213:return G=2,this.offset++,this.ext(G);case 214:return G=4,this.offset++,this.ext(G);case 215:return G=8,this.offset++,this.ext(G);case 216:return G=16,this.offset++,this.ext(G);case 217:return G=this.view.getUint8(this.offset+1),this.offset+=2,this.str(G);case 218:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.str(G);case 219:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.str(G);case 220:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.array(G);case 221:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.array(G);case 222:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.map(G);case 223:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.map(G)}throw Error("Unknown type 0x"+W.toString(16))},this.offset=$||0,this.view=q}};function YJ(q){let $=new DataView(q),W=new IJ($),X=W.parse();if(W.offset!==q.byteLength)throw Error(q.byteLength-W.offset+" trailing bytes");return X}function mW(q,$){return Object.keys(q).filter(function(W){let X=q[W];return(!$||X!==void 0&&X!==null)&&(typeof X!=="function"||!!X.toJSON)})}function x1(q,$,W,X){let G=typeof q;if(typeof q==="string"){let J=S$(q);if(J<32)return $.setUint8(W,J|160),c1($,W+1,q),1+J;if(J<256)return $.setUint8(W,217),$.setUint8(W+1,J),c1($,W+2,q),2+J;if(J<65536)return $.setUint8(W,218),$.setUint16(W+1,J),c1($,W+3,q),3+J;if(J<4294967296)return $.setUint8(W,219),$.setUint32(W+1,J),c1($,W+5,q),5+J}if(ArrayBuffer.isView&&ArrayBuffer.isView(q))q=q.buffer;if(q instanceof ArrayBuffer){let J=q.byteLength;if(J<256)return $.setUint8(W,196),$.setUint8(W+1,J),new Uint8Array($.buffer).set(new Uint8Array(q),W+2),2+J;if(J<65536)return $.setUint8(W,197),$.setUint16(W+1,J),new Uint8Array($.buffer).set(new Uint8Array(q),W+3),3+J;if(J<4294967296)return $.setUint8(W,198),$.setUint32(W+1,J),new Uint8Array($.buffer).set(new Uint8Array(q),W+5),5+J}if(typeof q==="number"){if(Math.floor(q)!==q)return $.setUint8(W,203),$.setFloat64(W+1,q),9;if(q>=0){if(q<128)return $.setUint8(W,q),1;if(q<256)return $.setUint8(W,204),$.setUint8(W+1,q),2;if(q<65536)return $.setUint8(W,205),$.setUint16(W+1,q),3;if(q<4294967296)return $.setUint8(W,206),$.setUint32(W+1,q),5;if(q<18446744073709552000)return $.setUint8(W,207),LJ($,W+1,q),9;throw Error("Number too big 0x"+q.toString(16))}if(q>=-32)return $.setInt8(W,q),1;if(q>=-128)return $.setUint8(W,208),$.setInt8(W+1,q),2;if(q>=-32768)return $.setUint8(W,209),$.setInt16(W+1,q),3;if(q>=-2147483648)return $.setUint8(W,210),$.setInt32(W+1,q),5;if(q>=-9223372036854776000)return $.setUint8(W,211),jJ($,W+1,q),9;throw Error("Number too small -0x"+(-q).toString(16).substr(1))}if(G==="undefined"){if(X)return 0;return $.setUint8(W,212),$.setUint8(W+1,0),$.setUint8(W+2,0),3}if(q===null){if(X)return 0;return $.setUint8(W,192),1}if(G==="boolean")return $.setUint8(W,q?195:194),1;if(typeof q.toJSON==="function")return x1(q.toJSON(),$,W,X);if(G==="object"){let J,N=0,Q,F=Array.isArray(q);if(F)J=q.length;else Q=mW(q,X),J=Q.length;if(J<16)$.setUint8(W,J|(F?144:128)),N=1;else if(J<65536)$.setUint8(W,F?220:222),$.setUint16(W+1,J),N=3;else if(J<4294967296)$.setUint8(W,F?221:223),$.setUint32(W+1,J),N=5;if(F)for(let B=0;B<J;B++)N+=x1(q[B],$,W+N,X);else if(Q)for(let B=0;B<J;B++){let Y=Q[B];N+=x1(Y,$,W+N),N+=x1(q[Y],$,W+N,X)}return N}if(G==="function")return 0;throw Error("Unknown type "+G)}function f1(q,$){let W=typeof q;if(W==="string"){let X=S$(q);if(X<32)return 1+X;if(X<256)return 2+X;if(X<65536)return 3+X;if(X<4294967296)return 5+X}if(ArrayBuffer.isView&&ArrayBuffer.isView(q))q=q.buffer;if(q instanceof ArrayBuffer){let X=q.byteLength;if(X<256)return 2+X;if(X<65536)return 3+X;if(X<4294967296)return 5+X}if(typeof q==="number"){if(Math.floor(q)!==q)return 9;if(q>=0){if(q<128)return 1;if(q<256)return 2;if(q<65536)return 3;if(q<4294967296)return 5;if(q<18446744073709552000)return 9;throw Error("Number too big 0x"+q.toString(16))}if(q>=-32)return 1;if(q>=-128)return 2;if(q>=-32768)return 3;if(q>=-2147483648)return 5;if(q>=-9223372036854776000)return 9;throw Error("Number too small -0x"+q.toString(16).substr(1))}if(W==="boolean")return 1;if(q===null)return $?0:1;if(q===void 0)return $?0:3;if(typeof q.toJSON==="function")return f1(q.toJSON(),$);if(W==="object"){let X,G=0;if(Array.isArray(q)){X=q.length;for(let J=0;J<X;J++)G+=f1(q[J],$)}else{let J=mW(q,$);X=J.length;for(let N=0;N<X;N++){let Q=J[N];G+=f1(Q)+f1(q[Q],$)}}if(X<16)return 1+G;if(X<65536)return 3+G;if(X<4294967296)return 5+G;throw Error("Array or object too long 0x"+X.toString(16))}if(W==="function")return 0;throw Error("Unknown type "+W)}var R$={encode:BJ,decode:YJ,inspect:wJ,utf8Write:c1,utf8Read:vW,utf8ByteCount:S$};function MJ(q,$){return!!$.get("x-ably-errorcode")}function SJ(q,$){if(MJ(q,$))return q.error&&K.fromValues(q.error)}function AJ(q){let $={};return q.forEach((W,X)=>{$[X]=W}),$}async function RJ(q,$,W,X,G,J){let N=new Headers(X||{}),Q=q?q.toUpperCase():h0(J)?"GET":"POST",F=new AbortController,B,Y=new Promise((R)=>{B=setTimeout(()=>{F.abort(),R({error:new s("Request timed out",null,408)})},$?$.options.timeouts.httpRequestTimeout:o.TIMEOUTS.httpRequestTimeout)}),M={method:Q,headers:N,body:J,signal:F.signal};if(!j.Config.isWebworker)M.credentials=N.has("authorization")?"include":"same-origin";let S=(async()=>{try{let R=new URLSearchParams(G||{});R.set("rnd",Vq());let d=W+"?"+R,g=await rq().fetch(d,M);if(clearTimeout(B),g.status==204)return{error:null,statusCode:g.status};let t=g.headers.get("Content-Type"),W0;if(t&&t.indexOf("application/x-msgpack")>-1)W0=await g.arrayBuffer();else if(t&&t.indexOf("application/json")>-1)W0=await g.json();else W0=await g.text();let Z0=!!t&&t.indexOf("application/x-msgpack")===-1,I0=AJ(g.headers);if(!g.ok)return{error:SJ(W0,g.headers)||new s("Error response received from server: "+g.status+" body was: "+j.Config.inspect(W0),null,g.status),body:W0,headers:I0,unpacked:Z0,statusCode:g.status};else return{error:null,body:W0,headers:I0,unpacked:Z0,statusCode:g.status}}catch(R){return clearTimeout(B),{error:R}}})();return Promise.race([Y,S])}var CJ={XHRRequest:yW,FetchRequest:RJ},pW=xG(kW,CW);j.Crypto=pW,j.BufferUtils=CW,j.Http=EW,j.Config=kW,j.Transports=NJ,j.WebStorage=bW;for(let q of[N$,K$])q.Crypto=pW,q._MsgPack=R$;if(EW.bundledRequestImplementations=CJ,H.initLogHandlers(),j.Defaults=HX(QJ),j.Config.agent)j.Defaults.agent+=" "+j.Config.agent;var TJ={ErrorInfo:K,Rest:N$,Realtime:K$,msgpack:R$,makeProtocolMessageFromDeserialized:wW};if(typeof U.exports=="object"&&typeof Z=="object"){var PJ=(q,$,W,X)=>{if($&&typeof $==="object"||typeof $==="function"){for(let G of Object.getOwnPropertyNames($))if(!Object.prototype.hasOwnProperty.call(q,G)&&G!==W)Object.defineProperty(q,G,{get:()=>$[G],enumerable:!(X=Object.getOwnPropertyDescriptor($,G))||X.enumerable})}return q};U.exports=PJ(U.exports,Z)}return U.exports})});function C0(Z){if(Z==null)return Z;if(Z instanceof Function)return Z;let U=typeof Z;if(U==="string")return(z,V)=>{return O(z,Z,V)};if(U==="object")return(z,V)=>{return O(Z,z,V)};return Z}var cW=Object.prototype.hasOwnProperty;function xW(Z,U,z){for(z of Z.keys())if(n1(z,U))return z}function n1(Z,U){if(Z===U)return!0;var z,V,D;if(Z&&U&&(z=Z.constructor)===U.constructor){if(z===Array){if((V=Z.length)===U.length)while(V--&&n1(Z[V],U[V]));return V===-1}if(z===Set){if(Z.size!==U.size)return!1;for(let w of Z){if(D=w,D&&typeof D==="object"){if(D=xW(U,D),!D)return!1}if(!U.has(D))return!1}return!0}if(z===Map){if(Z.size!==U.size)return!1;for(let w of Z){if(D=w[0],D&&typeof D==="object"){if(D=xW(U,D),!D)return!1}if(!n1(V[1],U.get(D)))return!1}return!0}if(!z||typeof Z==="object"){V=0;for(let w in Z){if(cW.call(Z,w)&&++V&&!cW.call(U,w))return!1;if(!(w in U)||!n1(Z[w],U[w]))return!1}return Object.keys(U).length===V}}return!1}function gJ(Z,U){return Z.every(function(z,V){return V===0||U(Z[V-1],z)})}function oW(...Z){return gJ(Z,(U,z)=>n1(U,z))}function vJ(Z,U,z,...V){if(V.length%2!==0)throw Error("Illegal argument: assoc expects an odd number of arguments.");switch(H1(Z)){case $1:Z.set(U,z);for(let D=0;D<V.length;D+=2)Z.set(V[D],V[D+1]);break;case A1:case G1:Z[U]=z;for(let D=0;D<V.length;D+=2)Z[V[D]]=V[D+1];break;default:throw Error(`Illegal argument: assoc! expects a Map, Array, or Object as the first argument, but got ${typeof Z}.`)}return Z}function nW(Z){switch(H1(Z)){case $1:return new Map(Z);case J1:return new Z.constructor(Z);case A1:return[...Z];case G1:return{...Z};default:throw Error(`Don't know how to copy object of type ${typeof Z}.`)}}function v(Z,U,z,...V){if(!Z)Z={};let D=nW(Z);return vJ(D,U,z,...V),D}var $1=1,A1=2,G1=3,T$=4,J1=5,_W=6;function lW(Z){return Z.constructor===Object}function H1(Z){if(Z==null)return;if(lW(Z))return G1;if(Z instanceof Map)return $1;if(Z instanceof Set)return J1;if(Z instanceof Aq)return T$;if(Array.isArray(Z))return A1;if(Z instanceof Mq)return _W;if(Z instanceof Pq)return J1;if(Z instanceof Object)return G1;return}function tW(Z,U){for(let z of U)Z.add(z);return Z}function iJ(...Z){if(Z.length===0)return z1();let[U,...z]=Z,V=U;if(V===null||V===void 0)V=[];switch(H1(V)){case J1:tW(V,z);break;case T$:V.unshift(...z.reverse());break;case A1:V.push(...z);break;case $1:for(let D of z)if(!Array.isArray(D))e(D).forEach((w)=>{V.set(w[0],w[1])});else V.set(D[0],D[1]);break;case G1:for(let D of z)if(!Array.isArray(D))Object.assign(V,D);else V[D[0]]=D[1];break;default:throw Error("Illegal argument: conj! expects a Set, Array, List, Map, or Object as the first argument.")}return V}function l1(...Z){if(Z.length===0)return z1();let[U,...z]=Z,V=U;if(V===null||V===void 0)V=rJ();let D,w;switch(H1(V)){case J1:if(V instanceof Pq)return tW(new V.constructor(V),z);else return new V.constructor([...V,...z]);case T$:return new Aq(...z.reverse(),...V);case A1:return[...V,...z];case $1:D=new Map(V);for(let L of z)if(!Array.isArray(L))e(L).forEach((A)=>{D.set(A[0],A[1])});else D.set(L[0],L[1]);return D;case _W:return T0(function*(){yield*z,yield*V});case G1:w={...V};for(let L of z)if(!Array.isArray(L))Object.assign(w,L);else w[L[0]]=L[1];return w;default:throw Error("Illegal argument: conj expects a Set, Array, List, Map, or Object as the first argument.")}}function d0(Z,U){switch(H1(Z)){case J1:case $1:return Z.has(U);case void 0:return!1;default:return U in Z}}function Yq(...Z){console.log(...Z)}function a(Z,U,z){if(Z){var V=void 0;if(Array.isArray(Z))V=Z[U];else{let D=e(Z),w=0;for(let L of D)if(w++==U){V=L;break}}if(V!==void 0)return V}return z}function O(Z,U,z=void 0){if(Z==null)return z;let V;if(lW(Z))if(V=Z[U],V===void 0)return z;else return V;let D;switch(H1(Z)){case J1:if(Z.has(U))V=U;break;case $1:V=Z.get(U);break;case A1:V=Z[U];break;default:if(D=Z.get,D instanceof Function)try{V=Z.get(U);break}catch(w){}V=Z[U];break}return V!==void 0?V:z}function mJ(Z){return Z===null||Z===void 0||!!Z[Symbol.iterator]}function e(Z){if(Z===null||Z===void 0)return[];if(mJ(Z))return Z;if(Z instanceof Object)return Object.entries(Z);throw TypeError(`${Z} is not iterable`)}var pJ=Symbol("Iterable");function dJ(Z){return Z[Symbol.iterator]()}var cJ=dJ;function M0(Z){if(Z==null)return Z;let U=e(Z);if(U.length===0||U.size===0)return null;if(U[Symbol.iterator]().next().done)return null;return U}function R1(Z){let[U]=e(Z);return U}function t1(Z){let[U,z]=e(Z);return z}class _1{value;constructor(Z){this.value=Z}_deref(){return this.value}}function xJ(Z){return new _1(Z)}function fJ(Z){return Z instanceof _1}function f0(Z,U,z){Z=C0(Z);let V,D;if(arguments.length===2){let w=e(U)[Symbol.iterator](),L=w.next();if(L.done)D=Z();else D=L.value;V=w}else D=U,V=e(z);if(D instanceof _1)return D.value;for(let w of V)if(D=Z(D,w),D instanceof _1){D=D.value;break}return D}var oJ=!1;class Mq{constructor(Z){this.gen=Z,this.usages=0}[Symbol.iterator](){if(this.usages++,this.usages>=2&&oJ)try{throw Error()}catch(Z){console.warn("Re-use of lazy value",Z.stack)}return this.gen()}}Mq.prototype[pJ]=!0;function T0(Z){return new Mq(Z)}function o0(Z,...U){switch(Z=C0(Z),U.length){case 0:return(z)=>{return(...V)=>{switch(V.length){case 0:return z();case 1:return z(V[0]);case 2:return z(V[0],Z(V[1]));default:return z(V[0],Z(...V.slice(1)))}}};case 1:return T0(function*(){for(let z of e(U[0]))yield Z(z)});default:return T0(function*(){let z=U.map((V)=>cJ(e(V)));while(!0){let V=[];for(let D of z){let w=D.next();if(w.done)return;V.push(w.value)}yield Z(...V)}})}}function rW(Z){return(U)=>{return(...z)=>{switch(z.length){case 0:return U();case 1:return U(z[0]);case 2:{let V=z[0],D=z[1];if(I(Z(D)))return U(V,D);else return V}}}}}function nJ(Z,U){if(arguments.length===1)return rW(Z);return Z=C0(Z),T0(function*(){for(let z of e(U))if(I(Z(z)))yield z})}function sW(Z,U){if(arguments.length===1)return rW(fW(Z));return nJ(fW(Z),U)}function _J(Z){return(U)=>{let z=-1;return(...V)=>{switch(V.length){case 0:return U();case 1:return U(V[0]);case 2:return U(V[0],Z((z=z+1,z),V[1]))}}}}function r1(Z,U){if(Z=C0(Z),arguments.length===1)return _J(Z);return T0(function*(){let z=0;for(let V of e(U))yield Z(z,V),z++})}function lJ(Z,U){return Z=C0(Z),T0(function*(){let z=0;for(let V of e(U)){let D=Z(z,V);if(I(D))yield D;z++}})}function tJ(Z){return(U)=>{let z=-1;return(...V)=>{let D=V.length;if(D===0)return U();if(D===1)return U(V[0]);if(D===2){let w=V[0],L=V[1];z++;let A=Z(z,L);if(A==null)return w;return U(w,A)}}}}function s1(Z,U){if(arguments.length===1)return tJ(Z);else return lJ(Z,U)}function U0(...Z){return Z.join("")}function W1(Z){return!I(Z)}class aW{constructor(Z){this.val=Z,this._watches={},this._deref=()=>this.val,this._hasWatches=!1,this._reset_BANG_=(U)=>{let z=this.val;if(this.val=U,this._hasWatches)for(let V of Object.entries(this._watches)){let D=V[0],w=V[1];w(D,this,z,U)}return U},this._add_watch=(U,z)=>{this._watches[U]=z,this._hasWatches=!0},this._remove_watch=(U)=>{delete this._watches[U]}}}function U1(Z){return new aW(Z)}function b(Z){return Z._deref()}function n0(Z,U){Z._reset_BANG_(U)}function x(Z,U,...z){U=C0(U);let V=U(b(Z),...z);return n0(Z,V),V}function V1(Z,U,z){return T0(function*(){let V=Z,D=U,w=z;if(U===void 0)V=0,D=Z;let L=V||0;w=z??1;let A=w>=0;while(D===void 0||A&&L<D||!A&&D<L)yield L,L+=w})}function z1(...Z){return Z}function w0(Z){if(sJ(Z))return Z;return[...e(Z)]}function a1(Z){return new Set(e(Z))}var eW=Symbol("IApply__apply");function Sq(Z,...U){Z=C0(Z);let z=U.slice(0,U.length-1),V=e(U[U.length-1]),D=Z[eW];if(D)return D(...z,V);return Z(...z,...V)}function fW(Z){return Z=C0(Z),(...U)=>W1(Z(...U))}class Aq extends Array{constructor(...Z){super();this.push(...Z)}}function rJ(...Z){return new Aq(...Z)}function sJ(Z){return Array.isArray(Z)}function qZ(Z){return T0(function*(){for(let U of Z)yield*e(U)})}function aJ(...Z){return qZ(Z)}aJ[eW]=(Z)=>{return qZ(Z)};function Rq(...Z){let U,z,V,D,w;switch(Z.length){case 0:return[];case 1:return Z[0];case 2:return l1(Z[0]??[],...e(Z[1]));case 3:return U=Z[0],z=Z[1],V=Z[2],D=nW(U),w=(L,A)=>{if(A===void 0)return L;return iJ(L,A)},GZ(z,w,D,V);default:throw TypeError(`Invalid arity call of into: ${Z.length}`)}}function eJ(Z){if(fJ(Z))return Z;else return xJ(Z)}function q7(Z){return(U)=>{let z=Z;return(...V)=>{let D=V.length;if(D===0)return U();if(D===1){let w=V[0];return U(w)}if(D===2){let w=V[0],L=V[1],A=z,k=(z=z-1,z);if(A>0)w=U(w,L);if(!(k>0))return eJ(w);else return w}}}}function $7(Z,U){if(arguments.length===1)return q7(Z);return T0(function*(){let z=Z-1;for(let V of e(U)){if(z-->=0)yield V;if(z<0)return}})}function k0(Z,U,z,...V){return z=C0(z),v(Z,U,z(O(Z,U),...V))}function $Z(Z,U){Z=C0(Z);for(let z of e(U))if(!Z(z))return!1;return!0}function W7(Z){return(U)=>{return(...z)=>{let V=z.length;if(V===0)return U();if(V===1)return U(z[0]);if(V===2){let D=z[0],w=z[1],L=Z(w);if(L==null)return D;return U(D,L)}}}}function P$(Z,U){if(Z=C0(Z),arguments.length===1)return W7(Z);return T0(function*(){for(let z of e(U)){let V=Z(z);if(I(V))yield V}})}function h$(Z){return Z=e(Z),[...Z].reverse()}function WZ(Z,U){if(arguments.length===1)U=Z,Z=void 0;return Z=C0(Z),U=e(U),[...U].sort(Z||e1)}function Z7(Z){if(Z===e1)return Z;return(U,z)=>{let V=Z(U,z);if(J7(V))return V;if(V)return-1;if(Z(z,U))return 1;return 0}}function Cq(Z,U,z){if(arguments.length===2)z=U,U=e1;return Z=C0(Z),U=C0(U),WZ((V,D)=>{let w=Z7(U),L=Z(V),A=Z(D);return w(L,A)},z)}function E$(Z){return Math.floor(Math.random()*Z)}function X7(Z){return T0(function*(){while(!0)yield Z()})}function ZZ(Z,U){if(arguments.length===1)U=Z,Z=void 0;let z=X7(U);if(Z)return $7(Z,z);else return z}function e0(Z){if(!Z)return 0;let U=Z.length||Z.size;if(typeof U==="number")return U;let z=0;for(let V of e(Z))z++;return z}function b$(Z){return!(Z===null||Z===void 0)}function D1(Z,U,z){return Z._add_watch(U,z)}function O0(Z,U,...z){if(U==null)return Z;return Math.max(Z,U,...z)}function V0(Z,U,...z){if(U==null)return Z;return Math.min(Z,U,...z)}function G7(Z,U){return w0(U||Z)}function e1(Z,U){if(Z===U)return 0;else{if(Z==null)return-1;if(U==null)return 1;let z=typeof Z,V=typeof U;if(z==="number"&&V==="number"||z==="string"&&V==="string"){if(Z===U)return 0;if(Z<U)return-1;return 1}else if(Array.isArray(Z)&&Array.isArray(U))if(Z.length<U.length)return-1;else if(Z.length>U.length)return 1;else{for(let D=0;D<Z.length;D++){let w=e1(Z[D],U[D]);if(w!=0)return w}return 0}else throw Error(`comparing ${z} to ${V}`)}}function XZ(Z){return G7(Z)}function I(Z){return Z!=null&&Z!==!1}function C1(Z,U,z){return Z.substring(U,z)}function J7(Z){return typeof Z=="number"}function Tq(Z){if(Z==null)return;switch(H1(Z)){case G1:return Object.keys(Z);case $1:return Array.from(Z.keys())}}var uH=Symbol("meta");function GZ(Z,...U){switch(U.length){case 2:{let z=U[0],V=U[1];return GZ(Z,z,z(),V)}default:{let z=U[0],V=U[1],D=U[2];z=Z(z);let w=f0(z,V,D);return z(w)}}}class Pq{constructor(Z){if(!(Z instanceof Pq))Z=WZ(Z);let z=new Set(Z);this._elts=[...z],this._set=z}add(Z){if(this._set.has(Z))return this;let U=this._elts,z=!1;for(let V=0;V<U.length;V++)if(e1(Z,U[V])<=0){U.splice(V,0,Z),z=!0;break}if(!z)U.push(Z),this._set.add(Z);else this._set=new Set(U);return this.size=U.length,this}delete(Z){if(!this._set.has(Z))return this;let U=this._elts,z=U.indexOf(Z);return U.splice(z,1),this._set=new Set(U),this.size=U.length,this}has(Z){return this._set.has(Z)}keys(){return this.values()}values(){return this._elts[Symbol.iterator]()}entries(){return this._set.entries()}forEach(...Z){return this.set.forEach(...Z)}clear(){this._elts=[],this._set=new Set(this._elts)}[Symbol.iterator](){return this.keys()}}function JZ(){return crypto.randomUUID()}function u0(Z,U,...z){if(U===void 0)return!1;if(Z===U)return!1;for(let V of z)if(Z===V)return!1;return!0}function qq(Z){if(Z==null)return Z;if(Z instanceof Function)return Z;let U=typeof Z;if(U==="string")return(z,V)=>{return k$(z,Z,V)};if(U==="object")return(z,V)=>{return k$(Z,z,V)};return Z}function H7(Z,U,z,...V){if(V.length%2!==0)throw Error("Illegal argument: assoc expects an odd number of arguments.");switch(uq(Z)){case bq:Z.set(U,z);for(let D=0;D<V.length;D+=2)Z.set(V[D],V[D+1]);break;case $q:case hq:Z[U]=z;for(let D=0;D<V.length;D+=2)Z[V[D]]=V[D+1];break;default:throw Error(`Illegal argument: assoc! expects a Map, Array, or Object as the first argument, but got ${typeof Z}.`)}return Z}var bq=1,$q=2,hq=3,HZ=4,Eq=5,UZ=6;function kq(Z){return Z.constructor===Object}function VZ(Z){return Z!=null&&kq(Z)}function uq(Z){if(Z==null)return;if(kq(Z))return hq;if(Z instanceof Map)return bq;if(Z instanceof Set)return Eq;if(Z instanceof vq)return HZ;if(Array.isArray(Z))return $q;if(Z instanceof gq)return UZ;if(Z instanceof mq)return Eq;if(Z instanceof Object)return hq;return}function U7(Z,U){for(let z of U)Z.add(z);return Z}function zZ(...Z){if(Z.length===0)return O7();let[U,...z]=Z,V=U;if(V===null||V===void 0)V=Q7();let D,w;switch(uq(V)){case Eq:if(V instanceof mq)return U7(new V.constructor(V),z);else return new V.constructor([...V,...z]);case HZ:return new vq(...z.reverse(),...V);case $q:return[...V,...z];case bq:D=new Map(V);for(let L of z)if(!Array.isArray(L))c0(L).forEach((A)=>{D.set(A[0],A[1])});else D.set(L[0],L[1]);return D;case UZ:return QZ(function*(){yield*z,yield*V});case hq:w={...V};for(let L of z)if(!Array.isArray(L))Object.assign(w,L);else w[L[0]]=L[1];return w;default:throw Error("Illegal argument: conj expects a Set, Array, List, Map, or Object as the first argument.")}}function V7(Z,...U){for(let z of U)Z.delete(z);return Z}function DZ(Z,...U){let z=new Z.constructor([...Z]);return V7(z,...U)}function yq(Z,U,z){if(Z){var V=void 0;if(Array.isArray(Z))V=Z[U];else{let D=c0(Z),w=0;for(let L of D)if(w++==U){V=L;break}}if(V!==void 0)return V}return z}function k$(Z,U,z=void 0){if(Z==null)return z;let V;if(kq(Z))if(V=Z[U],V===void 0)return z;else return V;let D;switch(uq(Z)){case Eq:if(Z.has(U))V=U;break;case bq:V=Z.get(U);break;case $q:V=Z[U];break;default:if(D=Z.get,D instanceof Function)try{V=Z.get(U);break}catch(w){}V=Z[U];break}return V!==void 0?V:z}function NZ(Z){return Z!=null&&!!Z[Symbol.iterator]}function z7(Z){return Z===null||Z===void 0||!!Z[Symbol.iterator]}function c0(Z){if(Z===null||Z===void 0)return[];if(z7(Z))return Z;if(Z instanceof Object)return Object.entries(Z);throw TypeError(`${Z} is not iterable`)}var D7=Symbol("Iterable");class u${value;constructor(Z){this.value=Z}_deref(){return this.value}}function OZ(Z,U,z){Z=qq(Z);let V,D;if(arguments.length===2){let w=c0(U)[Symbol.iterator](),L=w.next();if(L.done)D=Z();else D=L.value;V=w}else D=U,V=c0(z);if(D instanceof u$)return D.value;for(let w of V)if(D=Z(D,w),D instanceof u$){D=D.value;break}return D}var N7=!1;class gq{constructor(Z){this.gen=Z,this.usages=0}[Symbol.iterator](){if(this.usages++,this.usages>=2&&N7)try{throw Error()}catch(Z){console.warn("Re-use of lazy value",Z.stack)}return this.gen()}}gq.prototype[D7]=!0;function QZ(Z){return new gq(Z)}function Wq(Z){return!l(Z)}function O7(...Z){return Z}function y$(Z){return uq(Z)===$q}var wZ=Symbol("IApply__apply");function BZ(Z,...U){Z=qq(Z);let z=U.slice(0,U.length-1),V=c0(U[U.length-1]),D=Z[wZ];if(D)return D(...z,V);return Z(...z,...V)}class vq extends Array{constructor(...Z){super();this.push(...Z)}}function Q7(...Z){return new vq(...Z)}function FZ(Z){return QZ(function*(){for(let U of Z)yield*c0(U)})}function w7(...Z){return FZ(Z)}w7[wZ]=(Z)=>{return FZ(Z)};function KZ(Z,U,...z){return Z=qq(Z),function(V,...D){if(!V)return Z(U,...z,...D);else return Z(V,...z,...D)}}function B7(Z,U){if(arguments.length===1)U=Z,Z=void 0;return Z=qq(Z),U=c0(U),[...U].sort(Z||v$)}function g$(Z,U,z,...V){z=qq(z);let D=k$(Z,U);return H7(Z,U,z(D,...V))}function T1(Z){if(!Z)return 0;let U=Z.length||Z.size;if(typeof U==="number")return U;let z=0;for(let V of c0(Z))z++;return z}function jZ(Z){if(Z==null)return!1;if(kq(Z))return!0;if(Z instanceof Map)return!0;return!1}function v$(Z,U){if(Z===U)return 0;else{if(Z==null)return-1;if(U==null)return 1;let z=typeof Z,V=typeof U;if(z==="number"&&V==="number"||z==="string"&&V==="string"){if(Z===U)return 0;if(Z<U)return-1;return 1}else if(Array.isArray(Z)&&Array.isArray(U))if(Z.length<U.length)return-1;else if(Z.length>U.length)return 1;else{for(let D=0;D<Z.length;D++){let w=v$(Z[D],U[D]);if(w!=0)return w}return 0}else throw Error(`comparing ${z} to ${V}`)}}function l(Z){return Z!=null&&Z!==!1}function LZ(Z,U,z){return Z.substring(U,z)}function IZ(Z){return typeof Z==="function"}function YZ(Z){return typeof Z=="number"}function iq(Z){return typeof Z==="string"}var gH=Symbol("meta");function MZ(Z){return Z===!0||Z===!1}class mq{constructor(Z){if(!(Z instanceof mq))Z=B7(Z);let z=new Set(Z);this._elts=[...z],this._set=z}add(Z){if(this._set.has(Z))return this;let U=this._elts,z=!1;for(let V=0;V<U.length;V++)if(v$(Z,U[V])<=0){U.splice(V,0,Z),z=!0;break}if(!z)U.push(Z),this._set.add(Z);else this._set=new Set(U);return this.size=U.length,this}delete(Z){if(!this._set.has(Z))return this;let U=this._elts,z=U.indexOf(Z);return U.splice(z,1),this._set=new Set(U),this.size=U.length,this}has(Z){return this._set.has(Z)}keys(){return this.values()}values(){return this._elts[Symbol.iterator]()}entries(){return this._set.entries()}forEach(...Z){return this.set.forEach(...Z)}clear(){this._elts=[],this._set=new Set(this._elts)}[Symbol.iterator](){return this.keys()}}var F7="http://www.w3.org/2000/svg",K7=function(Z){let U=(()=>{let V=Z.indexOf("#");if(V>0)return V})(),z=(()=>{let V=Z.indexOf(".");if(V>0)return V})();return[l(U)?Z.substring(0,U):l(z)?Z.substring(0,z):Z,l(U)?l(z)?Z.substring(U+1,z):Z.substring(U+1):null,l(z)?Z.substring(z+1):null]},j7=new Set(["checked","disabled","selected","value","innerHTML"]),L7=function(Z){return j7.has(Z)};var I7=function(Z){return Wq(iq(Z))&&(()=>{let U=NZ(Z);if(l(U))return Wq(y$(Z));else return U})()},SZ=function(Z,U){if(U in Z){let z=Z[U];return delete Z[U],Z[U]=z}},pq=function(Z,U){if(l((()=>{let z=Z==null;if(z)return z;else{let V=iq(Z);if(l(V))return V;else{let D=YZ(Z);if(l(D))return D;else return MZ(Z)}}})()))return{tag:"#text",text:`${Z??""}`};else if(l(y$(Z))){let z=Z[0],V=1,D=l(iq(z))?K7(z):[z],w=yq(D,0,null),L=yq(D,1,null),A=yq(D,2,null),k=l(A)?A.split("."):null,u=Z[1],h=l(jZ(u))?1:-1,P=h===-1?1:2,E=(()=>{let i=U;if(l(i))return i;else return w==="svg"})();return l(IZ(w))?(()=>{let i=BZ(w,Z.slice(1));return pq(i,E)})():(()=>{let i=[],f={type:"element",svg:E,tag:l(E)?w:w.toUpperCase(),children:i},T={},y={};f["reagami.core/props"]=T,f["reagami.core/attrs"]=y;let j=Z.length-P;for(let r=0;r<j;r++)(()=>{let _=Z[r+P];if(l(I7(_))){for(let q0 of c0(_)){let X0=q0;i.push(pq(X0,E))}return null}else return i.push(pq(_,E))})();if(h===-1);else{let r=Z[1],_=Object.getOwnPropertyNames(r),q0=_.length;if(l((()=>{let $0="max"in r;if($0)return $0;else return"min"in r})()))SZ(r,"default-value"),SZ(r,"value");let X0=q0;for(let $0=0;$0<X0;$0++)(()=>{let J0=_[$0],H=r[J0];if(J0==="on-render")return f["reagami.core/on-render"]=H;else if(l(J0.startsWith("on"))){let G0=J0.replaceAll("-","");return T[G0]=H}else if(l(J0.startsWith("default"))){let G0=LZ(J0,7).replaceAll("-","");return y[G0]=H}else if(l(J0==="style"&&VZ(H))){let G0=OZ(function(K0,K){return`${K0??""}${K[0]??""}: ${K[1]??""};`},"",Object.entries(H));return y.style=G0}else if(l(L7(J0)))return T[J0]=H;else if(l(H))return y[J0]=H})()}if(l(k!=null&&k.length>0))y.class=`${(()=>{let r=y.class;if(l(r))return`${r??""} `})()??""}${k.join(" ")??""}`;if(l(L))y.id=L;return f})()}else throw(()=>{return console.error("Invalid hiccup:",Z),Error(`Invalid hiccup: ${Z??""}`)})()},Y7=function(Z){return pq(Z,!1)},i$=new Map,m$=function(Z,U){let z=(()=>{let V=Z.text;if(l(V)){let D=V;return document.createTextNode(D)}else{let D=Z.tag,w=l(Z.svg)?document.createElementNS(F7,D):document.createElement(D),L=Z["reagami.core/props"],A=Z["reagami.core/attrs"],k=Object.getOwnPropertyNames(A),u=Object.getOwnPropertyNames(L),h=k.length;for(let i=0;i<h;i++)(()=>{let f=k[i],T=A[f];return w.setAttribute(f,T)})();let P=u.length;for(let i=0;i<P;i++)(()=>{let f=u[i],T=L[f],y=T===void 0?null:T;return w[f]=y})();let E=Z.children;if(l(E)){let i=E,T=i.length;for(let y=0;y<T;y++)(()=>{let j=i[y];return w.appendChild(m$(j,U))})()}let m=Z["reagami.core/on-render"];if(l(m)){let i=m;w["reagami.core/on-render"]=i,g$(i$,U,KZ(zZ,new Set([])),w)}return w}})();return z["reagami.core/vnode"]=Z,z},AZ=function(Z,U,z){let V=Z["reagami.core/vnode"],D=l((()=>{let w=V;if(l(w))return Wq(Z["reagami.core/root"]);else return w})())?V.children.length:z===Z?Z.childNodes.length:-1;if(D===-1)return null;else{let w=Z.childNodes,L=T1(U);if(D!==L)return Z.replaceChildren.apply(Z,U.map(function(A){return m$(A,z)}));else{let A=L;for(let k=0;k<A;k++)(()=>{let u=w[k],h=u["reagami.core/vnode"],P=U[k],E=h.text,m=P.text,i=P.tag;if(l((()=>{let f=E;if(l(f))return m;else return f})()))if(m===E)return null;else return u.textContent=m,u["reagami.core/vnode"]=P;else if(l((()=>{let f=u;if(l(f)){let T=h;if(l(T)){let y=P;if(l(y))return i===h.tag;else return y}else return T}else return f})())){let f=h["reagami.core/props"],T=h["reagami.core/attrs"],y=P["reagami.core/props"],j=P["reagami.core/attrs"],r=Object.getOwnPropertyNames(f),_=Object.getOwnPropertyNames(T),q0=Object.getOwnPropertyNames(j),X0=Object.getOwnPropertyNames(y),$0=T1(r);for(let K=0;K<$0;K++)(()=>{let s=r[K];if(s in y)return null;else return u[s]=null})();let J0=T1(_);for(let K=0;K<J0;K++)(()=>{let s=_[K];if(s in j)return null;else return u.removeAttribute(s)})();let H=T1(q0);for(let K=0;K<H;K++)(()=>{let s=q0[K],P0=j[s];if(P0===T[s])return null;else return u.setAttribute(s,P0)})();let G0=T1(X0);for(let K=0;K<G0;K++)(()=>{let s=X0[K],P0=(()=>{let p=y[s];if(p===void 0)return null;else return p})();if(f[s]===P0)return null;else return u[s]=P0})();let K0=P.children;if(l(K0))AZ(u,K0,z);return u["reagami.core/vnode"]=P}else{let f=m$(P,z);return Z.replaceChild(f,u)}})();return null}}},RZ=function(Z,U){if(l(Z["reagami.core/root"]));else Z.textContent="",Z["reagami.core/root"]=!0;let z=Y7(U);AZ(Z,[z],Z);for(let V of c0(i$.get(Z))){let D=V,w=D["reagami.core/on-render"];if(l(D.isConnected))if(Wq(w["reagami.core/is-run"])){let L=w(D,"mount",null);w["reagami.core/is-run"]=!0,w["reagami.core/data"]=L}else{let L=w(D,"update",w["reagami.core/data"]);w["reagami.core/data"]=L}else w(D,"unmount",w["reagami.core/data"]),delete w["reagami.core/data"],g$(i$,Z,DZ,D)}return null};var PZ=uJ(CZ(),1),Xq=U0(JZ()),P1=U1({ably:null,"connection-status":"initialized"}),hZ=function(){return O(b(P1),"ably")},EZ=function(){return O(b(P1),"connection-status")};var S7=PZ.default.Realtime,bZ=function(Z){let U=new S7({key:Z,clientId:Xq});return U.connection.on(function(z){let V=z.current;return x(P1,v,"connection-status",V)}),x(P1,v,"ably",U),U},N1=function(Z){return hZ().channels.get(Z)},dq=(()=>{let Z=function(...U){switch(U.length){case 1:return Z.cljs$core$IFn$_invoke$arity$1(U[0]);case 2:return Z.cljs$core$IFn$_invoke$arity$2(U[0],U[1]);default:throw Error(U0("Invalid arity: ",U.length))}};return Z.cljs$core$IFn$_invoke$arity$1=function(U){return dq(U,null)},Z.cljs$core$IFn$_invoke$arity$2=function(U,z){return N1(U).presence.enter(z).catch(function(V){return Yq("Presence enter failed:",V)})},Z.cljs$lang$maxFixedArity=2,Z})();var d$=function(Z,U){return N1(Z).presence.subscribe(function(V){return U()}),hZ().connection.once("connected",U)},c$=function(Z,U){return N1(Z).presence.get().then(function(z){return U(w0(z))}).catch(function(z){return Yq("Get presence failed:",z)})},x$=function(Z,U,z){return N1(Z).publish(U,z).catch(function(V){return Yq("Publish failed:",V)})},kZ=function(Z,U){return N1(Z).subscribe(U)};var F0={"axis-color":"#374151","grid-divisions":10,"selection-fill":"rgba(59, 130, 246, 0.2)","handle-color":"rgba(100, 100, 100, 0.4)","axis-label-color":"#6b7280","selected-stroke":"rgba(59, 130, 246, 1)","point-stroke-width":2,"foreground-grid-color":"rgba(0, 0, 0, 0.3)","handle-width":8,padding:60,"selected-stroke-width":2,"selection-stroke":"rgba(59, 130, 246, 0.8)","grid-color":"#e5e7eb","point-radius":8},R7=function(Z,U,z){return Z.fillStyle="#ffffff",Z.fillRect(0,0,U,z)},uZ=function(Z,U,z,V,D,w){let L=U-2*V,A=z-2*V,k=L/D,u=A/D;Z.strokeStyle=w,Z.lineWidth=1;for(let h of e(V1(D+1))){let E=V+h*k;Z.beginPath(),Z.moveTo(E,V),Z.lineTo(E,z-V),Z.stroke()}for(let h of e(V1(D+1))){let P=h,E=z-V-P*u;Z.beginPath(),Z.moveTo(V,E),Z.lineTo(U-V,E),Z.stroke()}return null},C7=function(Z,U,z,V){return Z.strokeStyle=O(F0,"axis-color"),Z.lineWidth=2,Z.beginPath(),Z.moveTo(V,z-V),Z.lineTo(U-V,z-V),Z.stroke(),Z.beginPath(),Z.moveTo(V,V),Z.lineTo(V,z-V),Z.stroke(),Z.fillStyle=O(F0,"axis-color"),Z.beginPath(),Z.moveTo(U-V,z-V),Z.lineTo(U-V-10,z-V-5),Z.lineTo(U-V-10,z-V+5),Z.closePath(),Z.fill(),Z.beginPath(),Z.moveTo(V,V),Z.lineTo(V-5,V+10),Z.lineTo(V+5,V+10),Z.closePath(),Z.fill()},T7=function(Z,U,z,V){return Z.fillStyle=O(F0,"axis-label-color"),Z.font="14px system-ui, sans-serif",Z.textAlign="center",Z.textBaseline="top",Z.fillText("Valid Time",U/2,z-V- -20),Z.save(),Z.translate(V-30,z/2),Z.rotate(-Math.PI/2),Z.textAlign="center",Z.textBaseline="bottom",Z.fillText("System Time",0,0),Z.restore()},P7=function(Z,U,z,V,D){let w=U-2*V,L=z-2*V,A=w/D,k=L/D,u=6;Z.fillStyle=O(F0,"axis-label-color"),Z.strokeStyle=O(F0,"axis-color"),Z.lineWidth=1,Z.font="10px system-ui, sans-serif",Z.textAlign="center",Z.textBaseline="top";for(let h of e(V1(D+1))){let P=h,E=V+P*A,m=z-V;Z.beginPath(),Z.moveTo(E,m),Z.lineTo(E,m+6),Z.stroke(),Z.fillText(U0("t",P),E,m+6+2)}Z.textAlign="right",Z.textBaseline="middle";for(let h of e(V1(D+1))){let P=h,E=V,m=z-V-P*k;Z.beginPath(),Z.moveTo(E,m),Z.lineTo(E-6,m),Z.stroke(),Z.fillText(U0("t",P),E-6-2,m)}return null},yZ=function(Z){let U=Z,z=a(U,0,null),V=a(U,1,null),D=a(U,2,null);return U0("rgb(",z,",",V,",",D,")")};var h7=function(Z,U,z,V,D,w){let L=U,A=O(L,"_valid_from"),k=O(L,"_valid_to"),u=O(L,"_system_from"),h=O(L,"color"),P=k==null,E=z-2*D,m=V-2*D,i=O(F0,"handle-width"),f=D+A*E,T=D+(P?1:k)*E,y=V-D-u*m,j=D;if(Z.fillStyle=yZ(h),Z.fillRect(f,j,T-f,y-j),I(w))Z.strokeStyle=O(F0,"selected-stroke"),Z.lineWidth=O(F0,"selected-stroke-width");else Z.strokeStyle="#000000",Z.lineWidth=1;if(Z.beginPath(),Z.moveTo(f,j),Z.lineTo(f,y),Z.lineTo(T,y),P);else Z.lineTo(T,j);if(Z.stroke(),P)return null;else return Z.fillStyle=O(F0,"handle-color"),Z.fillRect(T-i,j,i,y-j)},E7=function(Z,U,z,V,D,w){let L=r1(z1,U),A=Cq(function(k){return O(t1(k),"_system_from")},L);for(let k of e(A)){let u=k,h=a(u,0,null),P=a(u,1,null);h7(Z,P,z,V,D,d0(w,h))}return null},b7=function(Z,U,z,V,D,w){let L=U,A=O(L,"x"),k=O(L,"y"),u=O(L,"color"),h=z-2*D,P=V-2*D,E=O(F0,"point-radius"),m=D+A*h,i=V-D-k*P;if(Z.fillStyle=yZ(u),Z.beginPath(),Z.arc(m,i,E,0,2*Math.PI),Z.fill(),I(w))Z.strokeStyle=O(F0,"selected-stroke"),Z.lineWidth=O(F0,"selected-stroke-width");else Z.strokeStyle="#000000",Z.lineWidth=1;return Z.stroke()},k7=function(Z,U,z,V,D,w){for(let L of e(r1(z1,U))){let A=L,k=a(A,0,null),u=a(A,1,null);b7(Z,u,z,V,D,d0(w,k))}return null},u7=function(Z,U,z,V,D){if(I(D)){let w=D,L=O(w,"start"),A=O(w,"end"),k=U-2*V,u=z-2*V,h=V+O(L,"x")*k,P=z-V-O(L,"y")*u,E=V+O(A,"x")*k,m=z-V-O(A,"y")*u,i=V0(h,E),f=V0(P,m),T=Math.abs(E-h),y=Math.abs(m-P);return Z.fillStyle=O(F0,"selection-fill"),Z.fillRect(i,f,T,y),Z.strokeStyle=O(F0,"selection-stroke"),Z.lineWidth=1,Z.strokeRect(i,f,T,y)}},gZ=function(Z,U,z){if(I(Z)){let V=Z.getContext("2d"),D=Z.width,w=Z.height,L=O(F0,"padding"),A=O(F0,"grid-divisions"),k=O(z,"show-grid",!1),u=O(z,"show-ticks",!1),h=O(z,"selection-box"),P=(()=>{let i=O(z,"selected");if(I(i))return i;else return new Set([])})(),E=(()=>{let i=O(z,"points");if(I(i))return i;else return[]})(),m=(()=>{let i=O(z,"selected-points");if(I(i))return i;else return new Set([])})();if(R7(V,D,w),uZ(V,D,w,L,A,O(F0,"grid-color")),C7(V,D,w,L),T7(V,D,w,L),I(u))P7(V,D,w,L,A);if(E7(V,U,D,w,L,P),k7(V,E,D,w,L,m),I(k))uZ(V,D,w,L,A,O(F0,"foreground-grid-color"));return u7(V,D,w,L,h)}};var g7="Vr1zhQ.IsKO2g:nY_BkeBtmxQxs0W_MYZNkx-34cZBzzNLOrrAARrygfQ",l$="global",dZ="bitemporal-visualizer",cZ="bitemporal-saved-states",v7=function(){return Sq(U0,ZZ(6,function(){return a("ABCDEFGHJKLMNPQRSTUVWXYZ23456789",E$(e0("ABCDEFGHJKLMNPQRSTUVWXYZ23456789")))}))},Jq=function(Z){return U0("room:",Z)},i7=[{_valid_from:0.1,_valid_to:0.4,_system_from:0.1,color:[59,130,246]},{_valid_from:0.2,_valid_to:0.6,_system_from:0.2,color:[34,197,94]},{_valid_from:0.3,_valid_to:0.7,_system_from:0.3,color:[249,115,22]},{_valid_from:0.1,_valid_to:0.5,_system_from:0.4,color:[168,85,247]},{_valid_from:0.5,_valid_to:0.9,_system_from:0.5,color:[236,72,153]}],f$={"show-grid":!1,"snap-to-grid":!1,"show-ticks":!1},m7=function(Z){return localStorage.setItem(dZ,JSON.stringify(Z))},p7=function(){let Z=localStorage.getItem(dZ);if(I(Z))return JSON.parse(Z)},d7=function(){let Z=p7();return{events:(()=>{let U=O(Z,"events");if(I(U))return U;else return i7})(),points:(()=>{let U=O(Z,"points");if(I(U))return U;else return[]})(),"show-grid":O(Z,"show-grid",O(f$,"show-grid")),"snap-to-grid":O(Z,"snap-to-grid",O(f$,"snap-to-grid")),"show-ticks":O(Z,"show-ticks",O(f$,"show-ticks"))}},c7=function(Z){return localStorage.setItem(cZ,JSON.stringify(Z))},x7=function(){let Z=localStorage.getItem(cZ);if(I(Z))return JSON.parse(Z)},Gq=d7(),f7=(()=>{let Z=x7();if(I(Z))return Z;else return[]})(),C=U1({"snap-to-grid":O(Gq,"snap-to-grid"),syncing:!1,"room-code":v7(),events:O(Gq,"events"),"global-count":0,"dml-end-date":"2025-01-01",points:O(Gq,"points"),"auto-select":!0,"show-ticks":O(Gq,"show-ticks"),"room-count":0,"show-grid":O(Gq,"show-grid"),"current-tool":"select","dml-start-date":"2024-01-01","saved-states":f7}),t$=U1(null);D1(C,"app.app/persist",function(Z,U,z,V){if(I((()=>{let D=u0(O(z,"events"),O(V,"events"));if(I(D))return D;else{let w=u0(O(z,"points"),O(V,"points"));if(I(w))return w;else{let L=u0(O(z,"show-grid"),O(V,"show-grid"));if(I(L))return L;else{let A=u0(O(z,"snap-to-grid"),O(V,"snap-to-grid"));if(I(A))return A;else return u0(O(z,"show-ticks"),O(V,"show-ticks"))}}}})()))return m7({events:O(V,"events"),points:O(V,"points"),"show-grid":O(V,"show-grid"),"snap-to-grid":O(V,"snap-to-grid"),"show-ticks":O(V,"show-ticks")})});D1(C,"app.app/persist-saved-states",function(Z,U,z,V){if(I(u0(O(z,"saved-states"),O(V,"saved-states"))))return c7(O(V,"saved-states"))});var z0=U1({"select-start":null,"point-offsets":null,selected:new Set([]),"dragging-point":null,"multi-offsets":null,"offset-y":0,mode:null,"selected-points":new Set([]),dragging:null,"offset-x":0,"select-end":null}),h1=U1({open:!1,x:0,y:0,"target-indices":new Set([]),"target-point-indices":new Set([])}),Hq=function(){return n0(h1,{open:!1,x:0,y:0,"target-indices":new Set([]),"target-point-indices":new Set([])})},O1=60,o7=8,vZ=8,cq=0.05,n7=10,_0=function(Z){let U=1/n7;return U*Math.round(Z/U)},y0=function(Z){let U=Z.parentElement,z=U.clientWidth,V=U.clientHeight,D=b(z0),w=O(D,"mode"),L=O(D,"select-start"),A=O(D,"select-end"),k=O(D,"selected"),u=O(D,"selected-points");if(I((()=>{let h=z>0;if(h)return V>0;else return h})()))return Z.width=z,Z.height=V,gZ(Z,O(b(C),"events"),{"show-grid":O(b(C),"show-grid"),"show-ticks":O(b(C),"show-ticks"),"selection-box":I((()=>{let h=w==="select";if(I(h))return h;else return w==="draw"})())?{start:L,end:A}:null,selected:k,points:O(b(C),"points"),"selected-points":u})},r$=function(Z,U,z){let V=Z.getBoundingClientRect(),D=U-V.left,w=z-V.top,L=Z.width,A=Z.height,k=L-2*O1,u=A-2*O1,h=(D-O1)/k,P=1-(w-O1)/u;return{x:h,y:P}},s$=function(Z,U,z,V){let w=Z.width-2*O1,L=o7/w,A=h$(o0(R1,Cq(function(k){return O(t1(k),"_system_from")},r1(z1,U))));return R1(P$(function(k){let h=a(U,k),P=O(h,"_valid_from"),E=O(h,"_valid_to"),m=O(h,"_system_from"),i=E==null,f=i?1:E;if(I((()=>{let T=z>=P;if(T){let y=z<=f;if(y)return V>=m;else return y}else return T})()))return{index:k,"on-handle":(()=>{let T=!i;if(T)return z>=f-L;else return T})()}},A))},a$=function(Z,U,z,V){let{width:D,height:w}=Z,L=D-2*O1,A=w-2*O1,k=vZ/L,u=vZ/A;return R1(P$(function(h){let E=a(U,h),m=O(E,"x"),i=O(E,"y"),f=z-m,T=V-i;if(f*f/(k*k)+T*T/(u*u)<=1)return{index:h}},h$(V1(e0(U)))))},_7=function(Z,U){if(I(O(b(h1),"open")))Hq();if(U.button===0){let z=r$(Z,U.clientX,U.clientY),V=O(z,"x"),D=O(z,"y"),w=O(b(C),"events"),L=O(b(C),"points"),A=O(b(z0),"selected"),k=O(b(z0),"selected-points"),u=O(b(C),"current-tool");if(I(u==="rectangle"))return n0(z0,{"select-start":{x:V,y:D},selected:new Set([]),"dragging-point":null,"offset-y":0,mode:"draw","selected-points":new Set([]),dragging:null,"offset-x":0,"select-end":{x:V,y:D}});else if(I(u==="point")){if(x(C,k0,"points",l1,{x:V,y:D,color:xZ}),I(O(b(C),"auto-select")))x(C,v,"current-tool","select");return y0(Z)}else{let h=a$(Z,L,V,D),P=s$(Z,w,V,D);if(I(h)){let m=O(h,"index"),i=a(L,m);if(I((()=>{let f=d0(k,m);if(I(f))return e0(k)>1;else return f})())){let f=Rq({},o0(function(T){let y=a(L,T);return[T,{"offset-x":V-O(y,"x"),"offset-y":D-O(y,"y")}]},k));return x(z0,v,"dragging-point",m,"mode","move-points","point-offsets",f)}else return x(z0,v,"dragging-point",m,"mode","move-point","offset-x",V-O(i,"x"),"offset-y",D-O(i,"y"),"selected",new Set([]),"selected-points",new Set([m]))}else if(I(P)){let E=P,m=O(E,"index"),i=O(E,"on-handle"),T=a(w,m),y=O(T,"_valid_from"),j=O(T,"_valid_to"),r=O(T,"_system_from");if(I(i))if(I((()=>{let _=d0(A,m);if(I(_))return e0(A)>1;else return _})())){let _=o0(function(H){return a(w,H)},A),q0=Sq(V0,o0("_valid_from",_)),$0=Sq(O0,o0("_valid_to",_))-q0,J0=Rq({},o0(function(H){let G0=a(w,H);return[H,{_valid_from:O(G0,"_valid_from"),_valid_to:O(G0,"_valid_to")}]},A));return x(z0,v,"dragging",m,"mode","resize-multi","offset-x",j-V,"anchor-point",q0,"original-span",$0,"original-positions",J0)}else return x(z0,v,"dragging",m,"mode","resize","offset-x",j-V,"offset-y",0);else if(I((()=>{let _=d0(A,m);if(I(_))return e0(A)>1;else return _})())){let _=Rq({},o0(function(q0){let X0=a(w,q0);return[q0,{"offset-x":V-O(X0,"_valid_from"),"offset-y":O(X0,"_system_from")-D}]},A));return x(z0,v,"dragging",m,"mode","move-multi","multi-offsets",_)}else return x(z0,v,"dragging",m,"mode","move","offset-x",V-y,"offset-y",r-D,"selected",new Set([m]),"selected-points",new Set([]))}else return n0(z0,{"select-start":{x:V,y:D},selected:new Set([]),"dragging-point":null,"offset-y":0,mode:"select","selected-points":new Set([]),dragging:null,"offset-x":0,"select-end":{x:V,y:D}})}}},l7=function(Z,U,z){let V=V0(O(U,"x"),O(z,"x")),D=O0(O(U,"x"),O(z,"x")),w=V0(O(U,"y"),O(z,"y")),L=O0(O(U,"y"),O(z,"y"));return a1(s1(function(A,k){let u=k,h=O(u,"_valid_from"),P=O(u,"_valid_to"),E=O(u,"_system_from"),m=P==null?1:P;if(I((()=>{let i=h<D;if(i){let f=m>V;if(f){let T=E<=L;if(T)return 1>=w;else return T}else return f}else return i})()))return A},Z))},t7=function(Z,U,z){let V=V0(O(U,"x"),O(z,"x")),D=O0(O(U,"x"),O(z,"x")),w=V0(O(U,"y"),O(z,"y")),L=O0(O(U,"y"),O(z,"y"));return a1(s1(function(A,k){let u=k,h=O(u,"x"),P=O(u,"y");if(I((()=>{let E=h>=V;if(E){let m=h<=D;if(m){let i=P>=w;if(i)return P<=L;else return i}else return m}else return E})()))return A},Z))},r7=function(Z,U){let z=r$(Z,U.clientX,U.clientY),V=O(z,"x"),D=O(z,"y"),w=b(z0),L=O(w,"select-start"),A=O(w,"point-offsets"),k=O(w,"selected"),u=O(w,"multi-offsets"),h=O(w,"dragging-point"),P=O(w,"offset-y"),E=O(w,"mode"),m=O(w,"dragging"),i=O(w,"offset-x"),f=O(b(C),"current-tool");if(I((()=>{let T=f==="rectangle";if(I(T))return T;else return f==="point"})()))Z.style.cursor="crosshair";else if(I(E==="select"))Z.style.cursor="crosshair";else if(I((()=>{let T=m;if(I(T))return T;else return h})()))Z.style.cursor=I((()=>{let T=E==="resize";if(I(T))return T;else return E==="resize-multi"})())?"ew-resize":"move";else{let T=a$(Z,O(b(C),"points"),V,D),y=s$(Z,O(b(C),"events"),V,D);Z.style.cursor=I(T)?"move":I((()=>{let j=y;if(I(j))return O(y,"on-handle");else return j})())?"ew-resize":I(y)?"move":"crosshair"}if(I(E==="draw"))return x(z0,v,"select-end",{x:V,y:D}),y0(Z);else if(I(E==="select")){let T=O(b(C),"events"),y=O(b(C),"points"),j=l7(T,L,{x:V,y:D}),r=t7(y,L,{x:V,y:D});return x(z0,v,"select-end",{x:V,y:D},"selected",j,"selected-points",r),y0(Z)}else if(I((()=>{let T=h;if(I(T))return E==="move-point";else return T})())){let T=w0(O(b(C),"points")),y=a(T,h),j=O(b(C),"snap-to-grid"),r=V-i,_=D-P,q0=O0(0,V0(1,r)),X0=O0(0,V0(1,_)),$0=I(j)?_0(q0):q0,J0=I(j)?_0(X0):X0,H=v(y,"x",$0,"y",J0),G0=v(T,h,H);return x(C,v,"points",G0),y0(Z)}else if(I((()=>{let T=h;if(I(T))return E==="move-points";else return T})())){let T=w0(O(b(C),"points")),y=O(b(C),"snap-to-grid"),j=f0(function(r,_){let q0=a(r,_),X0=O(A,_),$0=O(X0,"offset-x"),J0=O(X0,"offset-y"),H=V-$0,G0=D-J0,K0=O0(0,V0(1,H)),K=O0(0,V0(1,G0)),s=I(y)?_0(K0):K0,P0=I(y)?_0(K):K,p=v(q0,"x",s,"y",P0);return v(r,_,p)},T,Tq(A));return x(C,v,"points",j),y0(Z)}else if(I((()=>{let T=m;if(I(T))return E==="resize";else return T})())){let T=O(b(C),"events"),y=a(T,m),j=O(b(C),"snap-to-grid"),r=V+i,_=I(j)?_0(r):r,q0=O(y,"_valid_from")+cq,X0=O0(q0,V0(1,_)),$0=v(y,"_valid_to",X0),J0=v(w0(T),m,$0);return x(C,v,"events",J0),y0(Z)}else if(I((()=>{let T=m;if(I(T))return E==="resize-multi";else return T})())){let T=b(z0),y=O(T,"anchor-point"),j=O(T,"original-span"),r=O(T,"original-positions"),_=w0(O(b(C),"events")),q0=O(b(C),"snap-to-grid"),X0=V+i,$0=I(q0)?_0(X0):X0,G0=(O0(y+cq,V0(1,$0))-y)/j,K0=f0(function(K,s){let P0=a(K,s),p=O(r,s),v0=O(p,"_valid_from"),Q1=O(p,"_valid_to"),l0=y+(v0-y)*G0,fq=y+(Q1-y)*G0,h0=O0(l0+cq,fq),oq=v(P0,"_valid_from",l0,"_valid_to",V0(1,h0));return v(K,s,oq)},_,Tq(r));return x(C,v,"events",K0),y0(Z)}else if(I((()=>{let T=m;if(I(T))return E==="move-multi";else return T})())){let T=w0(O(b(C),"events")),y=O(b(C),"snap-to-grid"),j=f0(function(r,_){let q0=a(r,_),X0=O(u,_),$0=O(X0,"offset-x"),J0=O(X0,"offset-y"),H=O(q0,"_valid_to")==null,G0=H?0:O(q0,"_valid_to")-O(q0,"_valid_from"),K0=V-$0,K=D+J0,s=I(y)?_0(K0):K0,P0=I(y)?_0(K):K,p=O0(0,V0(1-G0,s)),v0=O0(0,V0(1,P0)),Q1=H?v(q0,"_valid_from",p,"_system_from",v0):v(q0,"_valid_from",p,"_valid_to",p+G0,"_system_from",v0);return v(r,_,Q1)},T,Tq(u));return x(C,v,"events",j),y0(Z)}else if(I((()=>{let T=m;if(I(T))return E==="move";else return T})())){let T=O(b(C),"events"),y=a(T,m),j=O(b(C),"snap-to-grid"),r=O(y,"_valid_to")==null,_=r?0:O(y,"_valid_to")-O(y,"_valid_from"),q0=V-i,X0=D+P,$0=I(j)?_0(q0):q0,J0=I(j)?_0(X0):X0,H=O0(0,V0(1-_,$0)),G0=O0(0,V0(1,J0)),K0=r?v(y,"_valid_from",H,"_system_from",G0):v(y,"_valid_from",H,"_valid_to",H+_,"_system_from",G0),K=v(w0(T),m,K0);return x(C,v,"events",K),y0(Z)}else return null},xZ=[100,116,139],s7=function(Z,U){let z=V0(O(Z,"x"),O(U,"x")),V=O0(O(Z,"x"),O(U,"x")),D=V0(O(Z,"y"),O(U,"y")),w=V-z,L=O0(0,z),A=V0(1,L+O0(cq,w)),k=O0(0,V0(1,D));return x(C,k0,"events",l1,{_valid_from:L,_valid_to:A,_system_from:k,color:xZ})},a7=function(Z,U){let z=b(z0),V=O(z,"mode"),D=O(z,"select-start"),w=O(z,"select-end"),L=O(z,"selected"),A=O(z,"selected-points");if(I((()=>{let k=V==="draw";if(I(k)){let u=D;if(I(u))return w;else return u}else return k})())){let k=Math.abs(O(w,"x")-O(D,"x")),u=Math.abs(O(w,"y")-O(D,"y"));if(I((()=>{let h=k>0.02;if(h)return h;else return u>0.02})())){if(s7(D,w),I(O(b(C),"auto-select")))x(C,v,"current-tool","select")}}return n0(z0,{"select-start":null,selected:L,"dragging-point":null,"offset-y":0,mode:null,"selected-points":A,dragging:null,"offset-x":0,"select-end":null}),y0(Z)},e7=function(Z,U){U.preventDefault();let z=r$(Z,U.clientX,U.clientY),V=O(z,"x"),D=O(z,"y"),w=O(b(C),"events"),L=O(b(C),"points"),A=a$(Z,L,V,D),k=s$(Z,w,V,D),u=O(b(z0),"selected"),h=O(b(z0),"selected-points");if(I(A)){let P=O(A,"index"),E=d0(h,P);return n0(h1,{open:!0,x:U.clientX,y:U.clientY,"target-indices":I(E)?u:new Set([]),"target-point-indices":I(E)?h:new Set([P])})}else if(I(k)){let P=O(k,"index"),E=d0(u,P);return n0(h1,{open:!0,x:U.clientX,y:U.clientY,"target-indices":I(E)?u:new Set([P]),"target-point-indices":I(E)?h:new Set([])})}else return null},qH=function(Z){let U=Z.key,z=O(b(z0),"selected"),V=O(b(z0),"selected-points");if(I((()=>{let D=(()=>{let w=U==="Delete";if(I(w))return w;else return U==="Backspace"})();if(I(D)){let w=M0(z);if(I(w))return w;else return M0(V)}else return D})())){if(Z.preventDefault(),I(M0(z)))fZ(z);if(I(M0(V)))return oZ(V)}},$H=function(Z,U,z){switch(U){case"mount":let D=function(){return y0(Z)},w=function(h){return _7(Z,h)},L=function(h){return r7(Z,h)},A=function(h){return a7(Z,h)},k=function(h){return e7(Z,h)},u=qH;return window.addEventListener("resize",D),Z.addEventListener("mousedown",w),window.addEventListener("mousemove",L),window.addEventListener("mouseup",A),Z.addEventListener("contextmenu",k),window.addEventListener("keydown",u),n0(t$,Z),y0(Z),{resize:D,mousedown:w,mousemove:L,mouseup:A,contextmenu:k,keydown:u};break;case"update":return y0(Z);case"unmount":return n0(t$,null)}},WH=function(){let Z=EZ();if(I(u0(Z,"connected")))return["div",{class:"fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded-full shadow-lg animate-pulse z-10"},(()=>{switch(Z){case"initialized":return"Connecting...";case"connecting":return"Connecting...";case"disconnected":return"Disconnected";case"suspended":return"Connection suspended";case"failed":return"Connection failed";case"closing":return"Closing...";case"closed":return"Closed";default:return U0("Status: ",Z)}})()]},ZH=function(){let Z=b(C),U=O(Z,"room-count"),z=O(Z,"global-count");return["div",{class:"fixed bottom-4 right-4 px-3 py-2 bg-white rounded-lg shadow-md text-sm text-gray-600 z-10"},["span",{class:"inline-flex items-center gap-2"},["span",{class:"w-2 h-2 bg-green-500 rounded-full"}],U0(U,"/",z," online")]]},XH=function(){return x(C,k0,"show-grid",W1)},GH=function(){return x(C,k0,"snap-to-grid",W1)},JH=function(){return x(C,k0,"show-ticks",W1)},HH=[[59,130,246],[34,197,94],[249,115,22],[168,85,247],[236,72,153]],iZ=function(Z){let U=Z,z=a(U,0,null),V=a(U,1,null),D=a(U,2,null);return U0("rgb(",z,",",V,",",D,")")},uU=function(Z){let U=Z,z=a(U,0,null),V=a(U,1,null),D=a(U,2,null);return U0("#",z.toString(16).padStart(2,"0"),V.toString(16).padStart(2,"0"),D.toString(16).padStart(2,"0"))},UH=function(Z){let U=I(R1(Z)==="#")?C1(Z,1):Z,z=parseInt(C1(U,0,2),16),V=parseInt(C1(U,2,4),16),D=parseInt(C1(U,4,6),16);return[z,V,D]},yU=function(Z,U){let z=w0(O(b(C),"events")),V=f0(function(D,w){return k0(D,w,v,"color",U)},z,Z);return x(C,v,"events",V),Hq()},gU=function(Z,U){let z=w0(O(b(C),"points")),V=f0(function(D,w){return k0(D,w,v,"color",U)},z,Z);return x(C,v,"points",V),Hq()},VH=function(Z,U){let z=w0(O(b(C),"events")),V=f0(function(D,w){let L=a(D,w);if(I(U))return v(D,w,v(L,"_valid_to",null));else{let A=V0(1,O(L,"_valid_from")+0.2);return v(D,w,v(L,"_valid_to",A))}},z,Z);return x(C,v,"events",V)},fZ=function(Z){if(I(M0(Z))){let U=O(b(C),"events"),z=a1(Z),V=w0(s1(function(D,w){if(I(d0(z,D)))return null;else return w},U));return x(z0,v,"selected",new Set([])),x(C,v,"events",V)}},oZ=function(Z){if(I(M0(Z))){let U=O(b(C),"points"),z=a1(Z),V=w0(s1(function(D,w){if(I(d0(z,D)))return null;else return w},U));return x(z0,v,"selected-points",new Set([])),x(C,v,"points",V)}},mZ=function(Z,U,z){if(I(M0(Z))){let V=w0(O(b(C),"events")),D=f0(function(w,L){return k0(w,L,v,"color",z)},V,Z);x(C,v,"events",D)}if(I(M0(U))){let V=w0(O(b(C),"points")),D=f0(function(w,L){return k0(w,L,v,"color",z)},V,U);x(C,v,"points",D)}return Hq()},zH=function(Z,U){if(I(M0(Z)))fZ(Z);if(I(M0(U)))oZ(U);return Hq()},DH=function(){let Z=b(h1),U=O(Z,"open"),z=O(Z,"x"),V=O(Z,"y"),D=O(Z,"target-indices"),w=O(Z,"target-point-indices"),L=O(b(C),"events"),A=M0(D),k=M0(w),u=(()=>{let h=A;if(I(h))return $Z(function(P){return O(a(L,P),"_valid_to")==null},D);else return h})();if(I(U))return["div",{class:"fixed bg-white rounded-lg shadow-xl border border-gray-200 p-2 z-50",style:{left:U0(z,"px"),top:U0(V,"px")}},["div",{class:"flex gap-1 items-center"},T0(function*(){for(let h of e(HH)){let P=h;yield["button",{key:iZ(P),class:"w-6 h-6 rounded border border-gray-300 hover:scale-110 transition-transform cursor-pointer",style:{"background-color":iZ(P)},"on-click":function(){return mZ(D,w,P)}}]}}),["input",{type:"color",class:"w-6 h-6 rounded cursor-pointer border-0 p-0","on-change":function(h){return mZ(D,w,UH(h.target.value))}}]],I(A)?["div",["div",{class:"h-px bg-gray-200 my-2"}],["label",{class:"flex items-center gap-2 text-sm text-gray-700 cursor-pointer select-none px-1"},["input",{type:"checkbox",checked:u,"on-change":function(){return VH(D,W1(u))},class:"w-4 h-4 cursor-pointer"}],"Open"]]:null,["div",{class:"h-px bg-gray-200 my-2"}],["button",{class:"w-full text-left text-sm text-red-600 hover:bg-red-50 px-1 py-1 rounded cursor-pointer","on-click":function(){return zH(D,w)}},"Delete"]]},o$=function(Z){return x(C,v,"current-tool",Z)},NH=function(){let Z=O(b(C),"current-tool");return["div",{class:"absolute top-2 left-2 bg-white rounded-lg shadow-lg border border-gray-200 p-1 flex flex-col gap-1 z-10"},["button",{class:U0("w-8 h-8 rounded flex items-center justify-center transition-colors ",I(Z==="select")?"bg-blue-500 text-white":"hover:bg-gray-100 text-gray-600"),title:"Select","on-click":function(){return o$("select")}},["svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},["path",{d:"M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"}],["path",{d:"M13 13l6 6"}]]],["button",{class:U0("w-8 h-8 rounded flex items-center justify-center transition-colors ",I(Z==="rectangle")?"bg-blue-500 text-white":"hover:bg-gray-100 text-gray-600"),title:"Rectangle","on-click":function(){return o$("rectangle")}},["svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},["rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}]]],["button",{class:U0("w-8 h-8 rounded flex items-center justify-center transition-colors ",I(Z==="point")?"bg-blue-500 text-white":"hover:bg-gray-100 text-gray-600"),title:"Point","on-click":function(){return o$("point")}},["svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},["circle",{cx:"12",cy:"12",r:"4"}]]]]},OH=function(){return x(C,k0,"auto-select",W1)},QH=function(){let Z=prompt("Enter room code to join:");if(I(Z)){let z=C1(Z.trim().toUpperCase(),0,6);if(I((()=>{let V=M0(z);if(I(V))return e0(z)>=4;else return V})()))return _Z(z)}},wH=function(){let Z=O(b(C),"room-code");return navigator.clipboard.writeText(Z).then(function(){return console.log("Copied room code:",Z)}).catch(function(U){return console.error("Failed to copy:",U)})},pZ=function(Z){let U=o0(parseInt,Z.split("-")),z=a(U,0,null),V=a(U,1,null),D=a(U,2,null);return new Date(Date.UTC(z,V-1,D))},n$=function(Z){let U=Z.getUTCFullYear(),z=Z.getUTCMonth()+1,V=Z.getUTCDate(),D=function(w){return U0(w).padStart(2,"0")};return U0(U,"-",D(z),"-",D(V))},_$=function(Z,U,z){let V=U.getTime(),w=z.getTime()-V,L=V+w*Z;return new Date(L)},BH=function(Z,U,z){let V=Z,D=O(V,"_valid_from"),w=O(V,"_valid_to"),L=O(V,"_system_from"),A=O(V,"color"),k=n$(_$(D,U,z)),u=n$(_$(L,U,z)),h=w==null,P=U0("[",R1(A),", ",t1(A),", ",a(A,2),"]");return U0("BEGIN READ WRITE WITH (SYSTEM_TIME = DATE '",u,`');
`,"INSERT INTO docs RECORDS {_id: 1, _valid_from: DATE '",k,"', ",h?null:(()=>{let E=n$(_$(w,U,z));return U0("_valid_to: DATE '",E,"', ")})(),"color: ",P,`};
`,"COMMIT;")},FH=function(){let Z=O(b(C),"events"),U=pZ(O(b(C),"dml-start-date")),z=pZ(O(b(C),"dml-end-date")),V=o0(function(D){return BH(D,U,z)},Z);return XZ(V).join(`

`)},KH=function(){let Z=FH();return navigator.clipboard.writeText(Z).then(function(){return console.log("Copied DML to clipboard")}).catch(function(U){return console.error("Failed to copy DML:",U)})},jH=function(){return U0(Date.now(),"-",E$(1e4))},LH=function(){let Z=b(t$);if(I(Z)){let U=Z,z=120,V=80,D=document.createElement("canvas"),w=D.getContext("2d");return D.width=120,D.height=80,w.drawImage(U,0,0,120,80),D.toDataURL("image/png",0.8)}},IH=function(){let Z=LH();if(I(Z)){let U=Z,z={id:jH(),events:O(b(C),"events"),points:O(b(C),"points"),thumbnail:U,timestamp:Date.now()};return x(C,k0,"saved-states",l1,z)}},YH=function(Z){return x(C,v,"events",O(Z,"events"),"points",O(Z,"points")),x(z0,v,"selected",new Set([]),"selected-points",new Set([]))},MH=function(Z){return x(C,k0,"saved-states",function(U){return w0(sW(function(z){return oW(O(z,"id"),Z)},U))})},SH=function(Z){let U=Z,z=O(U,"id"),V=O(U,"thumbnail");return["div",{class:"relative group cursor-pointer","on-click":function(){return YH(Z)}},["img",{src:V,class:"w-full rounded border border-gray-600 hover:border-blue-400 transition-colors"}],["button",{class:"absolute -top-2 -right-2 w-5 h-5 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity","on-click":function(D){return D.stopPropagation(),MH(z)}},["svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"white","stroke-width":"3"},["path",{d:"M18 6L6 18M6 6l12 12"}]]]]},AH=function(){let Z=O(b(C),"saved-states");return["div",{class:"w-64 bg-gray-800 text-white p-4 flex flex-col h-full"},["h1",{class:"text-xl font-bold mb-4"},"Bitemporal Visualizer"],["div",{class:"mb-6 p-3 bg-gray-700 rounded-lg"},["div",{class:"text-xs text-gray-400 mb-1"},"Room"],["div",{class:"flex items-center gap-2"},["span",{class:"font-mono text-lg tracking-wider"},O(b(C),"room-code")],["button",{class:"px-2 py-1 text-xs bg-gray-600 hover:bg-gray-500 rounded cursor-pointer",title:"Copy room code","on-click":wH},"Copy"],["button",{class:"px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 rounded cursor-pointer","on-click":QH},"Join"]]],["div",{class:"flex flex-col gap-2 mb-4"},["label",{class:"flex items-center gap-2 cursor-pointer"},["input",{type:"checkbox",checked:O(b(C),"show-grid"),"on-change":XH,class:"w-4 h-4"}],["span","Grid"]],["label",{class:"flex items-center gap-2 cursor-pointer"},["input",{type:"checkbox",checked:O(b(C),"auto-select"),"on-change":OH,class:"w-4 h-4"}],["span","Auto-select after draw"]]],["div",{class:"h-px bg-gray-600 my-4"}],["div",{class:"mb-4"},["div",{class:"text-xs text-gray-400 mb-2"},"Room Settings"],["div",{class:"flex flex-col gap-2"},["label",{class:"flex items-center gap-2 cursor-pointer"},["input",{type:"checkbox",checked:O(b(C),"snap-to-grid"),"on-change":GH,class:"w-4 h-4"}],["span","Snap to grid"],["svg",{class:"w-3.5 h-3.5 text-gray-400",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2",title:"Synced to room"},["path",{d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"}]]],["label",{class:"flex items-center gap-2 cursor-pointer"},["input",{type:"checkbox",checked:O(b(C),"show-ticks"),"on-change":JH,class:"w-4 h-4"}],["span","Axis ticks"],["svg",{class:"w-3.5 h-3.5 text-gray-400",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2",title:"Synced to room"},["path",{d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"}]]]]],["div",{class:"h-px bg-gray-600 my-4"}],["div",{class:"mb-4"},["div",{class:"text-xs text-gray-400 mb-2"},"DML Export"],["div",{class:"flex flex-col gap-2"},["div",{class:"flex items-center gap-2"},["label",{class:"text-sm text-gray-300 w-12"},"Start"],["input",{type:"date",value:O(b(C),"dml-start-date"),"on-change":function(U){return x(C,v,"dml-start-date",U.target.value)},class:"flex-1 px-2 py-1 text-sm bg-gray-700 border border-gray-600 rounded text-white"}]],["div",{class:"flex items-center gap-2"},["label",{class:"text-sm text-gray-300 w-12"},"End"],["input",{type:"date",value:O(b(C),"dml-end-date"),"on-change":function(U){return x(C,v,"dml-end-date",U.target.value)},class:"flex-1 px-2 py-1 text-sm bg-gray-700 border border-gray-600 rounded text-white"}]],["button",{class:"w-full px-3 py-1.5 text-sm bg-blue-500 hover:bg-blue-600 rounded cursor-pointer mt-1","on-click":KH},"Copy DML"]]],["div",{class:"h-px bg-gray-600 my-4"}],["div",{class:"flex-1 flex flex-col min-h-0"},["div",{class:"flex items-center justify-between mb-3"},["span",{class:"text-sm font-medium text-gray-300"},"Saved States"],["button",{class:"px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 rounded cursor-pointer","on-click":IH},"Save"]],["div",{class:"flex-1 overflow-y-auto"},I(M0(Z))?["div",{class:"grid grid-cols-2 gap-2"},T0(function*(){for(let U of e(Z)){let z=U;yield["div",{key:O(z,"id")},[SH,z]]}})]:["div",{class:"text-xs text-gray-500 text-center py-4"},"No saved states yet"]]]]},RH=function(){return["div",{class:"flex-1 bg-gray-100 p-4"},["div",{class:"relative w-full h-full bg-white rounded-lg shadow-md overflow-hidden"},["div",{class:"absolute inset-0 left-5"},["canvas",{"on-render":$H,class:"w-full h-full"}]],[NH]]]},CH=function(){return["div",{class:"h-screen flex"},[AH],[RH],[ZH],[WH],[DH]]},xq=function(){return RZ(document.getElementById("app"),[CH])};D1(C,"app.app/render",function(Z,U,z,V){return xq()});D1(P1,"app.app/render-ably",function(Z,U,z,V){return xq()});D1(h1,"app.app/render-context-menu",function(Z,U,z,V){return xq()});var TH=function(){return c$(l$,function(Z){return x(C,v,"global-count",e0(Z))})},PH=function(){let Z=O(b(C),"room-code");return c$(Jq(Z),function(U){return x(C,v,"room-count",e0(U))})},nZ=function(){if(I(O(b(C),"syncing")))return null;else{let Z=O(b(C),"room-code"),U=O(b(C),"events"),z=O(b(C),"points"),V=O(b(C),"snap-to-grid"),D=O(b(C),"show-ticks");return x$(Jq(Z),"state-sync",{events:U,points:z,snapToGrid:V,showTicks:D,from:Xq})}},hH=function(){let Z=O(b(C),"room-code");return x$(Jq(Z),"state-request",{from:Xq})},EH=function(Z){let{name:U,data:z}=Z,V=z.from;if(I(u0(V,Xq)))switch(U){case"state-request":return nZ();case"state-sync":let{events:w,points:L,snapToGrid:A,showTicks:k}=z;if(x(C,v,"syncing",!0),x(C,v,"events",w0(w)),I(L))x(C,v,"points",w0(L));if(I(b$(A)))x(C,v,"snap-to-grid",A);if(I(b$(k)))x(C,v,"show-ticks",k);return x(C,v,"syncing",!1)}},_Z=function(Z){let U=O(b(C),"room-code"),z=Jq(U),V=Jq(Z);if(I(U))N1(z).presence.leave();return x(C,v,"room-code",Z,"room-count",0),dq(V),d$(V,PH),kZ(V,EH),setTimeout(hH,500)};D1(C,"app.app/sync-to-room",function(Z,U,z,V){if(I((()=>{let D=W1(O(V,"syncing"));if(D){let w=u0(O(z,"events"),O(V,"events"));if(I(w))return w;else{let L=u0(O(z,"points"),O(V,"points"));if(I(L))return L;else{let A=u0(O(z,"snap-to-grid"),O(V,"snap-to-grid"));if(I(A))return A;else return u0(O(z,"show-ticks"),O(V,"show-ticks"))}}}else return D})()))return nZ()});var bH=function(){return xq(),bZ(g7),dq(l$),d$(l$,TH),_Z(O(b(C),"room-code"))};bH();export{PH as update_room_presence_count_BANG_,TH as update_global_presence_count_BANG_,NH as toolbar,GH as toggle_snap_to_grid_BANG_,JH as toggle_show_ticks_BANG_,XH as toggle_grid_BANG_,VH as toggle_events_open_BANG_,OH as toggle_auto_select_BANG_,C as state,_0 as snap_to_grid_value,AH as side_panel,o$ as set_tool_BANG_,gU as set_point_colors_BANG_,yU as set_event_colors_BANG_,mZ as set_all_colors_BANG_,SH as saved_state_card,m7 as save_to_storage_BANG_,c7 as save_saved_states_BANG_,IH as save_current_state_BANG_,Jq as room_channel_name,uU as rgb__GT_hex,iZ as rgb__GT_css,hH as request_state_BANG_,y0 as render_canvas_BANG_,xq as render,QH as prompt_join_room_BANG_,HH as preset_colors,ZH as presence_indicator,t7 as points_in_selection,a$ as point_hit_test,pZ as parse_date,a7 as on_mouse_up,r7 as on_mouse_move,_7 as on_mouse_down,qH as on_keydown,e7 as on_context_menu,_$ as normalized_to_date,RH as main_canvas,x7 as load_saved_states,YH as load_saved_state_BANG_,p7 as load_from_storage,_Z as join_room_BANG_,f7 as initial_saved_states,Gq as initial_persisted,bH as init_BANG_,s$ as hit_test,UH as hex__GT_rgb,EH as handle_room_message,d7 as get_persisted_state,jH as generate_state_id,v7 as generate_room_code,FH as generate_dml,n$ as format_date_for_dml,l7 as events_in_selection,BH as event_to_dml,z0 as drag_state,MH as delete_saved_state_BANG_,oZ as delete_points_BANG_,fZ as delete_events_BANG_,zH as delete_all_selected_BANG_,f$ as default_settings,xZ as default_new_event_color,i7 as default_events,s7 as create_event_from_drag_BANG_,wH as copy_room_code_BANG_,KH as copy_dml_BANG_,h1 as context_menu,WH as connection_pill,DH as color_menu,Hq as close_context_menu_BANG_,LH as capture_thumbnail,t$ as canvas_ref,$H as canvas_lifecycle,r$ as canvas__GT_normalized,nZ as broadcast_state_BANG_,CH as app,dZ as STORAGE_KEY,cZ as SAVED_STATES_KEY,vZ as POINT_RADIUS,O1 as PADDING,cq as MIN_DURATION,o7 as HANDLE_WIDTH,n7 as GRID_DIVISIONS,l$ as GLOBAL_CHANNEL,g7 as ABLY_API_KEY};

//# debugId=174AF4DA8A15CA7F64756E2164756E21
